define(["module","exports","three"],(function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],n=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw i}}return r}(e,t)||s(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||s(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){if(e){if("string"==typeof e)return u(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var d,m,p,h,b,y,v,g,w,S,C,U,T,A,_,L,x,E,P,R,M,B,F,k,G=(d=new URL(e.uri,document.baseURI).href,function(e){var t;e=e||{},t||(t=void 0!==e?e:{});var r,n={};for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);var a="./this.program";function i(e,t){throw t}var o="";document.currentScript&&(o=document.currentScript.src),d&&(o=d),o=0!==o.indexOf("blob:")?o.substr(0,o.lastIndexOf("/")+1):"";var s,u,c,f=t.print||console.log.bind(console),m=t.printErr||console.warn.bind(console);for(r in n)n.hasOwnProperty(r)&&(t[r]=n[r]);function p(e,t){return t||(t=16),Math.ceil(e/t)*t}n=null,t.thisProgram&&(a=t.thisProgram),t.quit&&(i=t.quit),t.wasmBinary&&(u=t.wasmBinary),t.noExitRuntime&&(c=t.noExitRuntime),"object"!==("undefined"==typeof WebAssembly?"undefined":l(WebAssembly))&&m("no native wasm support detected");var h,b=new WebAssembly.Table({initial:271,maximum:271,element:"anyfunc"}),y=!1;function v(e,t){e||H("Assertion failed: "+t)}function g(e){var r=t["_"+e];return v(r,"Cannot call unknown function "+e+", make sure it is exported"),r}function w(e,t,r,n){var a={string:function(e){var t=0;if(null!=e&&0!==e){var r=1+(e.length<<2);B(e,t=Gt(r),r)}return t},array:function(e){var t=Gt(e.length);return C.set(e,t),t}},i=g(e),o=[];if(e=0,n)for(var s=0;s<n.length;s++){var u=a[r[s]];u?(0===e&&(e=kt()),o[s]=u(n[s])):o[s]=n[s]}return r=function(e){return"string"===t?M(e):"boolean"===t?!!e:e}(r=i.apply(null,o)),0!==e&&Dt(e),r}var S,C,U,T,A,_,L,x,E,P="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function R(e,t,r){var n=t+r;for(r=t;e[r]&&!(r>=n);)++r;if(16<r-t&&e.subarray&&P)return P.decode(e.subarray(t,r));for(n="";t<r;){var a=e[t++];if(128&a){var i=63&e[t++];if(192==(224&a))n+=String.fromCharCode((31&a)<<6|i);else{var o=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|i<<6|o:(7&a)<<18|i<<12|o<<6|63&e[t++])?n+=String.fromCharCode(a):(a-=65536,n+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else n+=String.fromCharCode(a)}return n}function M(e){return e?R(U,e,void 0):""}function B(e,t,r){var n=U;if(0<r){r=t+r-1;for(var a=0;a<e.length;++a){var i=e.charCodeAt(a);if(55296<=i&&57343>=i&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++a)),127>=i){if(t>=r)break;n[t++]=i}else{if(2047>=i){if(t+1>=r)break;n[t++]=192|i>>6}else{if(65535>=i){if(t+2>=r)break;n[t++]=224|i>>12}else{if(t+3>=r)break;n[t++]=240|i>>18,n[t++]=128|i>>12&63}n[t++]=128|i>>6&63}n[t++]=128|63&i}}n[t]=0}}function F(e){return 0<e%65536&&(e+=65536-e%65536),e}function k(e){S=e,t.HEAP8=C=new Int8Array(e),t.HEAP16=T=new Int16Array(e),t.HEAP32=_=new Int32Array(e),t.HEAPU8=U=new Uint8Array(e),t.HEAPU16=A=new Uint16Array(e),t.HEAPU32=L=new Uint32Array(e),t.HEAPF32=x=new Float32Array(e),t.HEAPF64=E=new Float64Array(e)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var G=t.TOTAL_MEMORY||134217728;function D(e){for(;0<e.length;){var r=e.shift();if("function"==typeof r)r();else{var n=r.Ob;"number"==typeof n?void 0===r.Lb?t.dynCall_v(n):t.dynCall_vi(n,r.Lb):n(void 0===r.Lb?null:r.Lb)}}}(h=t.wasmMemory?t.wasmMemory:new WebAssembly.Memory({initial:G/65536}))&&(S=h.buffer),G=S.byteLength,k(S),_[6668]=5269712;var I=[],z=[],W=[],O=[],N=[];function j(){var e=t.preRun.shift();I.unshift(e)}var V=0,q=null;function H(e){throw t.onAbort&&t.onAbort(e),f(e),m(e),y=!0,new WebAssembly.RuntimeError("abort("+e+"). Build with -s ASSERTIONS=1 for more info.")}function X(){var e=Q;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):0===e.indexOf("data:application/octet-stream;base64,")}t.preloadedImages={},t.preloadedAudios={};var Q="umbra.wasm";if(!X()){var K=Q;Q=t.locateFile?t.locateFile(K,o):o+K}function J(){try{if(u)return new Uint8Array(u);throw"both async and sync fetching of the wasm failed"}catch(e){H(e)}}var Y={5793:function(){alert("Uploads are not supported.")},7093:function(){alert("Invalid http method.")},7313:function(e,r,n,a,i,o,s,u,l,c,f){return function(e,r,n,a,i,o,s,u,l,c,f){var d=M(e);r=M(r),o=M(o);var m=new XMLHttpRequest;m.open(r,d,!0),("GET"!=r||0!=o.length)&&(m.withCredentials=!0),m.responseType="arraybuffer";var p=function(){var e=gt;return gt++,e}();if(m.onload=function(){if(200==m.status){var r=new Uint8Array(m.response),o=t.URLsDownloaded;t.maxBytesDownloaded+=m.response.byteLength,o.has(e)||(o.add(e),t.minBytesDownloaded+=m.response.byteLength),c?r.length!=f?t.dynCall_viii(i,p,n,0):(U.set(r,c),t.dynCall_viiii(a,p,n,null,0)):(o=Mt(r.length),U.set(r,o),t.dynCall_viiii(a,p,n,o,r.length),Bt(o))}else t.dynCall_viii(i,p,n,m.status);delete vt[p]},m.onerror=function(){t.dynCall_viii(i,p,n,m.status),delete vt[p]},m.onabort=function(){delete vt[p]},0!=o.length&&m.setRequestHeader("Authorization","Basic "+btoa(o+":")),2<=(l=M(l).split("\n")).length)for(d=0;d<l.length;d+=2)m.setRequestHeader(l[d],l[d+1]);return"POST"==r?m.send(C.slice(s,s+u)):m.send(null),vt[p]=m,p}(e,r,n,a,i,o,s,u,l,c,f)}},Z=[];function $(e,t){O.unshift({Ob:e,Lb:t})}z.push({Ob:function(){Rt()}});var ee=[null,[],[]];function te(e,t){var r=ee[e];0===t||10===t?((1===e?f:m)(R(r,0)),r.length=0):r.push(t)}var re=0;function ne(){return _[(re+=4)-4>>2]}var ae={},ie={};function oe(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function se(e){return this.fromWireType(L[e>>2])}var ue={},le={},ce={};function fe(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return 48<=t&&57>=t?"_"+e:e}function de(e,t){return e=fe(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function me(e){var t=Error,r=de(e,(function(t){this.name=e,this.message=t,void 0!==(t=Error(t).stack)&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))}));return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},r}var pe=void 0;function he(e,t,r){function n(t){if((t=r(t)).length!==e.length)throw new pe("Mismatched type converter count");for(var n=0;n<e.length;++n)Se(e[n],t[n])}e.forEach((function(e){ce[e]=t}));var a=Array(t.length),i=[],o=0;t.forEach((function(e,t){le.hasOwnProperty(e)?a[t]=le[e]:(i.push(e),ue.hasOwnProperty(e)||(ue[e]=[]),ue[e].push((function(){a[t]=le[e],++o===i.length&&n(a)})))})),0===i.length&&n(a)}function be(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var ye=void 0;function ve(e){for(var t="";U[e];)t+=ye[U[e++]];return t}var ge=void 0;function we(e){throw new ge(e)}function Se(e,t,r){if(r=r||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var n=t.name;if(e||we('type "'+n+'" must have a positive integer typeid pointer'),le.hasOwnProperty(e)){if(r.Yb)return;we("Cannot register type '"+n+"' twice")}le[e]=t,delete ce[e],ue.hasOwnProperty(e)&&(t=ue[e],delete ue[e],t.forEach((function(e){e()})))}var Ce=[],Ue=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Te(e){4<e&&0==--Ue[e].Pb&&(Ue[e]=void 0,Ce.push(e))}function Ae(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Ce.length?Ce.pop():Ue.length;return Ue[t]={Pb:1,value:e},t}}function _e(e){if(null===e)return"null";var t=l(e);return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Le(e,t){switch(t){case 2:return function(e){return this.fromWireType(x[e>>2])};case 3:return function(e){return this.fromWireType(E[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function xe(e){var t=Function;if(!(t instanceof Function))throw new TypeError("new_ called with constructor type "+l(t)+" which is not a function");var r=de(t.name||"unknownFunctionName",(function(){}));return r.prototype=t.prototype,r=new r,(e=t.apply(r,e))instanceof Object?e:r}function Ee(e,r,n){t.hasOwnProperty(e)?((void 0===n||void 0!==t[e].Jb&&void 0!==t[e].Jb[n])&&we("Cannot register public name '"+e+"' twice"),function(e,r){var n=t;if(void 0===n[e].Jb){var a=n[e];n[e]=function(){return n[e].Jb.hasOwnProperty(arguments.length)||we("Function '"+r+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+n[e].Jb+")!"),n[e].Jb[arguments.length].apply(this,arguments)},n[e].Jb=[],n[e].Jb[a.Sb]=a}}(e,e),t.hasOwnProperty(n)&&we("Cannot register multiple overloads of a function with the same number of arguments ("+n+")!"),t[e].Jb[n]=r):(t[e]=r,void 0!==n&&(t[e].rc=n))}function Pe(e,r){if(e=ve(e),void 0!==t["FUNCTION_TABLE_"+e])var n=t["FUNCTION_TABLE_"+e][r];else if("undefined"!=typeof FUNCTION_TABLE)n=FUNCTION_TABLE[r];else{void 0===(n=t["dynCall_"+e])&&void 0===(n=t["dynCall_"+e.replace(/f/g,"d")])&&we("No dynCall invoker for signature: "+e);for(var a=[],i=1;i<e.length;++i)a.push("a"+i);i="return function dynCall_"+e+"_"+r+"("+a.join(", ")+") {\n",i+="    return dynCall(rawFunction"+(a.length?", ":"")+a.join(", ")+");\n",n=new Function("dynCall","rawFunction",i+"};\n")(n,r)}return"function"!=typeof n&&we("unknown function pointer with signature "+e+": "+r),n}var Re=void 0;function Me(e){var t=ve(e=Ft(e));return Bt(e),t}function Be(e,t,r){switch(t){case 0:return r?function(e){return C[e]}:function(e){return U[e]};case 1:return r?function(e){return T[e>>1]}:function(e){return A[e>>1]};case 2:return r?function(e){return _[e>>2]}:function(e){return L[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Fe(e){return e||we("Cannot use deleted val. handle = "+e),Ue[e].value}function ke(e,t){var r=le[e];return void 0===r&&we(t+" has unknown type "+Me(e)),r}var Ge={};function De(e){var t=Ge[e];return void 0===t?ve(e):t}var Ie=[];function ze(){H()}var We,Oe,Ne=null,je="",Ve=0,qe=null,He=0,Xe=0,Qe=0,Ke=0,Je=[],Ye={},Ze=!1,$e=!1,et=[];function tt(){function e(){$e=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas||document.msPointerLockElement===t.canvas}if(t.preloadPlugins||(t.preloadPlugins=[]),!pt){pt=!0;try{ht=!0}catch(e){ht=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}bt="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:ht?null:console.log("warning: no BlobBuilder"),yt="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,t.Rb||void 0!==yt||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),t.Rb=!0),t.preloadPlugins.push({canHandle:function(e){return!t.Rb&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,r,n,a){var i=null;if(ht)try{(i=new Blob([e],{type:ct(r)})).size!==e.length&&(i=new Blob([new Uint8Array(e).buffer],{type:ct(r)}))}catch(e){!function(e){s||(s={}),s[e]||(s[e]=1,m(e))}("Blob constructor present but fails: "+e+"; falling back to blob builder")}i||((i=new bt).append(new Uint8Array(e).buffer),i=i.getBlob());var o=yt.createObjectURL(i),u=new Image;u.onload=function(){v(u.complete,"Image "+r+" could not be decoded");var a=document.createElement("canvas");a.width=u.width,a.height=u.height,a.getContext("2d").drawImage(u,0,0),t.preloadedImages[r]=a,yt.revokeObjectURL(o),n&&n(e)},u.onerror=function(){console.log("Image "+o+" could not be decoded"),a&&a()},u.src=o}}),t.preloadPlugins.push({canHandle:function(e){return!t.qc&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,r,n,a){function i(a){s||(s=!0,t.preloadedAudios[r]=a,n&&n(e))}function o(){s||(s=!0,t.preloadedAudios[r]=new Audio,a&&a())}var s=!1;if(!ht)return o();try{var u=new Blob([e],{type:ct(r)})}catch(e){return o()}u=yt.createObjectURL(u);var l=new Audio;l.addEventListener("canplaythrough",(function(){i(l)}),!1),l.onerror=function(){if(!s){console.log("warning: browser could not fully decode audio "+r+", trying slower base64 approach");for(var t="",n=0,a=0,o=0;o<e.length;o++)for(n=n<<8|e[o],a+=8;6<=a;){var u=n>>a-6&63;a-=6,t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[u]}2==a?(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&n)<<4],t+="=="):4==a&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&n)<<2],t+="="),l.src="data:audio/x-"+r.substr(-3)+";base64,"+t,i(l)}},l.src=u,function(e){c=!0,setTimeout((function(){y||e()}),1e4)}((function(){i(l)}))}});var r=t.canvas;r&&(r.requestPointerLock=r.requestPointerLock||r.mozRequestPointerLock||r.webkitRequestPointerLock||r.msRequestPointerLock||function(){},r.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},r.exitPointerLock=r.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),t.elementPointerLock&&r.addEventListener("click",(function(e){!$e&&t.canvas.requestPointerLock&&(t.canvas.requestPointerLock(),e.preventDefault())}),!1))}}var rt=!1,nt=void 0,at=void 0;function it(e,r,n){function a(){Ze=!1;var e=i.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.exitFullscreen=st,nt&&i.requestPointerLock(),Ze=!0,at?("undefined"!=typeof SDL&&(_[SDL.screen>>2]=8388608|L[SDL.screen>>2]),mt(t.canvas),dt()):mt(i)):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),at?("undefined"!=typeof SDL&&(_[SDL.screen>>2]=-8388609&L[SDL.screen>>2]),mt(t.canvas),dt()):mt(i)),t.onFullScreen&&t.onFullScreen(Ze),t.onFullscreen&&t.onFullscreen(Ze)}void 0===(nt=e)&&(nt=!0),void 0===(at=r)&&(at=!1);var i=t.canvas;rt||(rt=!0,document.addEventListener("fullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1));var o=document.createElement("div");i.parentNode.insertBefore(o,i),o.appendChild(i),o.requestFullscreen=o.requestFullscreen||o.mozRequestFullScreen||o.msRequestFullscreen||(o.webkitRequestFullscreen?function(){o.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(o.webkitRequestFullScreen?function(){o.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),n?o.requestFullscreen({tc:n}):o.requestFullscreen()}function ot(e,t,r){m("Browser.requestFullScreen() is deprecated. Please call Browser.requestFullscreen instead."),ot=function(e,t,r){it(e,t,r)},it(e,t,r)}function st(){return!!Ze&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)}var ut=0;function lt(e){if("function"==typeof requestAnimationFrame)requestAnimationFrame(e);else{var t=Date.now();if(0===ut)ut=t+1e3/60;else for(;t+2>=ut;)ut+=1e3/60;setTimeout(e,Math.max(ut-t,0))}}function ct(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]}var ft=[];function dt(){var e=t.canvas;ft.forEach((function(t){t(e.width,e.height)}))}function mt(e,r,n){r&&n?(e.fc=r,e.Xb=n):(r=e.fc,n=e.Xb);var a=r,i=n;if(t.forcedAspectRatio&&0<t.forcedAspectRatio&&(a/i<t.forcedAspectRatio?a=Math.round(i*t.forcedAspectRatio):i=Math.round(a/t.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var o=Math.min(screen.width/a,screen.height/i);a=Math.round(a*o),i=Math.round(i*o)}at?(e.width!=a&&(e.width=a),e.height!=i&&(e.height=i),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=r&&(e.width=r),e.height!=n&&(e.height=n),void 0!==e.style&&(a!=r||i!=n?(e.style.setProperty("width",a+"px","important"),e.style.setProperty("height",i+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))}var pt,ht,bt,yt,vt={},gt=0,wt={};function St(e,t){var r=wt[e];if(r)t(null,r);else{try{var n=function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"===("undefined"==typeof window?"undefined":l(window))&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),v(e,"IDBStore used, but indexedDB not supported"),e}().open(e,22)}catch(e){return void t(e)}n.onupgradeneeded=function(e){var t=e.target.result;e=e.target.transaction,t.objectStoreNames.contains("FILE_DATA")?e.objectStore("FILE_DATA"):t.createObjectStore("FILE_DATA")},n.onsuccess=function(){r=n.result,wt[e]=r,t(null,r)},n.onerror=function(e){t(this.error),e.preventDefault()}}}function Ct(e,t,r){St(e,(function(e,n){if(e)return r(e);(e=n.transaction(["FILE_DATA"],t)).onerror=function(e){r(this.error||"unknown error"),e.preventDefault()},e=e.objectStore("FILE_DATA"),r(null,e)}))}var Ut,Tt={};function At(){if(!Ut){var e,t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"===("undefined"==typeof navigator?"undefined":l(navigator))&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:a};for(e in Tt)t[e]=Tt[e];var r=[];for(e in t)r.push(e+"="+t[e]);Ut=r}return Ut}function _t(e){!c&&(y=!0,D(O),t.onExit)&&t.onExit(e),i(e,new Ot(e))}t._exit=_t,B("GMT",26736,4),pe=t.InternalError=me("InternalError");for(var Lt=Array(256),xt=0;256>xt;++xt)Lt[xt]=String.fromCharCode(xt);ye=Lt,ge=t.BindingError=me("BindingError"),t.count_emval_handles=function(){for(var e=0,t=5;t<Ue.length;++t)void 0!==Ue[t]&&++e;return e},t.get_first_emval=function(){for(var e=5;e<Ue.length;++e)if(void 0!==Ue[e])return Ue[e];return null},Re=t.UnboundTypeError=me("UnboundTypeError"),t.requestFullScreen=function(e,r,n){m("Module.requestFullScreen is deprecated. Please call Module.requestFullscreen instead."),t.requestFullScreen=t.requestFullscreen,ot(e,r,n)},t.requestFullscreen=function(e,t,r){it(e,t,r)},t.requestAnimationFrame=function(e){lt(e)},t.setCanvasSize=function(e,r,n){mt(t.canvas,e,r),n||dt()},t.pauseMainLoop=function(){Ne=null,Ve++},t.resumeMainLoop=function(){Ve++;var e=Xe,r=Qe,n=qe;qe=null,function(e){var r=He;c=!0,v(!qe,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),qe=e,He=r;var n=void 0!==r?function(){t.dynCall_vi(e,r)}:function(){t.dynCall_v(e)},a=Ve;Oe=function(){if(!y)if(0<Je.length){var e,r=Date.now(),i=Je.shift();i.Ob(i.Lb),console.log('main loop blocker "'+i.name+'" took '+(Date.now()-r)+" ms"),t.setStatus&&(r=t.statusMessage||"Please wait...",i=void 0,e=Ye.lc,i?i<e?t.setStatus(r+" ("+(e-i)+"/"+e+")"):t.setStatus(r):t.setStatus("")),a<Ve||setTimeout(Oe,0)}else if(!(a<Ve))if(Ke=Ke+1|0,1==Xe&&1<Qe&&0!=Ke%Qe)Ne();else{0==Xe&&(We=ze()),"timeout"===je&&t.Mb&&(m("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),je="");e:if(!(y||t.preMainLoop&&!1===t.preMainLoop())){try{n()}catch(e){if(e instanceof Ot)break e;throw e&&"object"===l(e)&&e.stack&&m("exception thrown: "+[e,e.stack]),e}t.postMainLoop&&t.postMainLoop()}a<Ve||("object"===("undefined"==typeof SDL?"undefined":l(SDL))&&SDL.audio&&SDL.audio.$b&&SDL.audio.$b(),Ne())}}}(n),function(e,t){if(Xe=e,Qe=t,qe)if(0==e)Ne=function(){var e=0|Math.max(0,We+t-ze());setTimeout(Oe,e)},je="timeout";else if(1==e)Ne=function(){lt(Oe)},je="rAF";else if(2==e){if("undefined"==typeof setImmediate){var r=[];addEventListener("message",(function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),r.shift()())}),!0),setImmediate=function(e){r.push(e),postMessage("setimmediate","*")}}Ne=function(){setImmediate(Oe)},je="immediate"}}(e,r),Ne()},t.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},t.createContext=function(e,r,n,a){return function(e,r,n,a){if(r&&t.Mb&&e==t.canvas)return t.Mb;var i;if(r){var o={antialias:!1,alpha:!1,oc:1};if(a)for(var s in a)o[s]=a[s];if("undefined"!=typeof GL&&(i=GL.ic(e,o)))var u=GL.getContext(i).gc}else u=e.getContext("2d");return u?(n&&(r||v("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),t.Mb=u,r&&GL.pc(i),t.sc=r,et.forEach((function(e){e()})),tt()),u):null}(e,r,n,a)},ze="undefined"!=typeof dateNow?dateNow:"object"===("undefined"==typeof performance?"undefined":l(performance))&&performance&&"function"==typeof performance.now?function(){return performance.now()}:Date.now,O.push((function(){var e=t._fflush;e&&e(0),ee[1].length&&te(1,10),ee[2].length&&te(2,10)}));var Et={W:function(){m("missing function: _ZN5Umbra13MiniSceneCopy7connectERK20UmbraSceneCopySource"),H(-1)},V:function(){m("missing function: _ZN5Umbra13MiniSceneCopy9getStatusEPf"),H(-1)},X:function(){m("missing function: _ZN5Umbra13MiniSceneCopyC1ERNS_11MiniRuntimeERK25UmbraSceneCopyDestinationPK20UmbraEnvironmentInfoRKN5Eigen6MatrixIfLi3ELi1ELi0ELi3ELi1EEEfi"),H(-1)},C:function(){return $.apply(null,arguments)},O:function(){},R:function(e,t){re=t;try{var r=M(ne()),n=ne();return ae.kc((void 0).stat,r,n)}catch(e){return H(e),-e.Nb}},w:function(e,t){return re=t,0},Q:function(e,t){re=t;try{var r=M(ne()),n=ne(),a=ne();return(void 0).open(r,n,a).mc}catch(e){return H(e),-e.Nb}},P:function(e,t){return re=t,0},s:function(){},A:function(e){var t=ie[e];delete ie[e];var r=t.ac,n=t.bc,a=t.Qb;he([e],a.map((function(e){return e.Wb})).concat(a.map((function(e){return e.dc}))),(function(e){var i={};return a.forEach((function(t,r){var n=e[r],o=t.Ub,s=t.Vb,u=e[r+a.length],l=t.cc,c=t.ec;i[t.Tb]={read:function(e){return n.fromWireType(o(s,e))},write:function(e,t){var r=[];l(c,e,u.toWireType(r,t)),oe(r)}}})),[{name:t.name,fromWireType:function(e){var t,r={};for(t in i)r[t]=i[t].read(e);return n(e),r},toWireType:function(e,t){for(var a in i)if(!(a in t))throw new TypeError("Missing field");var o=r();for(a in i)i[a].write(o,t[a]);return null!==e&&e.push(n,o),o},argPackAdvance:8,readValueFromPointer:se,Kb:n}]}))},I:function(e,t,r,n,a){var i=be(r);Se(e,{name:t=ve(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?n:a},argPackAdvance:8,readValueFromPointer:function(e){if(1===r)var n=C;else if(2===r)n=T;else{if(4!==r)throw new TypeError("Unknown boolean type size: "+t);n=_}return this.fromWireType(n[e>>i])},Kb:null})},k:function(e,r,n){e=ve(e),he([],[r],(function(r){return r=r[0],t[e]=r.fromWireType(n),[]}))},G:function(e,t){Se(e,{name:t=ve(t),fromWireType:function(e){var t=Ue[e].value;return Te(e),t},toWireType:function(e,t){return Ae(t)},argPackAdvance:8,readValueFromPointer:se,Kb:null})},u:function(e,t,r){r=be(r),Se(e,{name:t=ve(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+_e(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Le(t,r),Kb:null})},e:function(e,r,n,a,i,o){var s=function(e,t){for(var r=[],n=0;n<e;n++)r.push(_[(t>>2)+n]);return r}(r,n);e=ve(e),i=Pe(a,i),Ee(e,(function(){!function(e,t){var r=[],n={};throw t.forEach((function e(t){n[t]||le[t]||(ce[t]?ce[t].forEach(e):(r.push(t),n[t]=!0))})),new Re(e+": "+r.map(Me).join([", "]))}("Cannot call "+e+" due to unbound types",s)}),r-1),he([],s,(function(n){var a=e,s=e;n=[n[0],null].concat(n.slice(1));var u=i,l=n.length;2>l&&we("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var c=null!==n[1]&&!1,f=!1,d=1;d<n.length;++d)if(null!==n[d]&&void 0===n[d].Kb){f=!0;break}var m="void"!==n[0].name,p="",h="";for(d=0;d<l-2;++d)p+=(0!==d?", ":"")+"arg"+d,h+=(0!==d?", ":"")+"arg"+d+"Wired";s="return function "+fe(s)+"("+p+") {\nif (arguments.length !== "+(l-2)+") {\nthrowBindingError('function "+s+" called with ' + arguments.length + ' arguments, expected "+(l-2)+" args!');\n}\n",f&&(s+="var destructors = [];\n");var b=f?"destructors":"null";for(p="throwBindingError invoker fn runDestructors retType classParam".split(" "),u=[we,u,o,oe,n[0],n[1]],c&&(s+="var thisWired = classParam.toWireType("+b+", this);\n"),d=0;d<l-2;++d)s+="var arg"+d+"Wired = argType"+d+".toWireType("+b+", arg"+d+"); // "+n[d+2].name+"\n",p.push("argType"+d),u.push(n[d+2]);if(c&&(h="thisWired"+(0<h.length?", ":"")+h),s+=(m?"var rv = ":"")+"invoker(fn"+(0<h.length?", ":"")+h+");\n",f)s+="runDestructors(destructors);\n";else for(d=c?1:2;d<n.length;++d)l=1===d?"thisWired":"arg"+(d-2)+"Wired",null!==n[d].Kb&&(s+=l+"_dtor("+l+"); // "+n[d].name+"\n",p.push(l+"_dtor"),u.push(n[d].Kb));if(m&&(s+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),p.push(s+"}\n"),n=xe(p).apply(null,u),d=r-1,!t.hasOwnProperty(a))throw new pe("Replacing nonexistant public symbol");return void 0!==t[a].Jb&&void 0!==d?t[a].Jb[d]=n:(t[a]=n,t[a].Sb=d),[]}))},o:function(e,t,r,n,a){function i(e){return e}t=ve(t),-1===a&&(a=4294967295);var o=be(r);if(0===n){var s=32-8*r;i=function(e){return e<<s>>>s}}var u=-1!=t.indexOf("unsigned");Se(e,{name:t,fromWireType:i,toWireType:function(e,r){if("number"!=typeof r&&"boolean"!=typeof r)throw new TypeError('Cannot convert "'+_e(r)+'" to '+this.name);if(r<n||r>a)throw new TypeError('Passing a number "'+_e(r)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+n+", "+a+"]!");return u?r>>>0:0|r},argPackAdvance:8,readValueFromPointer:Be(t,o,0!==n),Kb:null})},m:function(e,t,r){function n(e){e>>=2;var t=L;return new a(t.buffer,t[e+1],t[e])}var a=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];Se(e,{name:r=ve(r),fromWireType:n,argPackAdvance:8,readValueFromPointer:n},{Yb:!0})},v:function(e,t){var r="std::string"===(t=ve(t));Se(e,{name:t,fromWireType:function(e){var t=L[e>>2];if(r){var n=U[e+4+t],a=0;0!=n&&(a=n,U[e+4+t]=0);var i=e+4;for(n=0;n<=t;++n){var o=e+4+n;if(0==U[o]){if(i=M(i),void 0===s)var s=i;else s+=String.fromCharCode(0),s+=i;i=o+1}}0!=a&&(U[e+4+t]=a)}else{for(s=Array(t),n=0;n<t;++n)s[n]=String.fromCharCode(U[e+4+n]);s=s.join("")}return Bt(e),s},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n="string"==typeof t;n||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||we("Cannot pass non-string to std::string");var a=(r&&n?function(){for(var e=0,r=0;r<t.length;++r){var n=t.charCodeAt(r);55296<=n&&57343>=n&&(n=65536+((1023&n)<<10)|1023&t.charCodeAt(++r)),127>=n?++e:e=2047>=n?e+2:65535>=n?e+3:e+4}return e}:function(){return t.length})(),i=Mt(4+a+1);if(L[i>>2]=a,r&&n)B(t,i+4,a+1);else if(n)for(n=0;n<a;++n){var o=t.charCodeAt(n);255<o&&(Bt(i),we("String has UTF-16 code units that do not fit in 8 bits")),U[i+4+n]=o}else for(n=0;n<a;++n)U[i+4+n]=t[n];return null!==e&&e.push(Bt,i),i},argPackAdvance:8,readValueFromPointer:se,Kb:function(e){Bt(e)}})},H:function(e,t,r){if(r=ve(r),2===t)var n=function(){return A},a=1;else 4===t&&(n=function(){return L},a=2);Se(e,{name:r,fromWireType:function(e){for(var t=n(),r=L[e>>2],i=Array(r),o=e+4>>a,s=0;s<r;++s)i[s]=String.fromCharCode(t[o+s]);return Bt(e),i.join("")},toWireType:function(e,r){var i=r.length,o=Mt(4+i*t),s=n();L[o>>2]=i;for(var u=o+4>>a,l=0;l<i;++l)s[u+l]=r.charCodeAt(l);return null!==e&&e.push(Bt,o),o},argPackAdvance:8,readValueFromPointer:se,Kb:function(e){Bt(e)}})},B:function(e,t,r,n,a,i){ie[e]={name:ve(t),ac:Pe(r,n),bc:Pe(a,i),Qb:[]}},q:function(e,t,r,n,a,i,o,s,u,l){ie[e].Qb.push({Tb:ve(t),Wb:r,Ub:Pe(n,a),Vb:i,dc:o,cc:Pe(s,u),ec:l})},J:function(e,t){Se(e,{Zb:!0,name:t=ve(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},h:function(e,t,r){e=Fe(e),t=ke(t,"emval::as");var n=[],a=Ae(n);return _[r>>2]=a,t.toWireType(n,e)},i:function(e,t,r,n){(e=Ie[e])(t=Fe(t),r=De(r),null,n)},a:Te,j:function(e,t){for(var r=(t=function(e,t){for(var r=Array(e),n=0;n<e;++n)r[n]=ke(_[(t>>2)+n],"parameter "+n);return r}(e,t))[0],n=r.name+"_$"+t.slice(1).map((function(e){return e.name})).join("_")+"$",a=["retType"],i=[r],o="",s=0;s<e-1;++s)o+=(0!==s?", ":"")+"arg"+s,a.push("argType"+s),i.push(t[1+s]);n="return function "+fe("methodCaller_"+n)+"(handle, name, destructors, args) {\n";var u=0;for(s=0;s<e-1;++s)n+="    var arg"+s+" = argType"+s+".readValueFromPointer(args"+(u?"+"+u:"")+");\n",u+=t[s+1].argPackAdvance;for(n+="    var rv = handle[name]("+o+");\n",s=0;s<e-1;++s)t[s+1].deleteObject&&(n+="    argType"+s+".deleteObject(arg"+s+");\n");return r.Zb||(n+="    return retType.toWireType(destructors, rv);\n"),a.push(n+"};\n"),function(e){var t=Ie.length;return Ie.push(e),t}(e=xe(a).apply(null,i))},f:function(e,t){return Ae((e=Fe(e))[t=Fe(t)])},p:function(e){4<e&&(Ue[e].Pb+=1)},n:function(){return Ae([])},b:function(e){return Ae(De(e))},l:function(){return Ae({})},g:function(e){oe(Ue[e].value),Te(e)},d:function(e,t,r){e=Fe(e),t=Fe(t),r=Fe(r),e[t]=r},c:function(e,t){return Ae(e=(e=ke(e,"_emval_take_value")).readValueFromPointer(t))},S:function(){H()},r:function(e,t,r){e:for(Z.length=0;;){var n=U[t++];if(!n){t=Z;break e}100===n||102===n?(r=p(r,8),Z.push(E[r>>3]),r+=8):105===n&&(r=p(r,4),Z.push(_[r>>2]),r+=4)}return Y[e].apply(null,t)},z:function(e){(e=vt[e])&&e.abort()},Z:ze,y:function(e,t,r,n,a){!function(e,t,r){Ct(e,"readonly",(function(e,n){if(e)return r(e);(e=n.get(t)).onsuccess=function(e){return(e=e.target.result)?r(null,e):r("file "+t+" not found")},e.onerror=function(e){r(e)}}))}(M(e),M(t),(function(e,t){e?a&&It(a,r):(e=Mt(t.length),U.set(t,e),Wt(n,r,e,t.length),Bt(e))}))},Y:function(e,t,r,n,a,i,o){!function(e,t,r,n){Ct(e,"readwrite",(function(e,a){if(e)return n(e);(e=a.put(r,t)).onsuccess=function(){n()},e.onerror=function(e){n(e)}}))}(M(e),M(t),new Uint8Array(U.subarray(r,r+n)),(function(e){e?o&&It(o,a):i&&It(i,a)}))},E:function(e,t,r){U.set(U.subarray(t,t+r),e)},F:function(e){if(2147418112<e)return!1;for(var t=Math.max(C.length,16777216);t<e;)t=536870912>=t?F(2*t):Math.min(F((3*t+2147483648)/4),2147418112);e:{try{h.grow(t-S.byteLength+65535>>16),k(h.buffer);var r=1;break e}catch(e){}r=void 0}return!!r},K:function(e,t){var r=0;return At().forEach((function(n,a){var i=t+r;for(a=_[e+4*a>>2]=i,i=0;i<n.length;++i)C[a++>>0]=n.charCodeAt(i);C[a>>0]=0,r+=n.length+1})),0},L:function(e,t){var r=At();_[e>>2]=r.length;var n=0;return r.forEach((function(e){n+=e.length+1})),_[t>>2]=n,0},_:_t,x:function(){return 0},N:function(e,t,r,n){try{var a=ae.nc(e),i=ae.jc(a,t,r);return _[n>>2]=i,0}catch(e){return H(e),e.Nb}},D:function(){return 0},M:function(e,t,r,n){try{for(var a=0,i=0;i<r;i++){for(var o=_[t+8*i>>2],s=_[t+(8*i+4)>>2],u=0;u<s;u++)te(e,U[o+u]);a+=s}return _[n>>2]=a,0}catch(e){return H(e),e.Nb}},T:function(e){return e=new Date(1e3*_[e>>2]),_[6672]=e.getUTCSeconds(),_[6673]=e.getUTCMinutes(),_[6674]=e.getUTCHours(),_[6675]=e.getUTCDate(),_[6676]=e.getUTCMonth(),_[6677]=e.getUTCFullYear()-1900,_[6678]=e.getUTCDay(),_[6681]=0,_[6680]=0,_[6679]=(e.getTime()-Date.UTC(e.getUTCFullYear(),0,1,0,0,0,0))/864e5|0,_[6682]=26736,26688},memory:h,t:function(){},table:b,U:function(e){var t=Date.now()/1e3|0;return e&&(_[e>>2]=t),t}},Pt=function(){function e(e){t.asm=e.exports,V--,t.monitorRunDependencies&&t.monitorRunDependencies(V),0==V&&q&&(e=q,q=null,e())}function r(t){e(t.instance)}function n(e){return(u||"function"!=typeof fetch?new Promise((function(e){e(J())})):fetch(Q,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+Q+"'";return e.arrayBuffer()})).catch((function(){return J()}))).then((function(e){return WebAssembly.instantiate(e,a)})).then(e,(function(e){m("failed to asynchronously prepare wasm: "+e),H(e)}))}var a={env:Et,wasi_unstable:Et};if(V++,t.monitorRunDependencies&&t.monitorRunDependencies(V),t.instantiateWasm)try{return t.instantiateWasm(a,e)}catch(e){return m("Module.instantiateWasm callback failed with error: "+e),!1}return function(){if(u||"function"!=typeof WebAssembly.instantiateStreaming||X()||"function"!=typeof fetch)return n(r);fetch(Q,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,a).then(r,(function(e){m("wasm streaming compile failed: "+e),m("falling back to ArrayBuffer instantiation"),n(r)}))}))}(),{}}();t.asm=Pt;var Rt=t.___wasm_call_ctors=function(){return t.asm.$.apply(null,arguments)};t._UmbraMeshLoadGetInfo=function(){return t.asm.aa.apply(null,arguments)},t._UmbraMeshLoadGetSerializedSize=function(){return t.asm.ba.apply(null,arguments)},t._UmbraMeshLoadSerialize=function(){return t.asm.ca.apply(null,arguments)},t._UmbraAssetLoadGetType=function(){return t.asm.da.apply(null,arguments)},t._UmbraTextureLoadGetInfo=function(){return t.asm.ea.apply(null,arguments)},t._UmbraTextureLoadGetSerializedSize=function(){return t.asm.fa.apply(null,arguments)},t._UmbraTextureLoadSerialize=function(){return t.asm.ga.apply(null,arguments)},t._UmbraGeodeticToEcef=function(){return t.asm.ha.apply(null,arguments)},t._UmbraEcefToGeodetic=function(){return t.asm.ia.apply(null,arguments)},t._UmbraTextureGetMipmapLevelByteSize=function(){return t.asm.ja.apply(null,arguments)},t._UmbraTextureGetMipmapLevelOffset=function(){return t.asm.ka.apply(null,arguments)};var Mt=t._malloc=function(){return t.asm.la.apply(null,arguments)};t._UmbraMeshLoadFinishExternal=function(){return t.asm.ma.apply(null,arguments)};var Bt=t._free=function(){return t.asm.na.apply(null,arguments)};t._UmbraConfigInit=function(){return t.asm.oa.apply(null,arguments)},t._UmbraSetAllocator=function(){return t.asm.pa.apply(null,arguments)},t._UmbraSetLogger=function(){return t.asm.qa.apply(null,arguments)},t._UmbraSetHttp=function(){return t.asm.ra.apply(null,arguments)},t._UmbraClientCreate=function(){return t.asm.sa.apply(null,arguments)},t._UmbraClientDestroy=function(){return t.asm.ta.apply(null,arguments)},t._UmbraGetLibraryInfo=function(){return t.asm.ua.apply(null,arguments)},t._UmbraEnvironmentInfoDefaults=function(){return t.asm.va.apply(null,arguments)},t._UmbraRuntimeCreate=function(){return t.asm.wa.apply(null,arguments)},t._UmbraRuntimeDestroy=function(){return t.asm.xa.apply(null,arguments)},t._UmbraRuntimeUpdate=function(){return t.asm.ya.apply(null,arguments)},t._UmbraRuntimeGetStreamingState=function(){return t.asm.za.apply(null,arguments)},t._UmbraRuntimeNextAssetUnload=function(){return t.asm.Aa.apply(null,arguments)},t._UmbraAssetUnloadFinish=function(){return t.asm.Ba.apply(null,arguments)},t._UmbraAssetUnloadGetType=function(){return t.asm.Ca.apply(null,arguments)},t._UmbraAssetUnloadGetUserPointer=function(){return t.asm.Da.apply(null,arguments)},t._UmbraRuntimeNextAssetLoad=function(){return t.asm.Ea.apply(null,arguments)},t._UmbraAssetLoadPrepare=function(){return t.asm.Fa.apply(null,arguments)},t._UmbraAssetLoadFinish=function(){return t.asm.Ga.apply(null,arguments)},t._UmbraAssetLoadAbortRequested=function(){return t.asm.Ha.apply(null,arguments)},t._UmbraVertexAttributeGetElementByteSize=function(){return t.asm.Ia.apply(null,arguments)},t._UmbraMeshLoadGetData=function(){return t.asm.Ja.apply(null,arguments)},t._UmbraMeshStreamSetBuffers=function(){return t.asm.Ka.apply(null,arguments)},t._UmbraMeshStreamDone=function(){return t.asm.La.apply(null,arguments)},t._UmbraMeshStreamNext=function(){return t.asm.Ma.apply(null,arguments)},t._UmbraMaterialLoadGetInfo=function(){return t.asm.Na.apply(null,arguments)},t._UmbraTextureLoadGetData=function(){return t.asm.Oa.apply(null,arguments)},t._UmbraTextureMetaDataLoadGetData=function(){return t.asm.Pa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationCount=function(){return t.asm.Qa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassification=function(){return t.asm.Ra.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationAmount=function(){return t.asm.Sa.apply(null,arguments)},t._UmbraSceneCreate=function(){return t.asm.Ta.apply(null,arguments)},t._UmbraSceneCreatePublic=function(){return t.asm.Ua.apply(null,arguments)},t._UmbraSceneCreateLocal=function(){return t.asm.Va.apply(null,arguments)},t._UmbraSceneDestroy=function(){return t.asm.Wa.apply(null,arguments)},t._UmbraSceneGetConnectionStatus=function(){return t.asm.Xa.apply(null,arguments)},t._UmbraSceneGetInfo=function(){return t.asm.Ya.apply(null,arguments)},t._UmbraSceneSetTransform=function(){return t.asm.Za.apply(null,arguments)},t._UmbraSceneCopyCreate=function(){return t.asm._a.apply(null,arguments)},t._UmbraSceneCopyDestroy=function(){return t.asm.$a.apply(null,arguments)},t._UmbraSceneCopyGetStatus=function(){return t.asm.ab.apply(null,arguments)},t._UmbraSceneCopyGetError=function(){return t.asm.bb.apply(null,arguments)},t._UmbraViewCreate=function(){return t.asm.cb.apply(null,arguments)},t._UmbraViewDestroy=function(){return t.asm.db.apply(null,arguments)},t._UmbraViewUpdateRendering=function(){return t.asm.eb.apply(null,arguments)},t._UmbraViewUpdateFilter=function(){return t.asm.fb.apply(null,arguments)},t._UmbraViewGetCompleted=function(){return t.asm.gb.apply(null,arguments)},t._UmbraViewResetRenderables=function(){return t.asm.hb.apply(null,arguments)},t._UmbraViewNextRenderables=function(){return t.asm.ib.apply(null,arguments)},t._UmbraViewRayQuery=function(){return t.asm.jb.apply(null,arguments)},t._UmbraSendInternalMessage=function(){return t.asm.kb.apply(null,arguments)};var Ft=t.___getTypeName=function(){return t.asm.lb.apply(null,arguments)};t.___embind_register_native_and_builtin_types=function(){return t.asm.mb.apply(null,arguments)};var kt=t.stackSave=function(){return t.asm.nb.apply(null,arguments)},Gt=t.stackAlloc=function(){return t.asm.ob.apply(null,arguments)},Dt=t.stackRestore=function(){return t.asm.pb.apply(null,arguments)},It=t.dynCall_vi=function(){return t.asm.qb.apply(null,arguments)};t.dynCall_v=function(){return t.asm.rb.apply(null,arguments)},t.dynCall_iiiiiiiiii=function(){return t.asm.sb.apply(null,arguments)},t.dynCall_viiiiiiiii=function(){return t.asm.tb.apply(null,arguments)},t.dynCall_iiiii=function(){return t.asm.ub.apply(null,arguments)},t.dynCall_iiii=function(){return t.asm.vb.apply(null,arguments)},t.dynCall_iii=function(){return t.asm.wb.apply(null,arguments)},t.dynCall_ii=function(){return t.asm.xb.apply(null,arguments)},t.dynCall_vii=function(){return t.asm.yb.apply(null,arguments)},t.dynCall_iiiiii=function(){return t.asm.zb.apply(null,arguments)},t.dynCall_viiiii=function(){return t.asm.Ab.apply(null,arguments)},t.dynCall_iiiiiiii=function(){return t.asm.Bb.apply(null,arguments)},t.dynCall_viiiiiii=function(){return t.asm.Cb.apply(null,arguments)},t.dynCall_i=function(){return t.asm.Db.apply(null,arguments)};var zt,Wt=t.dynCall_viii=function(){return t.asm.Eb.apply(null,arguments)};function Ot(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function Nt(){function e(){if(!zt&&(zt=!0,!y)){if(D(z),D(W),t.onRuntimeInitialized&&t.onRuntimeInitialized(),t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;){var e=t.postRun.shift();N.unshift(e)}D(N)}}if(!(0<V)){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)j();D(I),0<V||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),e()}),1)):e())}}if(t.dynCall_viiii=function(){return t.asm.Fb.apply(null,arguments)},t.dynCall_jiji=function(){return t.asm.Gb.apply(null,arguments)},t.dynCall_iidiiii=function(){return t.asm.Hb.apply(null,arguments)},t.dynCall_viiiiii=function(){return t.asm.Ib.apply(null,arguments)},t.asm=Pt,t.cwrap=function(e,t,r,n){var a=(r=r||[]).every((function(e){return"number"===e}));return"string"!==t&&a&&!n?g(e):function(){return w(e,t,r,arguments)}},t.then=function(e){if(zt)e(t);else{var r=t.onRuntimeInitialized;t.onRuntimeInitialized=function(){r&&r(),e(t)}}return t},q=function e(){zt||Nt(),zt||(q=e)},t.run=Nt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();return Nt(),t.maxBytesDownloaded=0,t.minBytesDownloaded=0,t.URLsDownloaded=new Set([]),t.wgetRequests=vt,e});!function(e){e[e.ColumnMajor=0]="ColumnMajor",e[e.RowMajor=1]="RowMajor",e[e.Count=2]="Count"}(m||(m={})),function(e){e[e.Diffuse=0]="Diffuse",e[e.Normal=1]="Normal",e[e.Specular=2]="Specular",e[e.MetaIndex=3]="MetaIndex",e[e.Count=4]="Count"}(p||(p={})),function(e){e[e.RGBA32=0]="RGBA32",e[e.RGB24=1]="RGB24",e[e.BC1=2]="BC1",e[e.BC3=3]="BC3",e[e.BC4=4]="BC4",e[e.BC5=5]="BC5",e[e.ETC1_RGB=6]="ETC1_RGB",e[e.RGBA_FLOAT32=7]="RGBA_FLOAT32",e[e.UNC1=8]="UNC1",e[e.JPEG=9]="JPEG",e[e.PNG=10]="PNG",e[e.BMP=11]="BMP",e[e.PSD=12]="PSD",e[e.TGA=13]="TGA",e[e.GIF=14]="GIF",e[e.HDR=15]="HDR",e[e.PIC=16]="PIC",e[e.PNM=17]="PNM",e[e.ASTC_4X4=18]="ASTC_4X4",e[e.ASTC_5X4=19]="ASTC_5X4",e[e.ASTC_5X5=20]="ASTC_5X5",e[e.ASTC_6X5=21]="ASTC_6X5",e[e.ASTC_6X6=22]="ASTC_6X6",e[e.ASTC_8X5=23]="ASTC_8X5",e[e.ASTC_8X6=24]="ASTC_8X6",e[e.ASTC_10X5=25]="ASTC_10X5",e[e.ASTC_10X6=26]="ASTC_10X6",e[e.ASTC_8X8=27]="ASTC_8X8",e[e.ASTC_10X8=28]="ASTC_10X8",e[e.ASTC_10X10=29]="ASTC_10X10",e[e.ASTC_12X10=30]="ASTC_12X10",e[e.ASTC_12X12=31]="ASTC_12X12",e[e.ARGB32=32]="ARGB32",e[e.R8=33]="R8",e[e.PVRTC1_RGB4=34]="PVRTC1_RGB4",e[e.PVRTC1_RGBA4=35]="PVRTC1_RGBA4",e[e.UINT8=36]="UINT8",e[e.UINT16=37]="UINT16",e[e.UINT32=38]="UINT32",e[e.RGB565=39]="RGB565",e[e.RG8=40]="RG8",e[e.RG16F=41]="RG16F",e[e.OPENEXR=42]="OPENEXR",e[e.RGBA_FLOAT16=43]="RGBA_FLOAT16",e[e.RGB_FLOAT16=44]="RGB_FLOAT16",e[e.RGB_FLOAT32=45]="RGB_FLOAT32",e[e.Count=46]="Count"}(h||(h={})),function(e){e[e.Linear=0]="Linear",e[e.SRGB=1]="SRGB",e[e.Count=2]="Count"}(b||(b={})),function(e){e[e.Position=0]="Position",e[e.TextureCoordinate=1]="TextureCoordinate",e[e.Normal=2]="Normal",e[e.Tangent=3]="Tangent",e[e.Count=4]="Count"}(y||(y={})),function(e){e[e.UncachedMemory=1]="UncachedMemory"}(v||(v={})),function(e){e[e.Debug=0]="Debug",e[e.Info=1]="Info",e[e.Warning=2]="Warning",e[e.Error=3]="Error",e[e.Count=4]="Count"}(g||(g={})),function(e){e[e.Inactive=0]="Inactive",e[e.Active=1]="Active",e[e.Complete=2]="Complete",e[e.Error=3]="Error",e[e.Count=4]="Count"}(w||(w={})),function(e){e[e.Found=0]="Found",e[e.Not_Found=1]="Not_Found",e[e.Transfer_Not_Complete=2]="Transfer_Not_Complete",e[e.Buffer_Too_Small=3]="Buffer_Too_Small",e[e.Count=4]="Count"}(S||(S={})),function(e){e[e.Get=0]="Get",e[e.Post=1]="Post",e[e.Put=2]="Put",e[e.Delete=3]="Delete",e[e.Count=4]="Count"}(C||(C={})),function(e){e[e.Version=0]="Version",e[e.Copyright=1]="Copyright",e[e.BuildTime=2]="BuildTime",e[e.BuildId=3]="BuildId",e[e.Count=4]="Count"}(U||(U={})),function(e){e[e.InvalidUserPointer=0]="InvalidUserPointer"}(T||(T={})),function(e){e[e.None=0]="None",e[e.BC1=1]="BC1",e[e.BC2=2]="BC2",e[e.BC3=4]="BC3",e[e.BC4=8]="BC4",e[e.BC5=16]="BC5",e[e.BC6H=32]="BC6H",e[e.BC7=64]="BC7",e[e.ASTC=128]="ASTC",e[e.ETC1=256]="ETC1",e[e.ETC2=512]="ETC2",e[e.EAC_R=1024]="EAC_R",e[e.EAC_RG=2048]="EAC_RG",e[e.PVRTC1=4096]="PVRTC1",e[e.PVRTC2=8192]="PVRTC2",e[e.ATC=16384]="ATC",e[e.HalfFloat=32768]="HalfFloat",e[e.Float=65536]="Float",e[e.All=2147483647]="All"}(A||(A={})),function(e){e[e.NeverUnload=1]="NeverUnload",e[e.ExclusiveRendering=2]="ExclusiveRendering",e[e.EnableRayQueries=4]="EnableRayQueries"}(_||(_={})),function(e){e[e.Connected=0]="Connected",e[e.Connecting=1]="Connecting",e[e.ConnectionError=2]="ConnectionError",e[e.Count=3]="Count"}(L||(L={})),function(e){e[e.ZeroToOne=0]="ZeroToOne",e[e.MinusOneToOne=1]="MinusOneToOne",e[e.Count=2]="Count"}(x||(x={})),function(e){e[e.Sphere=0]="Sphere",e[e.Cylinder=1]="Cylinder",e[e.None=2]="None",e[e.Count=3]="Count"}(E||(E={})),function(e){e[e.InProgress=0]="InProgress",e[e.Done=1]="Done",e[e.Error=2]="Error",e[e.Count=3]="Count"}(P||(P={})),function(e){e[e.File=0]="File",e[e.Directory=1]="Directory",e[e.Cloud=2]="Cloud",e[e.FormatObj=3]="FormatObj",e[e.Count=4]="Count"}(R||(R={})),function(e){e[e.Directory=0]="Directory",e[e.Cloud=1]="Cloud",e[e.Count=2]="Count"}(M||(M={})),function(e){e[e.Material=0]="Material",e[e.Texture=1]="Texture",e[e.Mesh=2]="Mesh",e[e.Count=3]="Count"}(B||(B={})),function(e){e[e.Failure=0]="Failure",e[e.OutOfMemory=1]="OutOfMemory",e[e.Aborted=2]="Aborted",e[e.Success=3]="Success",e[e.Count=4]="Count"}(F||(F={})),function(e){e[e.BackfaceCulling=1]="BackfaceCulling"}(k||(k={}));var D=Object.freeze({__proto__:null,get AssetType(){return B},get AssetLoadResult(){return F}});class I{constructor(e,t,r){var n=this;if(this.workers=[],this.infos=[],window.Worker)for(var a=function(e){var a=new Worker(t);a.onmessage=function(t){var a=n.infos[e].queue.shift(),i=a.userData,o=a.callback;r()?console.log("Runtime aborted"):t.data.finalResponse?o(t.data.data,i):console.error("emscripten_worker_respond_provisionally is not supported")},a.onerror=function(r){console.error("Worker call failed. Is worker's script URL \"".concat(t,'" correct? Message:'),r.message);var a=n.infos[e].queue.shift(),i=a.userData;(0,a.callback)(void 0,i)};n.workers.push(a),n.infos.push({queue:[]})},i=0;i<e;i++)a(i);else console.error("WebWorker support required")}callWorker(e,t,r,n,a){var i={funcName:t,callbackId:"placeholder",data:n};this.workers[e].postMessage(i,[n.buffer]),this.infos[e].queue.push({callback:r,userData:a})}findBestWorker(){for(var e=-1,t=1e9,r=0;r<this.workers.length;r++)this.infos[r].queue.length<t&&(e=r,t=this.infos[r].queue.length);return e}shortestQueueLength(){var e=1e9;for(var t of this.infos)e=Math.min(e,t.queue.length);return e}}var z=new Map([[Float32Array,"HEAPF32"],[Uint32Array,"HEAPU32"],[Uint16Array,"HEAPU16"],[Uint8Array,"HEAPU8"]]);function W(e){if(!Number.isInteger(e))throw new Error("Value was not integer: "+e.toString())}function O(e,t){var r={getPlatformFeatures:function(e){var t=0,r=new Set,n=!1,a=!1,i=new Map([]),o=[],s=e.getSupportedExtensions();for(var u of s){var l=u.replace(/^(.*)_WEBGL_/,"WEBGL_");i.set(l,u),o.push(l)}var c=new Map([["WEBGL_compressed_texture_s3tc",{mask:A.BC1|A.BC2|A.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_s3tc_srgb",{mask:A.BC1|A.BC2|A.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_rgtc",{mask:A.BC4|A.BC5,names:["bc4","bc5"]}],["WEBGL_compressed_texture_pvrtc",{mask:A.PVRTC1,names:["pvrtc1_rgb4","pvrtc1_rgba4"]}],["WEBGL_compressed_texture_etc1",{mask:A.ETC1,names:["etc1_rgb"]}],["WEBGL_compressed_texture_astc",{mask:A.ASTC,names:["astc_4x4"]}]]);for(var d of c.keys())if(o.includes(d)){e.getExtension(i.get(d));var m=c.get(d);t|=m.mask,m.names.forEach((function(e){return r.add(e)}))}return o.includes("WEBGL_compressed_texture_s3tc_srgb")&&(n=!0),o.includes("EXT_sRGB")&&(e.getExtension(i.get("EXT_sRGB")),n=!0),o.includes("OES_texture_half_float")&&(e.getExtension(i.get("OES_texture_half_float")),a=!0),{textureSupportMask:t,formats:f(r),srgb:n,halfFloat:a}}};return r.nativeModule=e,r.nativeModule.umbraLibraryConfig=t,r.createRuntime=function(e){class t{constructor(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Uint8Array;if(W(t/r.BYTES_PER_ELEMENT),0===t)throw new Error("Buffer size was zero");if(this.ptr=e.umbraAlloc(t),0===this.ptr)throw new Error("Allocation of ".concat(t," bytes failed."));this.size=t,this.type=r}destroy(){e.umbraFree(this.ptr),this.ptr=0,this.size=0}ensureSize(t){if(this.size<t){if(this.destroy(),this.ptr=e.umbraAlloc(t),0===this.ptr)throw new Error("Buffer growth to ".concat(t," bytes failed."));this.size=t}}floats(){return new Float32Array(e.HEAPF32.buffer,this.ptr,this.size/4)}bytes(){return new Uint8Array(e.HEAPU8.buffer,this.ptr,this.size)}}class r{constructor(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Float32Array;this.ptr=e,this.size=t,this.type=r,this.heapName=z.get(r)}getArray(){return new this.type(e[this.heapName].buffer,this.ptr,this.size/this.type.BYTES_PER_ELEMENT)}}var n=e.getRenderableMemberOffsets();function a(e,t){for(var r=0;r<16;r++)e[r]=t[r]}class i{constructor(){this.configPtr=e.umbraAlloc(e.CONFIG_SIZE),e.configInit(this.configPtr),this.ptr=e.clientCreate("UmbraJS",this.configPtr)}destroy(){e.clientDestroy(this.ptr),e.umbraFree(this.configPtr),this.ptr=0}}class o{constructor(r){this.matrixBuffer=new t(64,Float32Array),this.infoBuffer=new t(e.sceneInfoSize),this.ptr=r}destroy(){this.matrixBuffer.destroy(),this.infoBuffer.destroy(),e.sceneDestroy(this.ptr),this.ptr=0}connectionStatus(){return e.sceneGetConnectionStatus(this.ptr)}getInfo(){return e.sceneGetInfo(this.ptr,this.infoBuffer.ptr),e.deserializeSceneInfo(this.infoBuffer.ptr)}isConnected(){return this.connectionStatus()===L.Connected}setTransform(t){if(!Array.isArray(t))throw new TypeError("Matrix should be an array");if(16!==t.length)throw new TypeError("Matrix should be of size 4x4");a(this.matrixBuffer.floats(),t),e.sceneSetTransform(this.ptr,this.matrixBuffer.ptr)}}class s{constructor(e,r){this.ptr=e,this.matrixBuffer=new t(64,Float32Array),this.vectorBuffer=new t(16,Float32Array),this.lightBuffer=new t(384,Float32Array),this.temp=void 0,this.runtimeAssets=r}destroy(){this.matrixBuffer.destroy(),this.vectorBuffer.destroy(),this.lightBuffer.destroy(),this.temp&&this.temp.destroy(),e.viewDestroy(this.ptr),this.ptr=0}setCamera(t,r,n){var i,o,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:x.MinusOneToOne,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:m.ColumnMajor;if(!Array.isArray(t))throw new TypeError("Camera matrix should be an array");if(!Array.isArray(r))throw new TypeError("Position should be an array");if("number"!=typeof n)throw new TypeError("Quality should be a number");if(16!==t.length)throw new TypeError("WorldToClip matrix should be of size 4x4");if(3!==r.length)throw new TypeError("Position vector should be of length 3");if(a(this.matrixBuffer.floats(),t),i=this.vectorBuffer.floats(),o=r,i[0]=o[0],i[1]=o[1],i[2]=o[2],s){if(s.length>32)throw new Error("Too many lights given");for(var c=this.lightBuffer.floats(),f=0;f<s.length;f++)c[3*f+0]=s[f][0],c[3*f+1]=s[f][1],c[3*f+2]=s[f][2]}e.viewUpdateRendering(this.ptr,this.matrixBuffer.ptr,this.vectorBuffer.ptr,u,l,n,this.lightBuffer.ptr,s.length)}getVisible(r){W(r);var a=r*e.renderableSize;(!this.temp||this.temp.size<a)&&(this.temp&&this.temp.destroy(),this.temp=new t(a));var i=this.temp,o=e.renderableSize/4,s=a/4;W(o),W(s);for(var u=function(e,t,r,n){return W(n/4),new e(t.buffer,r+n,s-n/4)},l=u(Uint32Array,e.HEAPU32,i.ptr,n.mesh),c=u(Int32Array,e.HEAP32,i.ptr,n.lodLevel),f=u(Uint32Array,e.HEAPU32,i.ptr,n.visibilityMask),d=u(Uint32Array,e.HEAPU32,i.ptr,n.scene),m=e.viewNextRenderables(this.ptr,i.ptr,r),p=[],h=0;h<m;h++){var b=l[o*h],y=c[o*h],v=f[o*h],g=d[o*h];p.push({id:b,mesh:this.runtimeAssets.get(b),lod:y,mask:v,scenePtr:g})}return p}}class u{constructor(t,r){this.ptr=t,this.assetType=e.assetLoadGetType(this.ptr),this.type="Load"+B[this.assetType],this.data={},this.assetUserPointer=r}prepare(){e.assetLoadPrepare(this.ptr,this.assetUserPointer)}finish(t){e.assetLoadFinish(this.ptr,t)}}class f{constructor(t){this.ptr=t,this.assetType=e.assetUnloadGetType(this.ptr),this.type="Unload"+B[this.assetType],this.userPointer=e.assetUnloadGetUserPointer(this.ptr)}finish(){e.assetUnloadFinish(this.ptr)}}class d{constructor(r,n,a){var i=this,o=n.features,s=void 0===o?{textureSupportMask:0,formats:[],srgb:!1,halfFloat:!1}:o,u=n.flags,l=void 0===u?0:u,c=a.workerScriptURL,f=void 0===c?"UmbraPlayerWorker.js":c,d=a.numWorkers,m=void 0===d?2:d;this.assets=new Map,this.nextId=1,this.tempTextureBuffer=new t(1048576),this.tempStreamingStateBuffer=new t(e.streamingStateSize),this.stats={meshPipelineMemoryUse:0,texturePipelineMemoryUse:0},this.limits={maxPipelineMemoryUse:52428800},this.pendingAssetLoads=new Map;var p=A.ETC1|A.ASTC|A.PVRTC1|A.BC5,h=s.textureSupportMask;h&p||(h|=A.BC5|A.BC4),this.client=r;var b=e.serializeEnvironmentInfo({textureSupportFlags:h,localCacheDirectory:null,localCacheMaximumByteSize:0},0);this.ptr=e.runtimeCreate(r.ptr,b,l),e.umbraFree(b),this.platformFeatures=s;var y=Math.max(e.meshInfoSize,e.materialInfoSize,e.textureInfoSize,e.byteBufferSize);if(this.scratch=new t(y,Uint8Array),this.debug={textureFormatsInUse:new Set,platformFeatures:s},m<1)throw new Error("numWorkers should be at least 1, was ".concat(m));this.workerPool=new I(m,f,(function(){return 0===i.ptr}))}destroy(){this.tempTextureBuffer.destroy(),this.scratch.destroy(),e.runtimeDestroy(this.ptr),this.client.destroy(),this.ptr=0}createScenePublic(t){var r=e.sceneCreatePublic(this.ptr,t);if(r)return new o(r)}createSceneLocal(t){var r=e.sceneCreateLocal(this.ptr,t);if(r)return new o(r)}setHandlers(e){this.handlers=e}createView(){var t=e.viewCreate(this.ptr);return new s(t,this.assets)}update(){e.runtimeUpdate(this.ptr)}*getAssetUnloads(){for(var t=e.runtimeNextAssetUnload(this.ptr);0!==t;){var r=new f(t);r.data=this.assets.get(r.userPointer),yield r,t=e.runtimeNextAssetUnload(this.ptr)}}*launchAssetLoads(){for(var n=this,a=function*(){var a=e.runtimeNextAssetLoad(n.ptr);if(0===a)return{v:void 0};var i=new u(a,n.getNextUserPointer());if("LoadMaterial"===i.type){e.materialLoadGetInfo(i.ptr,n.scratch.ptr);var o=e.deserializeMaterialInfo(n.scratch.ptr),s=o.textures.filter((function(t){return t!==e.INVALID_USERPOINTER})),l=s.map((function(e){return n.pendingAssetLoads.get(e)})).map((function(e){return e.catch((function(e){return e}))})),f=Promise.all(l).then((function(e){for(var t of(s.forEach((function(e){return n.pendingAssetLoads.delete(e)})),e))if(t!==F.Success)return console.error("Texture promise failed: ",F[t]),i.finish(F.Failure),F.Failure;var r=s.map((function(e){return n.assets.get(e)}));i.data={transparent:o.transparent,textures:r};try{var a=n.handlers.LoadMaterial(i.data,i.assetUserPointer);return i.finish(a),a}catch(e){throw i.finish(F.Failure),e}}));i.prepare(),n.pendingAssetLoads.set(i.assetUserPointer,f),yield}else if("LoadTexture"===i.type){var d=n.scratch.ptr;e.textureLoadGetInfo(i.ptr,d);var m,p,b=e.deserializeTextureInfo(d),y=n.formatNeedsTranscoding(b.format);i.prepare();var v=new Promise((function(e,t){m=e,p=t})).catch((function(e){console.log("LoadTexture promise failed with status ",F[e])}));n.pendingAssetLoads.set(i.assetUserPointer,v);if(y){var g=e.textureLoadGetSerializedSize(i.ptr)+e.textureLoadDispatchHeaderSize,w=new t(g);e.convertAssetLoadToTextureDispatch(i.ptr,i.assetUserPointer,n.platformFeatures.textureSupportMask,n.platformFeatures.srgb,w.ptr,w.size);var S=2*g;n.stats.texturePipelineMemoryUse+=S,n.workerPool.callWorker(n.workerPool.findBestWorker(),"loadTexture",(function(t,a){var o,s=a.memoryUse;if(n.stats.texturePipelineMemoryUse-=s,void 0===t)return console.warn("Worker failed async texture load"),i.finish(F.Failure),void p(F.Failure);var u=e.umbraAlloc(t.byteLength);e.HEAP8.set(t,u);var l=e.deserializeTextureLoadResult(u).textureInfo,f=(c(o={},h.RGBA32,Uint8Array),c(o,h.RGB565,Uint16Array),c(o,h.RG8,Uint8Array),c(o,h.RG16F,Uint16Array),o),d=new r(u+e.textureLoadResultHeaderSize,l.dataByteSize,Uint8Array);d.type=f[l.format],i.data.info=l,i.data.buffer=d,t=void 0;var b=F.Failure;try{b=n.handlers.LoadTexture(i.data,i.assetUserPointer),n.debug.textureFormatsInUse.add(l.format)}catch(e){throw i.finish(F.Failure),e}i.finish(b),e.umbraFree(u),b===F.Success?m(b):p(b)}),new Uint8Array(w.bytes()),{load:i,memoryUse:S}),w.destroy()}else{var C=n.tempTextureBuffer;if(C.ensureSize(b.dataByteSize),e.serializeByteBuffer({ptr:C.ptr,byteSize:b.dataByteSize,flags:0},n.scratch.ptr),!e.textureLoadGetData(i.ptr,n.scratch.ptr))throw new Error("textureLoadGetData failed: ".concat(i.ptr,", ").concat(C.ptr,", ").concat(b.dataByteSize,"/").concat(C.size));var U=new r(C.ptr,b.dataByteSize,C.type);i.data={info:b,buffer:U};var T=F.Failure;try{T=n.handlers.LoadTexture(i.data,i.assetUserPointer)}catch(e){throw i.finish(F.Failure),e}i.finish(T),T===F.Success?m(T):p(T)}yield}else{if("LoadMesh"!==i.type)throw new Error("Job wasn't handled correctly");var A=new t(e.meshInfoSize);e.meshLoadGetInfo(i.ptr,A.ptr);var _=e.deserializeMeshInfo(A.ptr);A.destroy(),A=void 0,i.prepare();var L=e.meshLoadDispatchHeaderSize+e.meshLoadGetSerializedSize(i.ptr),x=new t(L);0!=(15&x.ptr)&&console.warn("buf.ofs wasn't aligned: ".concat(x.ptr));var E=e.convertAssetLoadToMeshDispatch(i.ptr,i.assetUserPointer,x.ptr,x.size),P=_.material,R=n.pendingAssetLoads.get(P);void 0===R&&console.error("Material UserPointer ".concat(P," didn't have a promise"));var M=x.size+E.byteSize+e.meshLoadResultHeaderSize;n.stats.meshPipelineMemoryUse+=M;var B=n.workerPool.findBestWorker();n.workerPool.callWorker(B,"loadMesh",(function(t,a){var i=a.load,o=(a.desc,a.textures,a.memoryUse);if(n.stats.meshPipelineMemoryUse-=o,void 0===t)return console.warn("Worker failed async mesh load"),void i.finish(F.Failure);var s=t.length*t.BYTES_PER_ELEMENT,u=e.umbraAlloc(s);e.HEAP8.set(t,u),t=void 0;var l=e.deserializeMeshLoadResult(u),c=!1;if(l.result!==F.Success&&(console.error("asset load failed with ".concat(F[l.result])),c=!0),l.assetLoad!==i.ptr&&(console.error("asset load ptr didn't match ".concat(l.assetLoad," vs ").concat(i.ptr)),c=!0),c)return console.error("MeshLoadResult handler failed"),i.finish(F.Failure),void e.umbraFree(u);var f=u+e.meshLoadResultHeaderSize,d=e.meshLoadResultBuildUmbraBuffers(u,f),m={position:Float32Array,uv:Float32Array,normal:Float32Array,tangent:Float32Array,index:2===d.index.elementByteSize?Uint16Array:Uint32Array},p={};for(var h of Object.keys(d)){var b={},y=d[h],v=y.elementCapacity*y.elementStride;b.data=new r(y.ptr,v,m[h]),b.desc=y,p[h]=b}R.then((function(t){var r=n.assets.get(P),a={buffers:p,material:r,bounds:[_.bounds.mn,_.bounds.mx]};i.data=a;var o=F.Failure;try{o=n.handlers.LoadMesh(i.data,i.assetUserPointer)}catch(e){throw i.finish(F.Failure),e}o===F.Success?e.meshLoadFinishExternalWithLoadResultHeader(i.ptr,u,f):(i.finish(o),console.error("MeshLoad failed with",F[o]))}),(function(e){console.error("Material promise was rejected",e)})).finally((function(){e.umbraFree(u)}))}),new Uint8Array(x.bytes()),{load:i,desc:E,memoryUse:M}),x.destroy(),yield}};;){var i=yield*a();if("object"===l(i))return i.v}}loadAssets(e){var t=performance.now();for(var r of this.getAssetUnloads()){var n=this.assets.get(r.userPointer);if(this.handlers[r.type](n,r.userPointer),r.finish(),performance.now()-t>e)break}for(var a of this.launchAssetLoads()){if(performance.now()-t>e)break;var i=this.stats.meshPipelineMemoryUse+this.stats.texturePipelineMemoryUse;if(this.workerPool.shortestQueueLength()>0&&i>=this.limits.maxPipelineMemoryUse)break}}getNextUserPointer(){var e=this.nextId;return this.nextId=this.nextId+1|0,0===this.nextId&&(this.nextId=1),e}addAsset(e,t){this.assets.set(e,t)}removeAsset(e){this.assets.has(e)&&this.assets.delete(e)}formatNeedsTranscoding(e){var t=this.platformFeatures.textureSupportMask;switch(e){case h.BC1:if(t&A.BC1)return!1;break;case h.BC3:if(t&A.BC3)return!1;break;case h.BC4:if(t&A.BC4)return!1;break;case h.BC5:if(t&A.BC5)return!1;break;default:return!1}return!0}getStreamingState(){return e.runtimeGetStreamingState(this.ptr,this.tempStreamingStateBuffer.ptr),e.deserializeStreamingState(this.tempStreamingStateBuffer.ptr)}getStreamingProgress(){var e=this.getStreamingState();return 0==e.numResidentTiles?0:e.numResidentTilesLoaded/e.numResidentTiles}}return{createRuntime:function(t){return new d(new i,t,e.umbraLibraryConfig)}}}(e).createRuntime,r.getStreamingInfo=function(){return{minBytesDownloaded:r.nativeModule.minBytesDownloaded,maxBytesDownloaded:r.nativeModule.maxBytesDownloaded}},r.getLibraryInfo=function(){return{version:e.getLibraryInfo(U.Version),copyright:e.getLibraryInfo(U.Copyright),buildTime:e.getLibraryInfo(U.BuildTime),buildID:e.getLibraryInfo(U.BuildId)}},r.abortDownloads=function(){Object.values(e.wgetRequests).forEach((function(e){e.abort()}))},r}var N,j=function(e){return e=Object.assign({wasmURL:""},e),new Promise((function(t,r){try{G({locateFile:function(t,r){return t.endsWith("umbra.wasm")&&""!==e.wasmURL?e.wasmURL:r+t}}).then((function(n){delete n.then,n.onAbort=function(e){r(e)},function(e){Object.assign(e,{configInit:e.cwrap("UmbraConfigInit",null,["number"]),clientCreate:e.cwrap("UmbraClientCreate","number",["string","number"]),clientDestroy:e.cwrap("UmbraClientDestroy",null,["number"]),getLibraryInfo:e.cwrap("UmbraGetLibraryInfo","string",["number"]),environmentInfoDefaults:e.cwrap("UmbraEnvironmentInfoDefaults",null,["number"]),runtimeCreate:e.cwrap("UmbraRuntimeCreate","number",["number","number","number"]),runtimeUpdate:e.cwrap("UmbraRuntimeUpdate",null,["number"]),runtimeGetStreamingState:e.cwrap("UmbraRuntimeGetStreamingState",null,["number","number"]),runtimeDestroy:e.cwrap("UmbraRuntimeDestroy",null,["number"]),sceneCreate:e.cwrap("UmbraSceneCreate","number",["number","string","string"]),sceneCreatePublic:e.cwrap("UmbraSceneCreatePublic","number",["number","string"]),sceneCreateLocal:e.cwrap("UmbraSceneCreateLocal","number",["number","string"]),sceneGetConnectionStatus:e.cwrap("UmbraSceneGetConnectionStatus","number",["number"]),sceneGetInfo:e.cwrap("UmbraSceneGetInfo","number",["number","number"]),sceneSetTransform:e.cwrap("UmbraSceneSetTransform",null,["number","number"]),sceneDestroy:e.cwrap("UmbraSceneDestroy",null,["number"]),viewCreate:e.cwrap("UmbraViewCreate","number",["number"]),viewUpdateRendering:e.cwrap("UmbraViewUpdateRendering",null,["number","number","number","number","number","number","number","number"]),viewUpdateFilter:e.cwrap("UmbraViewUpdateFilter",null,["number","number"]),viewGetCompleted:e.cwrap("UmbraViewGetCompleted","number",["number"]),viewNextRenderables:e.cwrap("UmbraViewNextRenderables","number",["number","number","number"]),viewResetRenderables:e.cwrap("UmbraViewResetRenderables",null,["number"]),viewDestroy:e.cwrap("UmbraViewDestroy",null,["number"]),viewRayQuery:e.cwrap("UmbraViewRayQuery","number",["number","number","number","number","number","number"]),sceneCopyCreate:e.cwrap("UmbraSceneCopyCreate","number",["number","number","number","number","number"]),sceneCopyGetStatus:e.cwrap("UmbraSceneCopyGetStatus","number",["number","number"]),sceneCopyGetError:e.cwrap("UmbraSceneCopyGetError","string",["number"]),sceneCopyDestroy:e.cwrap("UmbraSceneCopyDestroy",null,["number"]),vertexAttributeGetElementByteSize:e.cwrap("UmbraVertexAttributeGetElementByteSize","number",["number"]),runtimeNextAssetLoad:e.cwrap("UmbraRuntimeNextAssetLoad","number",["number"]),assetLoadGetType:e.cwrap("UmbraAssetLoadGetType","number",["number"]),assetLoadPrepare:e.cwrap("UmbraAssetLoadPrepare",null,["number","number"]),assetLoadAbortRequested:e.cwrap("UmbraAssetLoadAbortRequested","number",["number"]),assetLoadFinish:e.cwrap("UmbraAssetLoadFinish",null,["number","number"]),meshLoadFinishExternal:e.cwrap("UmbraMeshLoadFinishExternal",null,["number","number","number","number"]),meshLoadGetInfo:e.cwrap("UmbraMeshLoadGetInfo",null,["number","number"]),meshLoadGetData:e.cwrap("UmbraMeshLoadGetData","number",["number","number","number"]),meshStreamSetBuffers:e.cwrap("UmbraMeshStreamSetBuffers","number",["number","number","number"]),meshStreamNext:e.cwrap("UmbraMeshStreamNext","number",["number","number","number"]),meshStreamDone:e.cwrap("UmbraMeshStreamDone","number",["number"]),meshLoadGetSerializedSize:e.cwrap("UmbraMeshLoadGetSerializedSize","number",["number"]),textureGetMipmapLevelByteSize:e.cwrap("UmbraTextureGetMipmapLevelByteSize","number",["number","number"]),textureGetMipmapLevelOffset:e.cwrap("UmbraTextureGetMipmapLevelOffset","number",["number","number"]),textureLoadGetInfo:e.cwrap("UmbraTextureLoadGetInfo",null,["number","number"]),textureLoadGetData:e.cwrap("UmbraTextureLoadGetData","number",["number","number"]),textureLoadGetSerializedSize:e.cwrap("UmbraTextureLoadGetSerializedSize","number",["number"]),textureMetaDataLoadGetData:e.cwrap("UmbraTextureMetaDataLoadGetData","number",["number","number"]),textureMetaDataGetClassificationCount:e.cwrap("UmbraTextureMetaDataGetClassificationCount","number",["number","number"]),textureMetaDataGetClassification:e.cwrap("UmbraTextureMetaDataGetClassification","number",["number","number","number"]),textureMetaDataGetClassificationAmount:e.cwrap("UmbraTextureMetaDataGetClassificationAmount","number",["number","number","number"]),materialLoadGetInfo:e.cwrap("UmbraMaterialLoadGetInfo",null,["number","number"]),runtimeNextAssetUnload:e.cwrap("UmbraRuntimeNextAssetUnload","number",["number"]),assetUnloadGetType:e.cwrap("UmbraAssetUnloadGetType","number",["number"]),assetUnloadGetUserPointer:e.cwrap("UmbraAssetUnloadGetUserPointer","number",["number"]),assetUnloadFinish:e.cwrap("UmbraAssetUnloadFinish",null,["number"]),sendInternalMessage:e.cwrap("UmbraSendInternalMessage","number",["number","number"])})}(n),t(O(n,e))}))}catch(e){r(e)}}))};function V(e,t,r){return{format:e,type:t,compressed:r}}var q=(a(N={},h.RGB24,V(r.RGBFormat,r.UnsignedByteType,!1)),a(N,h.RGBA32,V(r.RGBAFormat,r.UnsignedByteType,!1)),a(N,h.RGB565,V(r.RGBFormat,r.UnsignedShort565Type,!1)),a(N,h.RG8,V(r.LuminanceAlphaFormat,r.UnsignedByteType,!1)),a(N,h.RG16F,V(r.LuminanceAlphaFormat,r.HalfFloatType,!1)),a(N,h.BC1,V(r.RGBA_S3TC_DXT1_Format,r.UnsignedByteType,!0)),a(N,h.BC3,V(r.RGBA_S3TC_DXT5_Format,r.UnsignedByteType,!0)),a(N,h.ETC1_RGB,V(r.RGB_ETC1_Format,r.UnsignedByteType,!0)),a(N,h.ASTC_4X4,V(r.RGBA_ASTC_4x4_Format,r.UnsignedByteType,!0)),a(N,h.PVRTC1_RGB4,V(r.RGB_PVRTC_4BPPV1_Format,r.UnsignedByteType,!0)),N);class H{constructor(e){this.flipTangent=void 0,this.defines=void 0,this.flipTangent=!1,this.defines="",e.indexOf("bc3")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC3\n"),e.indexOf("bc5")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC5\n"),e.indexOf("astc_4x4")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_ASTC\n")}process(e,t){var r=e.fragmentShader;this.flipTangent&&(r="#define UMBRA_FLIP_TANGENT\n"+r),r=(r=(r=(r=this.defines+r).replace("#include <normal_fragment_maps>","\n#ifdef USE_NORMALMAP\n#ifdef USE_TANGENT\n\nvec3 tangentToWorld2 = normal;\nvec3 tangentToWorld0 = normalize(tangent - tangentToWorld2 * dot(tangentToWorld2, tangent));\n\n#ifdef UMBRA_FLIP_TANGENT\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld0, tangentToWorld2));\n#else\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld2, tangentToWorld0));\n#endif\n\n#if defined(UMBRA_TEXTURE_SUPPORT_BC5) || defined(UMBRA_TEXTURE_SUPPORT_ASTC)\nnormal.xy = texture2D(normalMap, vUv).xy * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#elif defined(UMBRA_TEXTURE_SUPPORT_BC3)\nnormal.xy = texture2D(normalMap, vUv).yw * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#else\nnormal.xyz = texture2D(normalMap, vUv).xyz;\nnormal.xy *= 2.0;\nnormal.xy -= 1.0;\nnormal = normalize(normal);\n#endif\n\nnormal = tangentToWorld0 * normal.x + tangentToWorld1 * normal.y + tangentToWorld2 * normal.z;\nnormal = normalize(normal);\n#endif\n#endif\n\n")).replace("#include <metalnessmap_fragment>","\nfloat metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness = texture2D( metalnessMap, vUv );\nmetalnessFactor *= texelMetalness.r;\n#endif\n")).replace("#include <roughnessmap_fragment>","\nfloat roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness = texture2D( roughnessMap, vUv );\nfloat roughness = 1.0 - texelRoughness.g;\nroughnessFactor *= roughness;\n#endif\n"),e.fragmentShader=r}}class X{constructor(){this.usedList=[],this.freeList=[]}allocate(e,t){var r;if(this.freeList.length>0)if(void 0===t)r=this.freeList.pop();else for(var n=0;n<this.freeList.length;n++){var a=this.freeList[n];if(t(a)){r=a,this.freeList.splice(n,1);break}}return r||(r=e()),this.usedList.push(r),r}freeAll(e){for(var t=0;t<this.usedList.length;t++)e&&e(this.usedList[t]),this.freeList.push(this.usedList[t]);this.usedList.length=0}clear(){this.usedList.length=0,this.freeList.length=0}}class Q extends r.Object3D{set quality(e){console.error("UmbraScene.quality is not supported any more. Use camera.umbraQuality instead.")}constructor(e,t,n,a,i){var o,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0;super(),o=this,this.material=new r.MeshBasicMaterial,this.wireframe=!1,this.freeze=!1,this.onConnected=void 0,this.onConnectionError=void 0,this.onDisconnected=void 0,this.onConnectionChanged=void 0,this.onMeshChanged=void 0,this.isLOD=!0,this.autoUpdate=!0,this.name="UmbraScene",this.renderer=void 0,this.materialPool=new X,this.shaderPatcher=void 0,this.sharedState=void 0,this.stats={numVisible:0,numShadowCasters:0,numCachedMaterials:0,numAssets:0},this.diagnostics={missingNormals:{checked:!1,message:"Property umbraScene.opaqueMaterial has been deprecated. Use umbraScene.material instead."},deprecatedMaterial:{checked:!1,message:"UmbraScene has no normals so it will appear black."},report:function(e){o.diagnostics[e].checked||(o.diagnostics[e].checked=!0,console.warn(o.diagnostics[e].message))}},this.umbra=void 0,this.onDispose=void 0,this.oldState={status:void 0,visibleIDs:new Set},this.update=function(e){var t=this;if(!this.freeze)if(0!==this.umbra.nativeScene.ptr){var n=this.sharedState.cameraToView.get(e);if(n||(n=this.umbra.runtime.createView(),this.sharedState.cameraToView.set(e,n)),this.sharedState.viewLastUseFrame.set(n,this.renderer.info.render.frame),this.umbra.nativeScene.setTransform(this.matrixWorld.elements),this.isPBREnabled()){var a=this.matrixWorld.determinant()<0;a!==this.shaderPatcher.flipTangent&&(this.shaderPatcher.flipTangent=a,this.materialPool.clear())}this.stats.numVisible=0,this.stats.numAssets=this.umbra.runtime.assets.size;for(var i=[],o=0;o<this.children.length;o++)this.children[o].isUmbraMesh||i.push(this.children[o]);this.children=i;var s=[],u=new r.Object3D;u.isLOD=!0,u.autoUpdate=!0,u.update=function(e){t.children.pop();for(var r=0;r<s.length;r++)t.children.push(s[r])},this.materialPool.freeAll((function(e){delete e.map,delete e.normalMap,delete e.metalnessMap,delete e.roughnessMap}));var l=[],c=new Set;this.sharedState.viewRenderables.has(n)&&(l=this.sharedState.viewRenderables.get(n));for(var f=function(e){if(l[e].scenePtr!==t.umbra.nativeScene.ptr)return"continue";var n=l[e].mesh,a=n.materialDesc,i=n.geometry;c.add(l[e].id),t.stats.numVisible+=1;var o=a.transparent||t.material.transparent,u=t.materialPool.allocate((function(){return t.material.clone()}),(function(e){return e.transparent===o}));u.wireframe=t.wireframe,u.opacity=t.material.opacity,u.transparent=o,u.onBeforeCompile=function(e,r){t.material.onBeforeCompile&&t.material.onBeforeCompile.apply(u,[e,r]),t.shaderPatcher.process(e,r)};var f=a.textures[p.Diffuse],d=a.textures[p.Normal],m=a.textures[p.Specular];f&&f.isTexture&&(u.map=f),d&&d.isTexture&&(u.normalMap=d,u.vertexTangents=!0,u.normalMapType=r.TangentSpaceNormalMap),m&&m.isTexture&&(u.metalnessMap=m,u.metalness=1,u.roughnessMap=m,u.roughness=1);var h=new r.Mesh(i,u);h.isUmbraMesh=!0,h.matrixWorld.copy(t.matrixWorld),h.castShadow=t.castShadow,h.receiveShadow=t.receiveShadow,h.visible=!0,t.children.push(h),0==(1&l[e].mask)?(s.push(h),h.frustumCulled=!0):(t.children.push(h),h.frustumCulled=!1)},d=0;d<l.length;d++)f(d);if(!this.diagnostics.missingNormals.checked&&this.isPBREnabled())for(var m=0;m<this.children.length;m++)if(this.children[m].isUmbraMesh&&!("normal"in this.children[m].geometry.attributes)){this.diagnostics.report("missingNormals");break}this.stats.numShadowCasters=s.length,this.stats.numCachedMaterials=this.materialPool.usedList.length+this.materialPool.freeList.length,s.length>0&&this.children.push(u),this.updateStreamingEvents(c)}else console.warn("Renderer tried to update a disposed UmbraScene")},this.renderer=a,this.sharedState=n,this.shaderPatcher=new H(i.formats),this.onDispose=s,this.scale.set(1,1,-1),this.umbra={runtime:e,nativeScene:t}}get opaqueMaterial(){return this.diagnostics.report("deprecatedMaterial"),this.material}set opaqueMaterial(e){this.diagnostics.report("deprecatedMaterial"),this.material=e}getInfo(){var e={connected:this.umbra.nativeScene.isConnected()};return e.connected&&(e.sceneInfo=this.umbra.nativeScene.getInfo()),Object.assign(e,this.stats),e}getBounds(){if(this.umbra.nativeScene.isConnected()){var e=this.umbra.nativeScene.getInfo().bounds,t=e.mn,n=e.mx;return new r.Box3(new r.Vector3(t[0],t[1],t[2]),new r.Vector3(n[0],n[1],n[2]))}}getCenter(){var e=this.getBounds();e.applyMatrix4(this.matrixWorld);var t=new r.Vector3;return e.getCenter(t),t}updateStreamingEvents(e){var t=this.oldState.visibleIDs,r=e;if(this.onMeshChanged)if(t.size!==r.size)this.onMeshChanged();else for(var n of r)if(!t.has(n)){this.onMeshChanged();break}this.oldState.visibleIDs=e}updateNetworkEvents(){var e=this.umbra.nativeScene.connectionStatus();if(this.oldState.status!==e)switch(this.onConnectionChanged&&this.onConnectionChanged(e),e){case L.ConnectionError:this.onConnectionError&&this.onConnectionError("Could not connect");break;case L.Connected:this.onConnected&&this.onConnected();break;case L.Connecting:this.onDisconnected&&this.onDisconnected()}this.oldState.status=e}dispose(){this.onDispose&&this.onDispose(this),this.children=this.children.filter((function(e){return!e.isUmbraMesh})),this.materialPool.freeAll((function(e){return e.dispose()})),this.umbra.nativeScene.destroy()}isPBREnabled(){return"normalMapType"in this.material}}class K extends r.Loader{constructor(e,t){super(t),this.Umbra=void 0,this.Umbra=e}load(e,t,r,n){var a=this.Umbra.createScene(e);n&&(a.onConnectionError=function(e){n(e)}),a.onConnected=function(){delete a.onConnectionError,r&&r(1),t(a)}}}class J{get memoryUsed(){return this.textureMemoryUsed+this.meshMemoryUsed}constructor(e,t){var n,a=this;this.memoryLimit=524288e3,this.downloadLimit=0,this.qualityFactor=1,this.onStreamingUpdate=void 0,this.onStreamingComplete=void 0,this.umbrajs=void 0,this.runtime=void 0,this.features=void 0,this.renderer=void 0,this.updateTask=void 0,this.assetSizes=new Map,this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.lastQualityLowerFrame=-1,this.umbraScenes=new Set,this.oldState={progress:0,downloadLimitReached:!1},this.sharedState={cameraToView:new Map,viewRenderables:new Map,viewLastUseFrame:new Map},this.tempVector=new r.Vector3,this.dirVector=new r.Vector3,this.matrixWorldInverse=new r.Matrix4,this.projScreenMatrix=new r.Matrix4,this.cameraWorldPosition=new r.Vector3,this.handlers={LoadMaterial:function(e,t){var r=e;return r.transparent=!!e.transparent,a.runtime.addAsset(t,r),D.AssetLoadResult.Success},UnloadMaterial:function(e,t){a.runtime.removeAsset(t)},LoadTexture:function(e,t){var n,i=e.info,o=e.buffer;if(q.hasOwnProperty(i.format)&&(n=q[i.format]),!n)return console.log("Unknown texture format",i.format),a.runtime.addAsset(t,{isTexture:!1}),D.AssetLoadResult.Success;if(!a.canFitInMemory(o.size))return a.adjustQuality(.8),D.AssetLoadResult.OutOfMemory;var s=a.makeTexture(i,o,n),u=!1;return"outputEncoding"in a.renderer?u=a.renderer.outputEncoding===r.sRGBEncoding:"gammaOutput"in a.renderer&&(u=a.renderer.gammaOutput),i.type!==p.Diffuse||u?s.encoding=i.colorSpace===b.Linear?r.LinearEncoding:r.sRGBEncoding:s.encoding=r.LinearEncoding,s.needsUpdate=!0,a.textureMemoryUsed+=o.size,a.assetSizes.set(s,o.size),a.runtime.addAsset(t,s),D.AssetLoadResult.Success},UnloadTexture:function(e,t){e.isTexture&&e.dispose(),a.assetSizes.has(e)&&(a.textureMemoryUsed-=a.assetSizes.get(e),a.assetSizes.delete(e)),a.runtime.removeAsset(t)},LoadMesh:function(e,t){var n={position:{components:3},normal:{components:3},uv:{components:2},tangent:{components:3}},i=0;if(Object.keys(n).map((function(t){return e.buffers[t]})).forEach((function(e){e&&(i+=e.data.size)})),!a.canFitInMemory(i))return a.adjustQuality(.8),D.AssetLoadResult.OutOfMemory;var o,s,u,l,c,f=new r.BufferGeometry,d=e.buffers.index.data.getArray(),m=Array.from(d);f.setIndex(m),f.boundingSphere=(o=e.bounds,s=o[0],u=o[1],l=new r.Vector3(u[0]-s[0],u[1]-s[1],u[2]-s[2]),c=new r.Vector3(s[0]+.5*l.x,s[1]+.5*l.y,s[2]+.5*l.z),new r.Sphere(c,l.length())),Object.keys(n).forEach((function(t){var a=e.buffers[t];if(a){var i=a.data.getArray(),o=new r.Float32BufferAttribute(i.slice(),n[t].components);"setAttribute"in f?f.setAttribute(t,o):f.addAttribute(t,o)}}));var p={geometry:f,materialDesc:e.material};return a.meshMemoryUsed+=i,a.assetSizes.set(p,i),a.runtime.addAsset(t,p),D.AssetLoadResult.Success},UnloadMesh:function(e,t){a.assetSizes.has(e)&&(a.meshMemoryUsed-=a.assetSizes.get(e),a.assetSizes.delete(e)),a.runtime.removeAsset(t),e.geometry.dispose()}},n="getContext"in t?t.getContext():t.context;var i=e.getPlatformFeatures(n);i.textureSupportMask&=~A.BC5,this.umbrajs=e,this.runtime=e.createRuntime({features:i}),this.runtime.setHandlers(this.handlers),this.renderer=t,this.features=i,this.startEventUpdate(1e3/60)}startEventUpdate(e){var t=this;this.stopEventUpdate(),this.updateTask=window.setInterval((function(){t.updateEvents(),t.umbraScenes.forEach((function(e){return e.updateNetworkEvents()}))}),e)}stopEventUpdate(){void 0!==this.updateTask&&(window.clearInterval(this.updateTask),delete this.updateTask)}findLights(e){var t;if(e.traverseAncestors((function(e){e.isScene&&(t=e)})),!t||t&&!t.isScene)return new Set;var r=new Set;return t.traverseVisible((function(e){e.isDirectionalLight&&e.castShadow&&r.add(e)})),r}pruneOldViews(e){for(var t of this.sharedState.viewLastUseFrame){var r=i(t,2),n=r[0];if(!(e-r[1]<600)){for(var a of this.sharedState.cameraToView){var o=i(a,2),s=o[0];if(o[1]===n){this.sharedState.cameraToView.delete(s);break}}n.destroy(),this.sharedState.viewLastUseFrame.delete(n)}}}updateViews(){var e=this.sharedState,t=new Set;if(this.renderer.shadowMap.enabled)for(var r of this.umbraScenes)for(var n of this.findLights(r))t.add(n);var a=this.dirVector,s=this.tempVector,u=Array.from(t).map((function(e){return a.setFromMatrixPosition(e.target.matrixWorld),s.setFromMatrixPosition(e.matrixWorld),a.sub(s),[a.x,a.y,a.z]}),t);for(var l of(this.pruneOldViews(this.renderer.info.render.frame),e.cameraToView)){var c=i(l,2),f=c[0],d=c[1],m=f;this.matrixWorldInverse.getInverse(m.matrixWorld),this.projScreenMatrix.multiplyMatrices(m.projectionMatrix,this.matrixWorldInverse),"umbraStreamingPosition"in m?this.cameraWorldPosition.copy(m.umbraStreamingPosition):m.getWorldPosition(this.cameraWorldPosition);var p=.5;"umbraQuality"in m&&(p=m.umbraQuality);var h=this.cameraWorldPosition;d.setCamera(this.projScreenMatrix.elements,[h.x,h.y,h.z],p*this.qualityFactor,u);var b=[];e.viewRenderables.has(d)?(b=e.viewRenderables.get(d)).length=0:e.viewRenderables.set(d,b);var y=[];do{var v;y=d.getVisible(500),(v=b).push.apply(v,o(y))}while(500===y.length)}}update(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=0!==this.downloadLimit&&this.getStats().maxBytesDownloaded>=this.downloadLimit;if(t)this.oldState.downloadLimitReached||this.umbrajs.abortDownloads();else{var r=performance.now();this.runtime.update();var n=performance.now()-r;this.runtime.loadAssets(e-n),this.updateViews()}this.oldState.downloadLimitReached=t,this.memoryUsed/this.memoryLimit<.25&&this.adjustQuality(1.1)}createScene(e){var t,r=this;if("string"==typeof e)t=e;else{if("object"!==n(e))throw new TypeError("expected either string or an object argument");if("token"in e&&(console.warn("Connection with {token, projectID, modelID} is deprecated. Use {key, project, model} or a string locator instad."),e.key=e.token,e.project=e.projectID,e.model=e.modelID),!("key"in e&&"project"in e&&"model"in e))throw new Error('createScene() expects an object with properties "key", "project", and "model"');t="key=".concat(e.key,"&project=").concat(e.project,"&model=").concat(e.model)}var a=new Q(this.runtime,this.runtime.createScenePublic(t),this.sharedState,this.renderer,this.features,(function(e){return r.umbraScenes.delete(e)}));return this.umbraScenes.add(a),a}createSceneWithURL(e){var t=this,r=this.runtime.createSceneLocal(e),n=new Q(this.runtime,r,this.sharedState,this.renderer,this.features,(function(e){return t.umbraScenes.delete(e)}));return this.umbraScenes.add(n),n}getStats(){return Object.assign(this.umbrajs.getStreamingInfo(),{textureMemoryUsed:this.textureMemoryUsed,meshMemoryUsed:this.meshMemoryUsed})}canFitInMemory(e){return this.memoryUsed+e<this.memoryLimit}adjustQuality(e){this.renderer.info.render.frame!=this.lastQualityLowerFrame&&(this.qualityFactor=Math.max(0,Math.min(1,this.qualityFactor*e)),this.lastQualityLowerFrame=this.renderer.info.render.frame)}makeTexture(e,t,n){var a,i=t.getArray().slice();if(n.compressed){var o={width:e.width,height:e.height,data:i};a=new r.CompressedTexture([o],e.width,e.height)}else a=new r.DataTexture(i,e.width,e.height);return a.format=n.format,a.type=n.type,a.magFilter=r.LinearFilter,a.minFilter=r.LinearFilter,a.anisotropy=0,a}updateEvents(){var e=this.getStreamingProgress();this.oldState.progress!=e&&(this.onStreamingUpdate&&this.onStreamingUpdate(e),1===e&&this.onStreamingComplete&&this.onStreamingComplete()),this.oldState.progress=e}getStreamingProgress(){return this.runtime.getStreamingProgress()}dispose(){for(var e of(this.stopEventUpdate(),this.sharedState.cameraToView.values()))e.destroy();this.umbraScenes.forEach((function(e){return e.dispose()})),this.sharedState.cameraToView.clear(),this.umbraScenes.clear(),this.runtime.assets.forEach((function(e,t){"geometry"in e&&e.geometry.dispose(),"dispose"in e&&e.dispose()})),this.assetSizes.clear(),this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.runtime.destroy(),this.runtime=void 0,function(e){e.abortDownloads();var t=e;try{t.nativeModule._exit(0)}catch(e){if("ExitStatus"!==e.name)throw e}}(this.umbrajs)}}t.Loader=K,t.Scene=Q,t.initWithThreeJS=function(e,t){if(!e)throw new TypeError('"renderer" should be of type THREE.WebGLRenderer');return j(t).then((function(t){return new J(t,e)}))},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=umbrajs-three.amd.min.js.map
