import{UnsignedByteType as e,RGBAFormat as t,UnsignedShort565Type as n,RGBFormat as r,LuminanceAlphaFormat as a,HalfFloatType as i,RGBA_S3TC_DXT1_Format as s,RGBA_S3TC_DXT5_Format as o,RGB_ETC1_Format as u,RGBA_ASTC_4x4_Format as l,RGB_PVRTC_4BPPV1_Format as c,Object3D as m,MeshBasicMaterial as d,TangentSpaceNormalMap as f,Mesh as h,Box3 as p,Vector3 as b,Loader as y,Matrix4 as g,sRGBEncoding as w,LinearEncoding as v,BufferGeometry as S,Sphere as C,Float32BufferAttribute as U,CompressedTexture as T,DataTexture as A,LinearFilter as L}from"three";var _,x,E,P,M,B,R,F,k,I,D,G,z,W,N,O,V,j,q,H,X,Q,$,J,K=(_="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var t;e=e||{},t||(t=void 0!==e?e:{});var n,r={};for(n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);function a(e,t){throw t}var i="";document.currentScript&&(i=document.currentScript.src),_&&(i=_),i=0!==i.indexOf("blob:")?i.substr(0,i.lastIndexOf("/")+1):"";var s,o,u,l=t.print||console.log.bind(console),c=t.printErr||console.warn.bind(console);for(n in r)r.hasOwnProperty(n)&&(t[n]=r[n]);function m(e,t){return t||(t=16),Math.ceil(e/t)*t}r=null,t.quit&&(a=t.quit),t.wasmBinary&&(o=t.wasmBinary),t.noExitRuntime&&(u=t.noExitRuntime),"object"!=typeof WebAssembly&&c("no native wasm support detected");var d,f=new WebAssembly.Table({initial:272,maximum:272,element:"anyfunc"}),h=!1;function p(e,t){e||j("Assertion failed: "+t)}function b(e){var n=t["_"+e];return p(n,"Cannot call unknown function "+e+", make sure it is exported"),n}function y(e,t,n,r){var a={string:function(e){var t=0;if(null!=e&&0!==e){var n=1+(e.length<<2);M(e,t=Mt(n),n)}return t},array:function(e){var t=Mt(e.length);return w.set(e,t),t}},i=b(e),s=[];if(e=0,r)for(var o=0;o<r.length;o++){var u=a[n[o]];u?(0===e&&(e=Pt()),s[o]=u(r[o])):s[o]=r[o]}return n=function(e){return"string"===t?P(e):"boolean"===t?!!e:e}(n=i.apply(null,s)),0!==e&&Bt(e),n}var g,w,v,S,C,U,T,A,L,x="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function E(e,t,n){var r=t+n;for(n=t;e[n]&&!(n>=r);)++n;if(16<n-t&&e.subarray&&x)return x.decode(e.subarray(t,n));for(r="";t<n;){var a=e[t++];if(128&a){var i=63&e[t++];if(192==(224&a))r+=String.fromCharCode((31&a)<<6|i);else{var s=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|i<<6|s:(7&a)<<18|i<<12|s<<6|63&e[t++])?r+=String.fromCharCode(a):(a-=65536,r+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else r+=String.fromCharCode(a)}return r}function P(e){return e?E(v,e,void 0):""}function M(e,t,n){var r=v;if(0<n){n=t+n-1;for(var a=0;a<e.length;++a){var i=e.charCodeAt(a);if(55296<=i&&57343>=i&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++a)),127>=i){if(t>=n)break;r[t++]=i}else{if(2047>=i){if(t+1>=n)break;r[t++]=192|i>>6}else{if(65535>=i){if(t+2>=n)break;r[t++]=224|i>>12}else{if(t+3>=n)break;r[t++]=240|i>>18,r[t++]=128|i>>12&63}r[t++]=128|i>>6&63}r[t++]=128|63&i}}r[t]=0}}function B(e){return 0<e%65536&&(e+=65536-e%65536),e}function R(e){g=e,t.HEAP8=w=new Int8Array(e),t.HEAP16=S=new Int16Array(e),t.HEAP32=U=new Int32Array(e),t.HEAPU8=v=new Uint8Array(e),t.HEAPU16=C=new Uint16Array(e),t.HEAPU32=T=new Uint32Array(e),t.HEAPF32=A=new Float32Array(e),t.HEAPF64=L=new Float64Array(e)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var F=t.TOTAL_MEMORY||134217728;function k(e){for(;0<e.length;){var n=e.shift();if("function"==typeof n)n();else{var r=n.Mb;"number"==typeof r?void 0===n.Jb?t.dynCall_v(r):t.dynCall_vi(r,n.Jb):r(void 0===n.Jb?null:n.Jb)}}}(d=t.wasmMemory?t.wasmMemory:new WebAssembly.Memory({initial:F/65536}))&&(g=d.buffer),F=g.byteLength,R(g),U[7368]=5272512;var I=[],D=[],G=[],z=[],W=[];function N(){var e=t.preRun.shift();I.unshift(e)}var O=0,V=null;function j(e){throw t.onAbort&&t.onAbort(e),l(e),c(e),h=!0,new WebAssembly.RuntimeError("abort("+e+"). Build with -s ASSERTIONS=1 for more info.")}function q(){var e=H;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):0===e.indexOf("data:application/octet-stream;base64,")}t.preloadedImages={},t.preloadedAudios={};var H="umbra.wasm";if(!q()){var X=H;H=t.locateFile?t.locateFile(X,i):i+X}function Q(){try{if(o)return new Uint8Array(o);throw"both async and sync fetching of the wasm failed"}catch(e){j(e)}}var $={8103:function(){alert("Uploads are not supported.")},9294:function(){alert("Invalid http method.")},9575:function(e,n,r,a,i,s,o,u,l,c,m){return function(e,n,r,a,i,s,o,u,l,c,m){var d=P(e);n=P(n),s=P(s);var f=new XMLHttpRequest;f.open(n,d,!0),("GET"!=n||0!=s.length)&&(f.withCredentials=!0),f.responseType="arraybuffer";var h=function(){var e=yt;return yt++,e}();if(f.onload=function(){if(200==f.status){var n=new Uint8Array(f.response),s=t.URLsDownloaded;t.maxBytesDownloaded+=f.response.byteLength,s.has(e)||(s.add(e),t.minBytesDownloaded+=f.response.byteLength),c?n.length!=m?t.dynCall_viii(i,h,r,0):(v.set(n,c),t.dynCall_viiii(a,h,r,null,0)):(s=_t(n.length),v.set(n,s),t.dynCall_viiii(a,h,r,s,n.length),xt(s))}else t.dynCall_viii(i,h,r,f.status);delete bt[h]},f.onerror=function(){t.dynCall_viii(i,h,r,f.status),delete bt[h]},f.onabort=function(){delete bt[h]},0!=s.length&&f.setRequestHeader("Authorization","Basic "+btoa(s+":")),2<=(l=P(l).split("\n")).length)for(d=0;d<l.length;d+=2)f.setRequestHeader(l[d],l[d+1]);return"POST"==n?f.send(w.slice(o,o+u)):f.send(null),bt[h]=f,h}(e,n,r,a,i,s,o,u,l,c,m)}},J=[];function K(e,t){z.unshift({Mb:e,Jb:t})}D.push({Mb:function(){Lt()}});var Y=[null,[],[]];function Z(e,t){var n=Y[e];0===t||10===t?((1===e?l:c)(E(n,0)),n.length=0):n.push(t)}var ee=0;function te(){return U[(ee+=4)-4>>2]}var ne={},re={};function ae(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function ie(e){return this.fromWireType(T[e>>2])}var se={},oe={},ue={};function le(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return 48<=t&&57>=t?"_"+e:e}function ce(e,t){return e=le(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function me(e){var t=Error,n=ce(e,(function(t){this.name=e,this.message=t,void 0!==(t=Error(t).stack)&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))}));return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var de=void 0;function fe(e,t,n){function r(t){if((t=n(t)).length!==e.length)throw new de("Mismatched type converter count");for(var r=0;r<e.length;++r)we(e[r],t[r])}e.forEach((function(e){ue[e]=t}));var a=Array(t.length),i=[],s=0;t.forEach((function(e,t){oe.hasOwnProperty(e)?a[t]=oe[e]:(i.push(e),se.hasOwnProperty(e)||(se[e]=[]),se[e].push((function(){a[t]=oe[e],++s===i.length&&r(a)})))})),0===i.length&&r(a)}function he(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var pe=void 0;function be(e){for(var t="";v[e];)t+=pe[v[e++]];return t}var ye=void 0;function ge(e){throw new ye(e)}function we(e,t,n){if(n=n||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||ge('type "'+r+'" must have a positive integer typeid pointer'),oe.hasOwnProperty(e)){if(n.Wb)return;ge("Cannot register type '"+r+"' twice")}oe[e]=t,delete ue[e],se.hasOwnProperty(e)&&(t=se[e],delete se[e],t.forEach((function(e){e()})))}var ve=[],Se=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Ce(e){4<e&&0==--Se[e].Nb&&(Se[e]=void 0,ve.push(e))}function Ue(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=ve.length?ve.pop():Se.length;return Se[t]={Nb:1,value:e},t}}function Te(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Ae(e,t){switch(t){case 2:return function(e){return this.fromWireType(A[e>>2])};case 3:return function(e){return this.fromWireType(L[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function Le(e){var t=Function;if(!(t instanceof Function))throw new TypeError("new_ called with constructor type "+typeof t+" which is not a function");var n=ce(t.name||"unknownFunctionName",(function(){}));return n.prototype=t.prototype,n=new n,(e=t.apply(n,e))instanceof Object?e:n}function _e(e,n,r){t.hasOwnProperty(e)?((void 0===r||void 0!==t[e].Hb&&void 0!==t[e].Hb[r])&&ge("Cannot register public name '"+e+"' twice"),function(e,n){var r=t;if(void 0===r[e].Hb){var a=r[e];r[e]=function(){return r[e].Hb.hasOwnProperty(arguments.length)||ge("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+r[e].Hb+")!"),r[e].Hb[arguments.length].apply(this,arguments)},r[e].Hb=[],r[e].Hb[a.Qb]=a}}(e,e),t.hasOwnProperty(r)&&ge("Cannot register multiple overloads of a function with the same number of arguments ("+r+")!"),t[e].Hb[r]=n):(t[e]=n,void 0!==r&&(t[e].pc=r))}function xe(e,n){if(e=be(e),void 0!==t["FUNCTION_TABLE_"+e])var r=t["FUNCTION_TABLE_"+e][n];else if("undefined"!=typeof FUNCTION_TABLE)r=FUNCTION_TABLE[n];else{void 0===(r=t["dynCall_"+e])&&void 0===(r=t["dynCall_"+e.replace(/f/g,"d")])&&ge("No dynCall invoker for signature: "+e);for(var a=[],i=1;i<e.length;++i)a.push("a"+i);i="return function dynCall_"+e+"_"+n+"("+a.join(", ")+") {\n",i+="    return dynCall(rawFunction"+(a.length?", ":"")+a.join(", ")+");\n",r=new Function("dynCall","rawFunction",i+"};\n")(r,n)}return"function"!=typeof r&&ge("unknown function pointer with signature "+e+": "+n),r}var Ee=void 0;function Pe(e){var t=be(e=Et(e));return xt(e),t}function Me(e,t,n){switch(t){case 0:return n?function(e){return w[e]}:function(e){return v[e]};case 1:return n?function(e){return S[e>>1]}:function(e){return C[e>>1]};case 2:return n?function(e){return U[e>>2]}:function(e){return T[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Be(e){return e||ge("Cannot use deleted val. handle = "+e),Se[e].value}function Re(e,t){var n=oe[e];return void 0===n&&ge(t+" has unknown type "+Pe(e)),n}var Fe={};function ke(e){var t=Fe[e];return void 0===t?be(e):t}var Ie=[];function De(){j()}var Ge,ze,We=null,Ne="",Oe=0,Ve=null,je=0,qe=0,He=0,Xe=0,Qe=[],$e={},Je=!1,Ke=!1,Ye=[];function Ze(){function e(){Ke=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas||document.msPointerLockElement===t.canvas}if(t.preloadPlugins||(t.preloadPlugins=[]),!dt){dt=!0;try{ft=!0}catch(e){ft=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}ht="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:ft?null:console.log("warning: no BlobBuilder"),pt="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,t.Pb||void 0!==pt||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),t.Pb=!0),t.preloadPlugins.push({canHandle:function(e){return!t.Pb&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,n,r,a){var i=null;if(ft)try{(i=new Blob([e],{type:ut(n)})).size!==e.length&&(i=new Blob([new Uint8Array(e).buffer],{type:ut(n)}))}catch(e){!function(e){s||(s={}),s[e]||(s[e]=1,c(e))}("Blob constructor present but fails: "+e+"; falling back to blob builder")}i||((i=new ht).append(new Uint8Array(e).buffer),i=i.getBlob());var o=pt.createObjectURL(i),u=new Image;u.onload=function(){p(u.complete,"Image "+n+" could not be decoded");var a=document.createElement("canvas");a.width=u.width,a.height=u.height,a.getContext("2d").drawImage(u,0,0),t.preloadedImages[n]=a,pt.revokeObjectURL(o),r&&r(e)},u.onerror=function(){console.log("Image "+o+" could not be decoded"),a&&a()},u.src=o}}),t.preloadPlugins.push({canHandle:function(e){return!t.oc&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,n,r,a){function i(a){o||(o=!0,t.preloadedAudios[n]=a,r&&r(e))}function s(){o||(o=!0,t.preloadedAudios[n]=new Audio,a&&a())}var o=!1;if(!ft)return s();try{var l=new Blob([e],{type:ut(n)})}catch(e){return s()}l=pt.createObjectURL(l);var c=new Audio;c.addEventListener("canplaythrough",(function(){i(c)}),!1),c.onerror=function(){if(!o){console.log("warning: browser could not fully decode audio "+n+", trying slower base64 approach");for(var t="",r=0,a=0,s=0;s<e.length;s++)for(r=r<<8|e[s],a+=8;6<=a;){var u=r>>a-6&63;a-=6,t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[u]}2==a?(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&r)<<4],t+="=="):4==a&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&r)<<2],t+="="),c.src="data:audio/x-"+n.substr(-3)+";base64,"+t,i(c)}},c.src=l,function(e){u=!0,setTimeout((function(){h||e()}),1e4)}((function(){i(c)}))}});var n=t.canvas;n&&(n.requestPointerLock=n.requestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock||n.msRequestPointerLock||function(){},n.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},n.exitPointerLock=n.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),t.elementPointerLock&&n.addEventListener("click",(function(e){!Ke&&t.canvas.requestPointerLock&&(t.canvas.requestPointerLock(),e.preventDefault())}),!1))}}var et=!1,tt=void 0,nt=void 0;function rt(e,n,r){function a(){Je=!1;var e=i.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.exitFullscreen=it,tt&&i.requestPointerLock(),Je=!0,nt?("undefined"!=typeof SDL&&(U[SDL.screen>>2]=8388608|T[SDL.screen>>2]),mt(t.canvas),ct()):mt(i)):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),nt?("undefined"!=typeof SDL&&(U[SDL.screen>>2]=-8388609&T[SDL.screen>>2]),mt(t.canvas),ct()):mt(i)),t.onFullScreen&&t.onFullScreen(Je),t.onFullscreen&&t.onFullscreen(Je)}void 0===(tt=e)&&(tt=!0),void 0===(nt=n)&&(nt=!1);var i=t.canvas;et||(et=!0,document.addEventListener("fullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1));var s=document.createElement("div");i.parentNode.insertBefore(s,i),s.appendChild(i),s.requestFullscreen=s.requestFullscreen||s.mozRequestFullScreen||s.msRequestFullscreen||(s.webkitRequestFullscreen?function(){s.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(s.webkitRequestFullScreen?function(){s.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r?s.requestFullscreen({rc:r}):s.requestFullscreen()}function at(e,t,n){c("Browser.requestFullScreen() is deprecated. Please call Browser.requestFullscreen instead."),at=function(e,t,n){rt(e,t,n)},rt(e,t,n)}function it(){return!!Je&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)}var st=0;function ot(e){if("function"==typeof requestAnimationFrame)requestAnimationFrame(e);else{var t=Date.now();if(0===st)st=t+1e3/60;else for(;t+2>=st;)st+=1e3/60;setTimeout(e,Math.max(st-t,0))}}function ut(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]}var lt=[];function ct(){var e=t.canvas;lt.forEach((function(t){t(e.width,e.height)}))}function mt(e,n,r){n&&r?(e.dc=n,e.Vb=r):(n=e.dc,r=e.Vb);var a=n,i=r;if(t.forcedAspectRatio&&0<t.forcedAspectRatio&&(a/i<t.forcedAspectRatio?a=Math.round(i*t.forcedAspectRatio):i=Math.round(a/t.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var s=Math.min(screen.width/a,screen.height/i);a=Math.round(a*s),i=Math.round(i*s)}nt?(e.width!=a&&(e.width=a),e.height!=i&&(e.height=i),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=n&&(e.width=n),e.height!=r&&(e.height=r),void 0!==e.style&&(a!=n||i!=r?(e.style.setProperty("width",a+"px","important"),e.style.setProperty("height",i+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))}var dt,ft,ht,pt,bt={},yt=0,gt={};function wt(e,t){var n=gt[e];if(n)t(null,n);else{try{var r=function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"==typeof window&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),p(e,"IDBStore used, but indexedDB not supported"),e}().open(e,22)}catch(e){return void t(e)}r.onupgradeneeded=function(e){var t=e.target.result;e=e.target.transaction,t.objectStoreNames.contains("FILE_DATA")?e.objectStore("FILE_DATA"):t.createObjectStore("FILE_DATA")},r.onsuccess=function(){n=r.result,gt[e]=n,t(null,n)},r.onerror=function(e){t(this.error),e.preventDefault()}}}function vt(e,t,n){wt(e,(function(e,r){if(e)return n(e);(e=r.transaction(["FILE_DATA"],t)).onerror=function(e){n(this.error||"unknown error"),e.preventDefault()},e=e.objectStore("FILE_DATA"),n(null,e)}))}function St(e){!u&&(h=!0,k(z),t.onExit)&&t.onExit(e),a(e,new It(e))}t._exit=St,M("GMT",29536,4),de=t.InternalError=me("InternalError");for(var Ct=Array(256),Ut=0;256>Ut;++Ut)Ct[Ut]=String.fromCharCode(Ut);pe=Ct,ye=t.BindingError=me("BindingError"),t.count_emval_handles=function(){for(var e=0,t=5;t<Se.length;++t)void 0!==Se[t]&&++e;return e},t.get_first_emval=function(){for(var e=5;e<Se.length;++e)if(void 0!==Se[e])return Se[e];return null},Ee=t.UnboundTypeError=me("UnboundTypeError"),t.requestFullScreen=function(e,n,r){c("Module.requestFullScreen is deprecated. Please call Module.requestFullscreen instead."),t.requestFullScreen=t.requestFullscreen,at(e,n,r)},t.requestFullscreen=function(e,t,n){rt(e,t,n)},t.requestAnimationFrame=function(e){ot(e)},t.setCanvasSize=function(e,n,r){mt(t.canvas,e,n),r||ct()},t.pauseMainLoop=function(){We=null,Oe++},t.resumeMainLoop=function(){Oe++;var e=qe,n=He,r=Ve;Ve=null,function(e){var n=je;u=!0,p(!Ve,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),Ve=e,je=n;var r=void 0!==n?function(){t.dynCall_vi(e,n)}:function(){t.dynCall_v(e)},a=Oe;ze=function(){if(!h)if(0<Qe.length){var e,n=Date.now(),i=Qe.shift();i.Mb(i.Jb),console.log('main loop blocker "'+i.name+'" took '+(Date.now()-n)+" ms"),t.setStatus&&(n=t.statusMessage||"Please wait...",i=void 0,e=$e.jc,i?i<e?t.setStatus(n+" ("+(e-i)+"/"+e+")"):t.setStatus(n):t.setStatus("")),a<Oe||setTimeout(ze,0)}else if(!(a<Oe))if(Xe=Xe+1|0,1==qe&&1<He&&0!=Xe%He)We();else{0==qe&&(Ge=De()),"timeout"===Ne&&t.Kb&&(c("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),Ne="");e:if(!(h||t.preMainLoop&&!1===t.preMainLoop())){try{r()}catch(e){if(e instanceof It)break e;throw e&&"object"==typeof e&&e.stack&&c("exception thrown: "+[e,e.stack]),e}t.postMainLoop&&t.postMainLoop()}a<Oe||("object"==typeof SDL&&SDL.audio&&SDL.audio.Yb&&SDL.audio.Yb(),We())}}}(r),function(e,t){if(qe=e,He=t,Ve)if(0==e)We=function(){var e=0|Math.max(0,Ge+t-De());setTimeout(ze,e)},Ne="timeout";else if(1==e)We=function(){ot(ze)},Ne="rAF";else if(2==e){if("undefined"==typeof setImmediate){var n=[];addEventListener("message",(function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),n.shift()())}),!0),setImmediate=function(e){n.push(e),postMessage("setimmediate","*")}}We=function(){setImmediate(ze)},Ne="immediate"}}(e,n),We()},t.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},t.createContext=function(e,n,r,a){return function(e,n,r,a){if(n&&t.Kb&&e==t.canvas)return t.Kb;var i;if(n){var s={antialias:!1,alpha:!1,mc:1};if(a)for(var o in a)s[o]=a[o];if("undefined"!=typeof GL&&(i=GL.gc(e,s)))var u=GL.getContext(i).ec}else u=e.getContext("2d");return u?(r&&(n||p("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),t.Kb=u,n&&GL.nc(i),t.qc=n,Ye.forEach((function(e){e()})),Ze()),u):null}(e,n,r,a)},De="undefined"!=typeof dateNow?dateNow:"object"==typeof performance&&performance&&"function"==typeof performance.now?function(){return performance.now()}:Date.now,z.push((function(){var e=t._fflush;e&&e(0),Y[1].length&&Z(1,10),Y[2].length&&Z(2,10)}));var Tt={U:function(){c("missing function: _ZN5Umbra13MiniSceneCopy7connectERK20UmbraSceneCopySource"),j(-1)},T:function(){c("missing function: _ZN5Umbra13MiniSceneCopy9getStatusEPf"),j(-1)},V:function(){c("missing function: _ZN5Umbra13MiniSceneCopyC1ERNS_11MiniRuntimeERK25UmbraSceneCopyDestinationPK20UmbraEnvironmentInfoRKN5Eigen6MatrixIfLi3ELi1ELi0ELi3ELi1EEEfi"),j(-1)},C:function(){return K.apply(null,arguments)},L:function(){},P:function(e,t){ee=t;try{var n=P(te()),r=te();return ne.ic((void 0).stat,n,r)}catch(e){return j(e),-e.Lb}},w:function(e,t){return ee=t,0},O:function(e,t){ee=t;try{var n=P(te()),r=te(),a=te();return(void 0).open(n,r,a).kc}catch(e){return j(e),-e.Lb}},N:function(e,t){return ee=t,0},s:function(){},A:function(e){var t=re[e];delete re[e];var n=t.Zb,r=t.$b,a=t.Ob;fe([e],a.map((function(e){return e.Ub})).concat(a.map((function(e){return e.bc}))),(function(e){var i={};return a.forEach((function(t,n){var r=e[n],s=t.Sb,o=t.Tb,u=e[n+a.length],l=t.ac,c=t.cc;i[t.Rb]={read:function(e){return r.fromWireType(s(o,e))},write:function(e,t){var n=[];l(c,e,u.toWireType(n,t)),ae(n)}}})),[{name:t.name,fromWireType:function(e){var t,n={};for(t in i)n[t]=i[t].read(e);return r(e),n},toWireType:function(e,t){for(var a in i)if(!(a in t))throw new TypeError("Missing field");var s=n();for(a in i)i[a].write(s,t[a]);return null!==e&&e.push(r,s),s},argPackAdvance:8,readValueFromPointer:ie,Ib:r}]}))},I:function(e,t,n,r,a){var i=he(n);we(e,{name:t=be(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:a},argPackAdvance:8,readValueFromPointer:function(e){if(1===n)var r=w;else if(2===n)r=S;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);r=U}return this.fromWireType(r[e>>i])},Ib:null})},k:function(e,n,r){e=be(e),fe([],[n],(function(n){return n=n[0],t[e]=n.fromWireType(r),[]}))},G:function(e,t){we(e,{name:t=be(t),fromWireType:function(e){var t=Se[e].value;return Ce(e),t},toWireType:function(e,t){return Ue(t)},argPackAdvance:8,readValueFromPointer:ie,Ib:null})},u:function(e,t,n){n=he(n),we(e,{name:t=be(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+Te(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Ae(t,n),Ib:null})},e:function(e,n,r,a,i,s){var o=function(e,t){for(var n=[],r=0;r<e;r++)n.push(U[(t>>2)+r]);return n}(n,r);e=be(e),i=xe(a,i),_e(e,(function(){!function(e,t){var n=[],r={};throw t.forEach((function e(t){r[t]||oe[t]||(ue[t]?ue[t].forEach(e):(n.push(t),r[t]=!0))})),new Ee(e+": "+n.map(Pe).join([", "]))}("Cannot call "+e+" due to unbound types",o)}),n-1),fe([],o,(function(r){var a=e,o=e;r=[r[0],null].concat(r.slice(1));var u=i,l=r.length;2>l&&ge("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var c=null!==r[1]&&!1,m=!1,d=1;d<r.length;++d)if(null!==r[d]&&void 0===r[d].Ib){m=!0;break}var f="void"!==r[0].name,h="",p="";for(d=0;d<l-2;++d)h+=(0!==d?", ":"")+"arg"+d,p+=(0!==d?", ":"")+"arg"+d+"Wired";o="return function "+le(o)+"("+h+") {\nif (arguments.length !== "+(l-2)+") {\nthrowBindingError('function "+o+" called with ' + arguments.length + ' arguments, expected "+(l-2)+" args!');\n}\n",m&&(o+="var destructors = [];\n");var b=m?"destructors":"null";for(h="throwBindingError invoker fn runDestructors retType classParam".split(" "),u=[ge,u,s,ae,r[0],r[1]],c&&(o+="var thisWired = classParam.toWireType("+b+", this);\n"),d=0;d<l-2;++d)o+="var arg"+d+"Wired = argType"+d+".toWireType("+b+", arg"+d+"); // "+r[d+2].name+"\n",h.push("argType"+d),u.push(r[d+2]);if(c&&(p="thisWired"+(0<p.length?", ":"")+p),o+=(f?"var rv = ":"")+"invoker(fn"+(0<p.length?", ":"")+p+");\n",m)o+="runDestructors(destructors);\n";else for(d=c?1:2;d<r.length;++d)l=1===d?"thisWired":"arg"+(d-2)+"Wired",null!==r[d].Ib&&(o+=l+"_dtor("+l+"); // "+r[d].name+"\n",h.push(l+"_dtor"),u.push(r[d].Ib));if(f&&(o+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),h.push(o+"}\n"),r=Le(h).apply(null,u),d=n-1,!t.hasOwnProperty(a))throw new de("Replacing nonexistant public symbol");return void 0!==t[a].Hb&&void 0!==d?t[a].Hb[d]=r:(t[a]=r,t[a].Qb=d),[]}))},o:function(e,t,n,r,a){function i(e){return e}t=be(t),-1===a&&(a=4294967295);var s=he(n);if(0===r){var o=32-8*n;i=function(e){return e<<o>>>o}}var u=-1!=t.indexOf("unsigned");we(e,{name:t,fromWireType:i,toWireType:function(e,n){if("number"!=typeof n&&"boolean"!=typeof n)throw new TypeError('Cannot convert "'+Te(n)+'" to '+this.name);if(n<r||n>a)throw new TypeError('Passing a number "'+Te(n)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+a+"]!");return u?n>>>0:0|n},argPackAdvance:8,readValueFromPointer:Me(t,s,0!==r),Ib:null})},m:function(e,t,n){function r(e){e>>=2;var t=T;return new a(t.buffer,t[e+1],t[e])}var a=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];we(e,{name:n=be(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{Wb:!0})},v:function(e,t){var n="std::string"===(t=be(t));we(e,{name:t,fromWireType:function(e){var t=T[e>>2];if(n){var r=v[e+4+t],a=0;0!=r&&(a=r,v[e+4+t]=0);var i=e+4;for(r=0;r<=t;++r){var s=e+4+r;if(0==v[s]){if(i=P(i),void 0===o)var o=i;else o+=String.fromCharCode(0),o+=i;i=s+1}}0!=a&&(v[e+4+t]=a)}else{for(o=Array(t),r=0;r<t;++r)o[r]=String.fromCharCode(v[e+4+r]);o=o.join("")}return xt(e),o},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ge("Cannot pass non-string to std::string");var a=(n&&r?function(){for(var e=0,n=0;n<t.length;++n){var r=t.charCodeAt(n);55296<=r&&57343>=r&&(r=65536+((1023&r)<<10)|1023&t.charCodeAt(++n)),127>=r?++e:e=2047>=r?e+2:65535>=r?e+3:e+4}return e}:function(){return t.length})(),i=_t(4+a+1);if(T[i>>2]=a,n&&r)M(t,i+4,a+1);else if(r)for(r=0;r<a;++r){var s=t.charCodeAt(r);255<s&&(xt(i),ge("String has UTF-16 code units that do not fit in 8 bits")),v[i+4+r]=s}else for(r=0;r<a;++r)v[i+4+r]=t[r];return null!==e&&e.push(xt,i),i},argPackAdvance:8,readValueFromPointer:ie,Ib:function(e){xt(e)}})},H:function(e,t,n){if(n=be(n),2===t)var r=function(){return C},a=1;else 4===t&&(r=function(){return T},a=2);we(e,{name:n,fromWireType:function(e){for(var t=r(),n=T[e>>2],i=Array(n),s=e+4>>a,o=0;o<n;++o)i[o]=String.fromCharCode(t[s+o]);return xt(e),i.join("")},toWireType:function(e,n){var i=n.length,s=_t(4+i*t),o=r();T[s>>2]=i;for(var u=s+4>>a,l=0;l<i;++l)o[u+l]=n.charCodeAt(l);return null!==e&&e.push(xt,s),s},argPackAdvance:8,readValueFromPointer:ie,Ib:function(e){xt(e)}})},B:function(e,t,n,r,a,i){re[e]={name:be(t),Zb:xe(n,r),$b:xe(a,i),Ob:[]}},q:function(e,t,n,r,a,i,s,o,u,l){re[e].Ob.push({Rb:be(t),Ub:n,Sb:xe(r,a),Tb:i,bc:s,ac:xe(o,u),cc:l})},J:function(e,t){we(e,{Xb:!0,name:t=be(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},h:function(e,t,n){e=Be(e),t=Re(t,"emval::as");var r=[],a=Ue(r);return U[n>>2]=a,t.toWireType(r,e)},i:function(e,t,n,r){(e=Ie[e])(t=Be(t),n=ke(n),null,r)},a:Ce,j:function(e,t){for(var n=(t=function(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=Re(U[(t>>2)+r],"parameter "+r);return n}(e,t))[0],r=n.name+"_$"+t.slice(1).map((function(e){return e.name})).join("_")+"$",a=["retType"],i=[n],s="",o=0;o<e-1;++o)s+=(0!==o?", ":"")+"arg"+o,a.push("argType"+o),i.push(t[1+o]);r="return function "+le("methodCaller_"+r)+"(handle, name, destructors, args) {\n";var u=0;for(o=0;o<e-1;++o)r+="    var arg"+o+" = argType"+o+".readValueFromPointer(args"+(u?"+"+u:"")+");\n",u+=t[o+1].argPackAdvance;for(r+="    var rv = handle[name]("+s+");\n",o=0;o<e-1;++o)t[o+1].deleteObject&&(r+="    argType"+o+".deleteObject(arg"+o+");\n");return n.Xb||(r+="    return retType.toWireType(destructors, rv);\n"),a.push(r+"};\n"),function(e){var t=Ie.length;return Ie.push(e),t}(e=Le(a).apply(null,i))},f:function(e,t){return Ue((e=Be(e))[t=Be(t)])},p:function(e){4<e&&(Se[e].Nb+=1)},n:function(){return Ue([])},b:function(e){return Ue(ke(e))},l:function(){return Ue({})},g:function(e){ae(Se[e].value),Ce(e)},d:function(e,t,n){e=Be(e),t=Be(t),n=Be(n),e[t]=n},c:function(e,t){return Ue(e=(e=Re(e,"_emval_take_value")).readValueFromPointer(t))},Q:function(){j()},r:function(e,t,n){e:for(J.length=0;;){var r=v[t++];if(!r){t=J;break e}100===r||102===r?(n=m(n,8),J.push(L[n>>3]),n+=8):105===r&&(n=m(n,4),J.push(U[n>>2]),n+=4)}return $[e].apply(null,t)},z:function(e){(e=bt[e])&&e.abort()},X:De,y:function(e,t,n,r,a){!function(e,t,n){vt(e,"readonly",(function(e,r){if(e)return n(e);(e=r.get(t)).onsuccess=function(e){return(e=e.target.result)?n(null,e):n("file "+t+" not found")},e.onerror=function(e){n(e)}}))}(P(e),P(t),(function(e,t){e?a&&Rt(a,n):(e=_t(t.length),v.set(t,e),kt(r,n,e,t.length),xt(e))}))},W:function(e,t,n,r,a,i,s){!function(e,t,n,r){vt(e,"readwrite",(function(e,a){if(e)return r(e);(e=a.put(n,t)).onsuccess=function(){r()},e.onerror=function(e){r(e)}}))}(P(e),P(t),new Uint8Array(v.subarray(n,n+r)),(function(e){e?s&&Rt(s,a):i&&Rt(i,a)}))},E:function(e,t,n){v.set(v.subarray(t,t+n),e)},F:function(e){if(2147418112<e)return!1;for(var t=Math.max(w.length,16777216);t<e;)t=536870912>=t?B(2*t):Math.min(B((3*t+2147483648)/4),2147418112);e:{try{d.grow(t-g.byteLength+65535>>16),R(d.buffer);var n=1;break e}catch(e){}n=void 0}return!!n},Y:St,x:function(){return 0},K:function(e,t,n,r){try{var a=ne.lc(e),i=ne.hc(a,t,n);return U[r>>2]=i,0}catch(e){return j(e),e.Lb}},D:function(){return 0},M:function(e,t,n,r){try{for(var a=0,i=0;i<n;i++){for(var s=U[t+8*i>>2],o=U[t+(8*i+4)>>2],u=0;u<o;u++)Z(e,v[s+u]);a+=o}return U[r>>2]=a,0}catch(e){return j(e),e.Lb}},R:function(e){return e=new Date(1e3*U[e>>2]),U[7372]=e.getUTCSeconds(),U[7373]=e.getUTCMinutes(),U[7374]=e.getUTCHours(),U[7375]=e.getUTCDate(),U[7376]=e.getUTCMonth(),U[7377]=e.getUTCFullYear()-1900,U[7378]=e.getUTCDay(),U[7381]=0,U[7380]=0,U[7379]=(e.getTime()-Date.UTC(e.getUTCFullYear(),0,1,0,0,0,0))/864e5|0,U[7382]=29536,29488},memory:d,t:function(){},table:f,S:function(e){var t=Date.now()/1e3|0;return e&&(U[e>>2]=t),t}},At=function(){function e(e){t.asm=e.exports,O--,t.monitorRunDependencies&&t.monitorRunDependencies(O),0==O&&V&&(e=V,V=null,e())}function n(t){e(t.instance)}function r(e){return(o||"function"!=typeof fetch?new Promise((function(e){e(Q())})):fetch(H,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+H+"'";return e.arrayBuffer()})).catch((function(){return Q()}))).then((function(e){return WebAssembly.instantiate(e,a)})).then(e,(function(e){c("failed to asynchronously prepare wasm: "+e),j(e)}))}var a={env:Tt,wasi_unstable:Tt};if(O++,t.monitorRunDependencies&&t.monitorRunDependencies(O),t.instantiateWasm)try{return t.instantiateWasm(a,e)}catch(e){return c("Module.instantiateWasm callback failed with error: "+e),!1}return function(){if(o||"function"!=typeof WebAssembly.instantiateStreaming||q()||"function"!=typeof fetch)return r(n);fetch(H,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,a).then(n,(function(e){c("wasm streaming compile failed: "+e),c("falling back to ArrayBuffer instantiation"),r(n)}))}))}(),{}}();t.asm=At;var Lt=t.___wasm_call_ctors=function(){return t.asm.Z.apply(null,arguments)};t._UmbraMeshLoadGetInfo=function(){return t.asm._.apply(null,arguments)},t._UmbraMeshLoadGetSerializedSize=function(){return t.asm.$.apply(null,arguments)},t._UmbraMeshLoadSerialize=function(){return t.asm.aa.apply(null,arguments)},t._UmbraAssetLoadGetType=function(){return t.asm.ba.apply(null,arguments)},t._UmbraTextureLoadGetInfo=function(){return t.asm.ca.apply(null,arguments)},t._UmbraTextureLoadGetSerializedSize=function(){return t.asm.da.apply(null,arguments)},t._UmbraTextureLoadSerialize=function(){return t.asm.ea.apply(null,arguments)},t._UmbraGeodeticToEcef=function(){return t.asm.fa.apply(null,arguments)},t._UmbraEcefToGeodetic=function(){return t.asm.ga.apply(null,arguments)},t._UmbraTextureGetMipmapLevelByteSize=function(){return t.asm.ha.apply(null,arguments)},t._UmbraTextureGetMipmapLevelOffset=function(){return t.asm.ia.apply(null,arguments)};var _t=t._malloc=function(){return t.asm.ja.apply(null,arguments)};t._UmbraMeshLoadFinishExternal=function(){return t.asm.ka.apply(null,arguments)};var xt=t._free=function(){return t.asm.la.apply(null,arguments)};t._UmbraConfigInit=function(){return t.asm.ma.apply(null,arguments)},t._UmbraSetAllocator=function(){return t.asm.na.apply(null,arguments)},t._UmbraSetLogger=function(){return t.asm.oa.apply(null,arguments)},t._UmbraSetHttp=function(){return t.asm.pa.apply(null,arguments)},t._UmbraClientCreate=function(){return t.asm.qa.apply(null,arguments)},t._UmbraClientDestroy=function(){return t.asm.ra.apply(null,arguments)},t._UmbraGetLibraryInfo=function(){return t.asm.sa.apply(null,arguments)},t._UmbraEnvironmentInfoDefaults=function(){return t.asm.ta.apply(null,arguments)},t._UmbraRuntimeCreate=function(){return t.asm.ua.apply(null,arguments)},t._UmbraRuntimeDestroy=function(){return t.asm.va.apply(null,arguments)},t._UmbraRuntimeUpdate=function(){return t.asm.wa.apply(null,arguments)},t._UmbraRuntimeGetStreamingState=function(){return t.asm.xa.apply(null,arguments)},t._UmbraRuntimeNextAssetUnload=function(){return t.asm.ya.apply(null,arguments)},t._UmbraAssetUnloadFinish=function(){return t.asm.za.apply(null,arguments)},t._UmbraAssetUnloadGetType=function(){return t.asm.Aa.apply(null,arguments)},t._UmbraAssetUnloadGetUserPointer=function(){return t.asm.Ba.apply(null,arguments)},t._UmbraRuntimeNextAssetLoad=function(){return t.asm.Ca.apply(null,arguments)},t._UmbraAssetLoadPrepare=function(){return t.asm.Da.apply(null,arguments)},t._UmbraAssetLoadFinish=function(){return t.asm.Ea.apply(null,arguments)},t._UmbraAssetLoadAbortRequested=function(){return t.asm.Fa.apply(null,arguments)},t._UmbraVertexAttributeGetElementByteSize=function(){return t.asm.Ga.apply(null,arguments)},t._UmbraMeshLoadGetData=function(){return t.asm.Ha.apply(null,arguments)},t._UmbraMeshStreamSetBuffers=function(){return t.asm.Ia.apply(null,arguments)},t._UmbraMeshStreamDone=function(){return t.asm.Ja.apply(null,arguments)},t._UmbraMeshStreamNext=function(){return t.asm.Ka.apply(null,arguments)},t._UmbraMaterialLoadGetInfo=function(){return t.asm.La.apply(null,arguments)},t._UmbraTextureLoadGetData=function(){return t.asm.Ma.apply(null,arguments)},t._UmbraTextureMetaDataLoadGetData=function(){return t.asm.Na.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationCount=function(){return t.asm.Oa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassification=function(){return t.asm.Pa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationAmount=function(){return t.asm.Qa.apply(null,arguments)},t._UmbraSceneCreate=function(){return t.asm.Ra.apply(null,arguments)},t._UmbraSceneCreatePublic=function(){return t.asm.Sa.apply(null,arguments)},t._UmbraSceneCreateLocal=function(){return t.asm.Ta.apply(null,arguments)},t._UmbraSceneDestroy=function(){return t.asm.Ua.apply(null,arguments)},t._UmbraSceneGetConnectionStatus=function(){return t.asm.Va.apply(null,arguments)},t._UmbraSceneGetInfo=function(){return t.asm.Wa.apply(null,arguments)},t._UmbraSceneSetTransform=function(){return t.asm.Xa.apply(null,arguments)},t._UmbraSceneCopyCreate=function(){return t.asm.Ya.apply(null,arguments)},t._UmbraSceneCopyDestroy=function(){return t.asm.Za.apply(null,arguments)},t._UmbraSceneCopyGetStatus=function(){return t.asm._a.apply(null,arguments)},t._UmbraSceneCopyGetError=function(){return t.asm.$a.apply(null,arguments)},t._UmbraViewCreate=function(){return t.asm.ab.apply(null,arguments)},t._UmbraViewDestroy=function(){return t.asm.bb.apply(null,arguments)},t._UmbraViewUpdateRendering=function(){return t.asm.cb.apply(null,arguments)},t._UmbraViewUpdateFilter=function(){return t.asm.db.apply(null,arguments)},t._UmbraViewGetCompleted=function(){return t.asm.eb.apply(null,arguments)},t._UmbraViewResetRenderables=function(){return t.asm.fb.apply(null,arguments)},t._UmbraViewNextRenderables=function(){return t.asm.gb.apply(null,arguments)},t._UmbraViewRayQuery=function(){return t.asm.hb.apply(null,arguments)},t._UmbraSendInternalMessage=function(){return t.asm.ib.apply(null,arguments)};var Et=t.___getTypeName=function(){return t.asm.jb.apply(null,arguments)};t.___embind_register_native_and_builtin_types=function(){return t.asm.kb.apply(null,arguments)};var Pt=t.stackSave=function(){return t.asm.lb.apply(null,arguments)},Mt=t.stackAlloc=function(){return t.asm.mb.apply(null,arguments)},Bt=t.stackRestore=function(){return t.asm.nb.apply(null,arguments)},Rt=t.dynCall_vi=function(){return t.asm.ob.apply(null,arguments)};t.dynCall_v=function(){return t.asm.pb.apply(null,arguments)},t.dynCall_iiiiiiiiii=function(){return t.asm.qb.apply(null,arguments)},t.dynCall_viiiiiiiii=function(){return t.asm.rb.apply(null,arguments)},t.dynCall_iiiii=function(){return t.asm.sb.apply(null,arguments)},t.dynCall_iiii=function(){return t.asm.tb.apply(null,arguments)},t.dynCall_iii=function(){return t.asm.ub.apply(null,arguments)},t.dynCall_ii=function(){return t.asm.vb.apply(null,arguments)},t.dynCall_vii=function(){return t.asm.wb.apply(null,arguments)},t.dynCall_iiiiii=function(){return t.asm.xb.apply(null,arguments)},t.dynCall_viiiii=function(){return t.asm.yb.apply(null,arguments)},t.dynCall_iiiiiiii=function(){return t.asm.zb.apply(null,arguments)},t.dynCall_viiiiiii=function(){return t.asm.Ab.apply(null,arguments)},t.dynCall_i=function(){return t.asm.Bb.apply(null,arguments)};var Ft,kt=t.dynCall_viii=function(){return t.asm.Cb.apply(null,arguments)};function It(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function Dt(){function e(){if(!Ft&&(Ft=!0,!h)){if(k(D),k(G),t.onRuntimeInitialized&&t.onRuntimeInitialized(),t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;){var e=t.postRun.shift();W.unshift(e)}k(W)}}if(!(0<O)){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)N();k(I),0<O||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),e()}),1)):e())}}if(t.dynCall_viiii=function(){return t.asm.Db.apply(null,arguments)},t.dynCall_jiji=function(){return t.asm.Eb.apply(null,arguments)},t.dynCall_iidiiii=function(){return t.asm.Fb.apply(null,arguments)},t.dynCall_viiiiii=function(){return t.asm.Gb.apply(null,arguments)},t.asm=At,t.cwrap=function(e,t,n,r){var a=(n=n||[]).every((function(e){return"number"===e}));return"string"!==t&&a&&!r?b(e):function(){return y(e,t,n,arguments)}},t.then=function(e){if(Ft)e(t);else{var n=t.onRuntimeInitialized;t.onRuntimeInitialized=function(){n&&n(),e(t)}}return t},V=function e(){Ft||Dt(),Ft||(V=e)},t.run=Dt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();return Dt(),t.maxBytesDownloaded=0,t.minBytesDownloaded=0,t.URLsDownloaded=new Set([]),t.wgetRequests=bt,e});!function(e){e[e.ColumnMajor=0]="ColumnMajor",e[e.RowMajor=1]="RowMajor",e[e.Count=2]="Count"}(x||(x={})),function(e){e[e.Diffuse=0]="Diffuse",e[e.Normal=1]="Normal",e[e.Specular=2]="Specular",e[e.MetaIndex=3]="MetaIndex",e[e.Count=4]="Count"}(E||(E={})),function(e){e[e.RGBA32=0]="RGBA32",e[e.RGB24=1]="RGB24",e[e.BC1=2]="BC1",e[e.BC3=3]="BC3",e[e.BC4=4]="BC4",e[e.BC5=5]="BC5",e[e.ETC1_RGB=6]="ETC1_RGB",e[e.RGBA_FLOAT32=7]="RGBA_FLOAT32",e[e.UNC1=8]="UNC1",e[e.JPEG=9]="JPEG",e[e.PNG=10]="PNG",e[e.BMP=11]="BMP",e[e.PSD=12]="PSD",e[e.TGA=13]="TGA",e[e.GIF=14]="GIF",e[e.HDR=15]="HDR",e[e.PIC=16]="PIC",e[e.PNM=17]="PNM",e[e.ASTC_4X4=18]="ASTC_4X4",e[e.ASTC_5X4=19]="ASTC_5X4",e[e.ASTC_5X5=20]="ASTC_5X5",e[e.ASTC_6X5=21]="ASTC_6X5",e[e.ASTC_6X6=22]="ASTC_6X6",e[e.ASTC_8X5=23]="ASTC_8X5",e[e.ASTC_8X6=24]="ASTC_8X6",e[e.ASTC_10X5=25]="ASTC_10X5",e[e.ASTC_10X6=26]="ASTC_10X6",e[e.ASTC_8X8=27]="ASTC_8X8",e[e.ASTC_10X8=28]="ASTC_10X8",e[e.ASTC_10X10=29]="ASTC_10X10",e[e.ASTC_12X10=30]="ASTC_12X10",e[e.ASTC_12X12=31]="ASTC_12X12",e[e.ARGB32=32]="ARGB32",e[e.R8=33]="R8",e[e.PVRTC1_RGB4=34]="PVRTC1_RGB4",e[e.PVRTC1_RGBA4=35]="PVRTC1_RGBA4",e[e.UINT8=36]="UINT8",e[e.UINT16=37]="UINT16",e[e.UINT32=38]="UINT32",e[e.RGB565=39]="RGB565",e[e.RG8=40]="RG8",e[e.RG16F=41]="RG16F",e[e.OPENEXR=42]="OPENEXR",e[e.RGBA_FLOAT16=43]="RGBA_FLOAT16",e[e.RGB_FLOAT16=44]="RGB_FLOAT16",e[e.RGB_FLOAT32=45]="RGB_FLOAT32",e[e.BC6H=46]="BC6H",e[e.BC7=47]="BC7",e[e.Count=48]="Count"}(P||(P={})),function(e){e[e.Linear=0]="Linear",e[e.SRGB=1]="SRGB",e[e.Count=2]="Count"}(M||(M={})),function(e){e[e.Position=0]="Position",e[e.TextureCoordinate=1]="TextureCoordinate",e[e.Normal=2]="Normal",e[e.Tangent=3]="Tangent",e[e.Count=4]="Count"}(B||(B={})),function(e){e[e.UncachedMemory=1]="UncachedMemory"}(R||(R={})),function(e){e[e.Debug=0]="Debug",e[e.Info=1]="Info",e[e.Warning=2]="Warning",e[e.Error=3]="Error",e[e.Count=4]="Count"}(F||(F={})),function(e){e[e.Inactive=0]="Inactive",e[e.Active=1]="Active",e[e.Complete=2]="Complete",e[e.Error=3]="Error",e[e.Count=4]="Count"}(k||(k={})),function(e){e[e.Found=0]="Found",e[e.Not_Found=1]="Not_Found",e[e.Transfer_Not_Complete=2]="Transfer_Not_Complete",e[e.Buffer_Too_Small=3]="Buffer_Too_Small",e[e.Count=4]="Count"}(I||(I={})),function(e){e[e.Get=0]="Get",e[e.Post=1]="Post",e[e.Put=2]="Put",e[e.Delete=3]="Delete",e[e.Count=4]="Count"}(D||(D={})),function(e){e[e.Version=0]="Version",e[e.Copyright=1]="Copyright",e[e.BuildTime=2]="BuildTime",e[e.BuildId=3]="BuildId",e[e.Count=4]="Count"}(G||(G={})),function(e){e[e.InvalidUserPointer=0]="InvalidUserPointer"}(z||(z={})),function(e){e[e.None=0]="None",e[e.BC1=1]="BC1",e[e.BC2=2]="BC2",e[e.BC3=4]="BC3",e[e.BC4=8]="BC4",e[e.BC5=16]="BC5",e[e.BC6H=32]="BC6H",e[e.BC7=64]="BC7",e[e.ASTC=128]="ASTC",e[e.ETC1=256]="ETC1",e[e.ETC2=512]="ETC2",e[e.EAC_R=1024]="EAC_R",e[e.EAC_RG=2048]="EAC_RG",e[e.PVRTC1=4096]="PVRTC1",e[e.PVRTC2=8192]="PVRTC2",e[e.ATC=16384]="ATC",e[e.HalfFloat=32768]="HalfFloat",e[e.Float=65536]="Float",e[e.All=2147483647]="All"}(W||(W={})),function(e){e[e.NeverUnload=1]="NeverUnload",e[e.ExclusiveRendering=2]="ExclusiveRendering",e[e.EnableRayQueries=4]="EnableRayQueries"}(N||(N={})),function(e){e[e.Connected=0]="Connected",e[e.Connecting=1]="Connecting",e[e.ConnectionError=2]="ConnectionError",e[e.Count=3]="Count"}(O||(O={})),function(e){e[e.ZeroToOne=0]="ZeroToOne",e[e.MinusOneToOne=1]="MinusOneToOne",e[e.Count=2]="Count"}(V||(V={})),function(e){e[e.Sphere=0]="Sphere",e[e.Cylinder=1]="Cylinder",e[e.None=2]="None",e[e.Count=3]="Count"}(j||(j={})),function(e){e[e.InProgress=0]="InProgress",e[e.Done=1]="Done",e[e.Error=2]="Error",e[e.Count=3]="Count"}(q||(q={})),function(e){e[e.File=0]="File",e[e.Directory=1]="Directory",e[e.FormatObj=3]="FormatObj",e[e.IndexJson=4]="IndexJson",e[e.Count=5]="Count"}(H||(H={})),function(e){e[e.Directory=0]="Directory",e[e.Cloud=1]="Cloud",e[e.Count=2]="Count"}(X||(X={})),function(e){e[e.Material=0]="Material",e[e.Texture=1]="Texture",e[e.Mesh=2]="Mesh",e[e.Count=3]="Count"}(Q||(Q={})),function(e){e[e.Failure=0]="Failure",e[e.OutOfMemory=1]="OutOfMemory",e[e.Aborted=2]="Aborted",e[e.Success=3]="Success",e[e.Count=4]="Count"}($||($={})),function(e){e[e.BackfaceCulling=1]="BackfaceCulling"}(J||(J={}));const Y="Int8",Z="Int16",ee="Int32",te="Uint8",ne="Uint16",re="Uint32",ae="Float32",ie="Float64";class se{constructor(e,t){if(this.workers=[],this.infos=[],this.aborted=!1,window.Worker)for(let n=0;n<e;n++){const e=new Worker(t);e.onmessage=e=>{const{userData:t,resolve:r}=this.infos[n].queue.shift();this.aborted||(e.data.finalResponse?r({buffer:e.data.data,userData:t}):console.error("emscripten_worker_respond_provisionally is not supported"))},e.onerror=e=>{if(console.error(`Worker call failed. Is worker's script URL "${t}" correct? Message:`,e.message),this.infos[n].queue.length>0){const{userData:t,reject:r}=this.infos[n].queue.shift();r({userData:t,error:e})}};const r={queue:[]};this.workers.push(e),this.infos.push(r)}else console.error("WebWorker support required")}destroy(){this.aborted=!0;for(const e of this.workers)e.terminate()}callWorker(e,t,n,r){const a={funcName:t,callbackId:"",data:n};return this.workers[e].postMessage(a,[n.buffer]),new Promise(((t,n)=>{this.infos[e].queue.push({resolve:t,reject:n,userData:r})}))}findMostAvailableWorker(){let e=-1,t=1e9;for(let n=0;n<this.workers.length;n++)this.infos[n].queue.length<t&&(e=n,t=this.infos[n].queue.length);return e}shortestQueueLength(){let e=1e9;for(const t of this.infos)e=Math.min(e,t.queue.length);return e}numLoadsPending(){let e=0;for(const t of this.infos)e+=t.queue.length;return e}numWorkers(){return this.workers.length}}function oe(e){if(!Number.isInteger(e))throw new Error("Value was not integer: "+e.toString())}function ue(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}const le=e=>{const t=new Map([[Y,Int8Array],[Z,Int16Array],[ee,Int32Array],[te,Uint8Array],[ne,Uint16Array],[re,Uint32Array],[ae,Float32Array],[ie,Float64Array]]),n=new Map([[P.RGB565,ne],[P.RGBA32,te],[P.RG8,te],[P.RG16F,ne],[P.RGB_FLOAT32,ae],[P.RGB24,te],[P.UINT32,re]]);class r{constructor(t){if(0===t)throw new Error("Buffer size was zero");if(this.ptr=e.umbraAlloc(t),0===this.ptr)throw new Error(`Allocation of ${t} bytes failed.`);this.size=t}destroy(){e.umbraFree(this.ptr),this.ptr=0,this.size=0}ensureSize(t){if(this.size<t){if(this.destroy(),this.ptr=e.umbraAlloc(t),0===this.ptr)throw new Error(`Buffer growth to ${t} bytes failed.`);this.size=t}}floats(){return new Float32Array(e.HEAPF32.buffer,this.ptr,this.size/4)}bytes(){return new Uint8Array(e.HEAPU8.buffer,this.ptr,this.size)}}class a{constructor(e,n,r){if(this.primitiveToHeap=new Map([[Y,"HEAP8"],[Z,"HEAP16"],[ee,"HEAP32"],[te,"HEAPU8"],[ne,"HEAPU16"],[re,"HEAPU32"],[ae,"HEAPF32"],[ie,"HEAPF64"]]),this.ptr=e,this.size=n,!this.primitiveToHeap.has(r)||!t.has(r))throw new TypeError(`BufferView constructor got invalid type '${r}'`);this.heapName=this.primitiveToHeap.get(r),this.arrayType=t.get(r)}getArray(){return new this.arrayType(e[this.heapName].buffer,this.ptr,this.size/this.arrayType.BYTES_PER_ELEMENT)}}const i=e.getRenderableMemberOffsets();function s(e,t){for(let n=0;n<16;n++)e[n]=t[n]}class o{constructor(){this.configPtr=e.umbraAlloc(e.CONFIG_SIZE),e.configInit(this.configPtr),this.ptr=e.clientCreate("UmbraJS",this.configPtr)}destroy(){e.clientDestroy(this.ptr),e.umbraFree(this.configPtr),this.ptr=0}}class u{constructor(t){this.matrixBuffer=new r(64),this.infoBuffer=new r(e.sceneInfoSize),this.ptr=t}destroy(){this.matrixBuffer.destroy(),this.infoBuffer.destroy(),e.sceneDestroy(this.ptr),this.ptr=0}connectionStatus(){return e.sceneGetConnectionStatus(this.ptr)}getInfo(){return e.sceneGetInfo(this.ptr,this.infoBuffer.ptr),e.deserializeSceneInfo(this.infoBuffer.ptr)}isConnected(){return this.connectionStatus()===O.Connected}setTransform(t){if(!ue(t))throw new TypeError("Matrix should be an array");if(16!==t.length)throw new TypeError("Matrix should be of size 4x4");s(this.matrixBuffer.floats(),t),e.sceneSetTransform(this.ptr,this.matrixBuffer.ptr)}}class l{constructor(e,t){this.ptr=e,this.matrixBuffer=new r(64),this.vectorBuffer=new r(16),this.lightBuffer=new r(384),this.temp=void 0,this.runtimeAssets=t}destroy(){this.matrixBuffer.destroy(),this.vectorBuffer.destroy(),this.lightBuffer.destroy(),this.temp&&this.temp.destroy(),e.viewDestroy(this.ptr),this.ptr=0}setCamera(t,n,r,a=[],i=V.MinusOneToOne,o=x.ColumnMajor){if(!ue(t))throw new TypeError("Camera matrix should be an array");if(!ue(n))throw new TypeError("Position should be an array");if("number"!=typeof r)throw new TypeError("Quality should be a number");if(16!==t.length)throw new TypeError("WorldToClip matrix should be of size 4x4");if(3!==n.length)throw new TypeError("Position vector should be of length 3");var u,l;if(s(this.matrixBuffer.floats(),t),u=this.vectorBuffer.floats(),l=n,u[0]=l[0],u[1]=l[1],u[2]=l[2],a){if(a.length>32)throw new Error("Too many lights given");const e=this.lightBuffer.floats();for(let t=0;t<a.length;t++)e[3*t+0]=a[t][0],e[3*t+1]=a[t][1],e[3*t+2]=a[t][2]}e.viewUpdateRendering(this.ptr,this.matrixBuffer.ptr,this.vectorBuffer.ptr,i,o,r,this.lightBuffer.ptr,a.length)}getVisible(t){oe(t);const n=t*e.renderableSize;(!this.temp||this.temp.size<n)&&(this.temp&&this.temp.destroy(),this.temp=new r(n));const a=this.temp,s=e.renderableSize/4,o=n/4;oe(s),oe(o);const u=(e,t,n,r)=>(oe(r/4),new e(t.buffer,n+r,o-r/4)),l=u(Uint32Array,e.HEAPU32,a.ptr,i.mesh),c=u(Int32Array,e.HEAP32,a.ptr,i.lodLevel),m=u(Uint32Array,e.HEAPU32,a.ptr,i.visibilityMask),d=u(Uint32Array,e.HEAPU32,a.ptr,i.scene),f=e.viewNextRenderables(this.ptr,a.ptr,t),h=[];for(let e=0;e<f;e++){const t=l[s*e],n=c[s*e],r=m[s*e],a=d[s*e];h.push({id:t,mesh:this.runtimeAssets.get(t),lod:n,mask:r,scenePtr:a})}return h}}class c{constructor(t,n){this.ptr=t,this.assetType=e.assetLoadGetType(this.ptr),this.type="Load"+Q[this.assetType],this.data={},this.assetUserPointer=n}prepare(){e.assetLoadPrepare(this.ptr,this.assetUserPointer)}finish(t){e.assetLoadFinish(this.ptr,t)}}class m{constructor(t){this.ptr=t,this.assetType=e.assetUnloadGetType(this.ptr),this.type="Unload"+Q[this.assetType],this.userPointer=e.assetUnloadGetUserPointer(this.ptr)}finish(){e.assetUnloadFinish(this.ptr)}}class d{constructor(t,{features:n={textureSupportMask:0,formats:[],srgb:!1,halfFloat:!1},flags:a=0},{workerScriptURL:i,numWorkers:s=0}){this.assets=new Map,this.nextId=1,this.tempTextureBuffer=new r(1048576),this.tempStreamingStateBuffer=new r(e.streamingStateSize),this.tempDispatchBuffer=new r(1),this.stats={numUpdates:0,meshPipelineMemoryUse:0,texturePipelineMemoryUse:0,numWorkerLoadsPending:0,perFrameLoadedTextures:0,perFrameLoadedTextureBytes:0,perFrameLoadedMeshes:0,perFrameLoadedMeshBytes:0,numInstantUnloads:0,assetLoadTimes:new Map},this.limits={streamingPipeSizeLimit:1<<19,maxWorkQueueLength:10},this.loadPromises=new Map;const o=W.ETC1|W.ASTC|W.PVRTC1|W.BC5;let u=n.textureSupportMask;u&o||(u|=W.BC5|W.BC4),this.client=t;const l=e.serializeEnvironmentInfo({textureSupportFlags:u,localCacheDirectory:null,localCacheMaximumByteSize:0},0);this.ptr=e.runtimeCreate(t.ptr,l,a),e.umbraFree(l),this.platformFeatures=n;const c=Math.max(e.meshInfoSize,e.materialInfoSize,e.textureInfoSize,e.byteBufferSize);this.scratch=new r(c),this.debug={textureFormatsInUse:new Set,platformFeatures:n,trackInstantUnloads:!1},0==s&&(s=Math.min(Math.max(1,("hardwareConcurrency"in navigator?navigator.hardwareConcurrency:1)-2),8)),this.workerPool=new se(s,i)}destroy(){this.workerPool.destroy(),this.tempTextureBuffer.destroy(),this.tempStreamingStateBuffer.destroy(),this.tempDispatchBuffer.destroy(),this.scratch.destroy(),e.runtimeDestroy(this.ptr),this.client.destroy(),this.ptr=0}createScenePublic(t){const n=e.sceneCreatePublic(this.ptr,t);if(n)return new u(n)}createScene(t,n){const r=e.sceneCreate(this.ptr,t,n);if(r)return new u(r)}createSceneLocal(t){const n=e.sceneCreateLocal(this.ptr,t);if(n)return new u(n)}setHandlers(e){this.handlers=e}createView(){const t=e.viewCreate(this.ptr);return new l(t,this.assets)}update(){e.runtimeUpdate(this.ptr)}*getAssetUnloads(){let t=e.runtimeNextAssetUnload(this.ptr);for(;0!==t;){const n=new m(t);n.data=this.assets.get(n.userPointer),yield n,t=e.runtimeNextAssetUnload(this.ptr)}}async dispatchTextureLoad(t){const r=this.scratch.ptr;e.textureLoadGetInfo(t.ptr,r);const i=e.deserializeTextureInfo(r),s=this.formatNeedsTranscoding(i.format);let o;t.prepare();let u=0;if(s){const r=e.textureLoadGetSerializedSize(t.ptr),i=r+e.textureLoadDispatchHeaderSize;this.tempDispatchBuffer.ensureSize(i);const s=this.tempDispatchBuffer;if(void 0===e.convertAssetLoadToTextureDispatch(t.ptr,t.assetUserPointer,this.platformFeatures.textureSupportMask,this.platformFeatures.srgb,s.ptr,i))throw t.finish($.Failure),new Error("convertAssetLoadToTextureDispatch failed");const l=2*i;this.stats.texturePipelineMemoryUse+=l;const c=this.workerPool.findMostAvailableWorker();let m;try{({buffer:m}=await this.workerPool.callWorker(c,"loadTexture",new Uint8Array(s.bytes()),{load:t,memoryUse:l}))}catch({error:e}){throw t.finish($.Failure),e}this.stats.texturePipelineMemoryUse-=l,this.stats.perFrameLoadedTextures+=1,this.stats.perFrameLoadedTextureBytes+=r,u=e.umbraAlloc(m.byteLength),e.HEAP8.set(m,u),m=void 0;const d=e.deserializeTextureLoadResult(u).textureInfo;let f=te;n.has(d.format)?f=n.get(d.format):console.warn("Used default datatype for texture format "+P[d.format]);o={info:d,buffer:new a(u+e.textureLoadResultHeaderSize,d.dataByteSize,f)}}else{const n=this.tempTextureBuffer;if(n.ensureSize(i.dataByteSize),e.serializeByteBuffer({ptr:n.ptr,byteSize:i.dataByteSize,flags:0},this.scratch.ptr),!e.textureLoadGetData(t.ptr,this.scratch.ptr))throw t.finish($.Failure),new Error(`textureLoadGetData failed: ${t.ptr}, ${n.ptr}, ${i.dataByteSize}/${n.size}`);o={info:i,buffer:new a(n.ptr,i.dataByteSize,te)}}try{const n=this.handlers.LoadTexture(o,t.assetUserPointer);return t.finish(n),n===$.Success&&(this.debug.textureFormatsInUse.add(o.info.format),this.debug.trackInstantUnloads&&this.stats.assetLoadTimes.set(t.assetUserPointer,this.stats.numUpdates)),n}catch(e){throw t.finish($.Failure),console.error(e),e}finally{u>0&&e.umbraFree(u)}}async dispatchMaterialLoad(t){t.prepare(),e.materialLoadGetInfo(t.ptr,this.scratch.ptr);const n=e.deserializeMaterialInfo(this.scratch.ptr),r=n.textures.filter((t=>t!==e.INVALID_USERPOINTER)),a=r.map((e=>this.loadPromises.get(e))).map((e=>e.catch((e=>e)))),i=await Promise.all(a);r.forEach((e=>this.loadPromises.delete(e)));for(const e of i)if(e instanceof Error)throw t.finish($.Failure),e;const s=i;for(const e of s)if(e!==$.Success)return t.finish($.Aborted),$.Aborted;const o=r.map((e=>this.assets.get(e))),u={transparent:n.transparent,textures:o};try{const e=this.handlers.LoadMaterial(u,t.assetUserPointer);return t.finish(e),e}catch(e){throw t.finish($.Failure),console.error(e),e}}async dispatchMeshLoad(t){e.meshLoadGetInfo(t.ptr,this.scratch.ptr);const n=e.deserializeMeshInfo(this.scratch.ptr);t.prepare();const r=e.meshLoadGetSerializedSize(t.ptr),i=e.meshLoadDispatchHeaderSize+r;this.tempDispatchBuffer.ensureSize(i);const s=this.tempDispatchBuffer;0!=(15&s.ptr)&&console.error("buf.ptr wasn't aligned: "+s.ptr);const o=e.convertAssetLoadToMeshDispatch(t.ptr,t.assetUserPointer,s.ptr,i),u=n.material,l=this.loadPromises.get(u);if(void 0===l)throw t.finish($.Failure),new Error(`Material UserPointer ${u} didn't have a promise!`);const c=i+o.byteSize+e.meshLoadResultHeaderSize;this.stats.meshPipelineMemoryUse+=c;const m=this.workerPool.findMostAvailableWorker();let d;try{({buffer:d}=await this.workerPool.callWorker(m,"loadMesh",new Uint8Array(s.bytes()),{}))}catch({error:e}){throw t.finish($.Failure),e}finally{this.stats.meshPipelineMemoryUse-=c,this.stats.perFrameLoadedMeshes+=1,this.stats.perFrameLoadedMeshBytes+=r}const f=d.length*d.BYTES_PER_ELEMENT,h=e.umbraAlloc(f);e.HEAP8.set(d,h),d=void 0;const p=e.deserializeMeshLoadResult(h);let b,y=!1;if(p.result!==$.Success&&(b="Asset load failed with "+$[p.result],y=!0),p.assetLoad!==t.ptr&&(b=`Asset load ptr didn't match ${p.assetLoad} vs ${t.ptr}`,y=!0),y)throw e.umbraFree(h),t.finish($.Failure),Error(b);const g=h+e.meshLoadResultHeaderSize,w=e.meshLoadResultBuildUmbraBuffers(h,g),v={position:ae,uv:ae,normal:ae,tangent:ae,index:2===w.index.elementByteSize?ne:re},S={};for(const e of Object.keys(w)){const t={},n=w[e],r=n.elementCapacity*n.elementStride;t.data=new a(n.ptr,r,v[e]),t.desc=n,S[e]=t}let C=$.Failure;try{C=await l}catch(n){throw t.finish($.Aborted),e.umbraFree(h),n}if(C!==$.Success)return t.finish($.Aborted),e.umbraFree(h),$.Aborted;const U=this.assets.get(u);if(void 0===U)throw t.finish($.Aborted),e.umbraFree(h),new Error(`Material ${u} had no asset object.`);const T={buffers:S,material:U,bounds:[n.bounds.mn,n.bounds.mx]};let A=$.Failure;try{if(A=this.handlers.LoadMesh(T,t.assetUserPointer),A!==$.Success)return t.finish(A),A;e.meshLoadFinishExternalWithLoadResultHeader(t.ptr,h,g)}catch(e){throw t.finish($.Failure),e}finally{e.umbraFree(h)}return A}loadAssets(t){const n=performance.now();for(const e of this.getAssetUnloads()){if(this.debug.trackInstantUnloads){const t=this.stats.assetLoadTimes.get(e.userPointer);this.stats.numUpdates-t<3&&(this.stats.numInstantUnloads+=1)}const r=this.assets.get(e.userPointer);if(this.loadPromises.delete(e.userPointer),this.handlers[e.type](r,e.userPointer),e.finish(),performance.now()-n>t)break}do{const t=e.runtimeNextAssetLoad(this.ptr);if(0===t)break;let n;const r=new c(t,this.getNextUserPointer());"LoadTexture"===r.type?n=this.dispatchTextureLoad(r):"LoadMaterial"===r.type?n=this.dispatchMaterialLoad(r):"LoadMesh"===r.type&&this.dispatchMeshLoad(r),void 0!==n&&this.loadPromises.set(r.assetUserPointer,n);const a=this.stats.meshPipelineMemoryUse+this.stats.texturePipelineMemoryUse,i=this.workerPool.shortestQueueLength();if(i>0&&a>=this.limits.streamingPipeSizeLimit)break;if(i>=this.limits.maxWorkQueueLength)break}while(performance.now()-n<t);this.stats.numUpdates+=1,this.stats.numWorkerLoadsPending=this.workerPool.numLoadsPending(),this.stats.perFrameLoadedTextures=0,this.stats.perFrameLoadedTextureBytes=0,this.stats.perFrameLoadedMeshes=0,this.stats.perFrameLoadedMeshBytes=0}getNextUserPointer(){const e=this.nextId;return this.nextId=this.nextId+1|0,0===this.nextId&&(this.nextId=1),e}addAsset(e,t){this.assets.set(e,t)}removeAsset(e){this.assets.has(e)&&this.assets.delete(e)}formatNeedsTranscoding(e){const t=this.platformFeatures.textureSupportMask;switch(e){case P.BC1:if(t&W.BC1)return!1;break;case P.BC3:if(t&W.BC3)return!1;break;case P.BC4:if(t&W.BC4)return!1;break;case P.BC5:if(t&W.BC5)return!1;break;default:return!1}return!0}getStreamingState(){return e.runtimeGetStreamingState(this.ptr,this.tempStreamingStateBuffer.ptr),e.deserializeStreamingState(this.tempStreamingStateBuffer.ptr)}getStreamingProgress(){const e=this.getStreamingState();return 0==e.numResidentTiles?0:e.numResidentTilesLoaded/e.numResidentTiles}getNumberOfWorkers(){return this.workerPool.numWorkers()}}return{createRuntime:t=>new d(new o,t,e.umbraLibraryConfig)}};let ce="";if("undefined"!=typeof document&&document.currentScript){const e=document.currentScript.src;"undefined"!==e&&(ce=e.substr(0,e.lastIndexOf("/")+1))}const me=function(e){const t={wasmURL:ce+"umbra.wasm",workerScriptURL:ce+"UmbraAssetWorker.js"};return e=Object.assign(t,e),new Promise(((t,n)=>{try{K({locateFile:(t,n)=>t.endsWith("umbra.wasm")?e.wasmURL:n+t}).then((r=>{delete r.then,r.onAbort=e=>{n(e)},function(e){Object.assign(e,{configInit:e.cwrap("UmbraConfigInit",null,["number"]),clientCreate:e.cwrap("UmbraClientCreate","number",["string","number"]),clientDestroy:e.cwrap("UmbraClientDestroy",null,["number"]),getLibraryInfo:e.cwrap("UmbraGetLibraryInfo","string",["number"]),environmentInfoDefaults:e.cwrap("UmbraEnvironmentInfoDefaults",null,["number"]),runtimeCreate:e.cwrap("UmbraRuntimeCreate","number",["number","number","number"]),runtimeUpdate:e.cwrap("UmbraRuntimeUpdate",null,["number"]),runtimeGetStreamingState:e.cwrap("UmbraRuntimeGetStreamingState",null,["number","number"]),runtimeDestroy:e.cwrap("UmbraRuntimeDestroy",null,["number"]),sceneCreate:e.cwrap("UmbraSceneCreate","number",["number","string","string"]),sceneCreatePublic:e.cwrap("UmbraSceneCreatePublic","number",["number","string"]),sceneCreateLocal:e.cwrap("UmbraSceneCreateLocal","number",["number","string"]),sceneGetConnectionStatus:e.cwrap("UmbraSceneGetConnectionStatus","number",["number"]),sceneGetInfo:e.cwrap("UmbraSceneGetInfo","number",["number","number"]),sceneSetTransform:e.cwrap("UmbraSceneSetTransform",null,["number","number"]),sceneDestroy:e.cwrap("UmbraSceneDestroy",null,["number"]),viewCreate:e.cwrap("UmbraViewCreate","number",["number"]),viewUpdateRendering:e.cwrap("UmbraViewUpdateRendering",null,["number","number","number","number","number","number","number","number"]),viewUpdateFilter:e.cwrap("UmbraViewUpdateFilter",null,["number","number"]),viewGetCompleted:e.cwrap("UmbraViewGetCompleted","number",["number"]),viewNextRenderables:e.cwrap("UmbraViewNextRenderables","number",["number","number","number"]),viewResetRenderables:e.cwrap("UmbraViewResetRenderables",null,["number"]),viewDestroy:e.cwrap("UmbraViewDestroy",null,["number"]),viewRayQuery:e.cwrap("UmbraViewRayQuery","number",["number","number","number","number","number","number"]),sceneCopyCreate:e.cwrap("UmbraSceneCopyCreate","number",["number","number","number","number","number"]),sceneCopyGetStatus:e.cwrap("UmbraSceneCopyGetStatus","number",["number","number"]),sceneCopyGetError:e.cwrap("UmbraSceneCopyGetError","string",["number"]),sceneCopyDestroy:e.cwrap("UmbraSceneCopyDestroy",null,["number"]),vertexAttributeGetElementByteSize:e.cwrap("UmbraVertexAttributeGetElementByteSize","number",["number"]),runtimeNextAssetLoad:e.cwrap("UmbraRuntimeNextAssetLoad","number",["number"]),assetLoadGetType:e.cwrap("UmbraAssetLoadGetType","number",["number"]),assetLoadPrepare:e.cwrap("UmbraAssetLoadPrepare",null,["number","number"]),assetLoadAbortRequested:e.cwrap("UmbraAssetLoadAbortRequested","number",["number"]),assetLoadFinish:e.cwrap("UmbraAssetLoadFinish",null,["number","number"]),meshLoadFinishExternal:e.cwrap("UmbraMeshLoadFinishExternal",null,["number","number","number","number"]),meshLoadGetInfo:e.cwrap("UmbraMeshLoadGetInfo",null,["number","number"]),meshLoadGetData:e.cwrap("UmbraMeshLoadGetData","number",["number","number","number"]),meshStreamSetBuffers:e.cwrap("UmbraMeshStreamSetBuffers","number",["number","number","number"]),meshStreamNext:e.cwrap("UmbraMeshStreamNext","number",["number","number","number"]),meshStreamDone:e.cwrap("UmbraMeshStreamDone","number",["number"]),meshLoadGetSerializedSize:e.cwrap("UmbraMeshLoadGetSerializedSize","number",["number"]),textureGetMipmapLevelByteSize:e.cwrap("UmbraTextureGetMipmapLevelByteSize","number",["number","number"]),textureGetMipmapLevelOffset:e.cwrap("UmbraTextureGetMipmapLevelOffset","number",["number","number"]),textureLoadGetInfo:e.cwrap("UmbraTextureLoadGetInfo",null,["number","number"]),textureLoadGetData:e.cwrap("UmbraTextureLoadGetData","number",["number","number"]),textureLoadGetSerializedSize:e.cwrap("UmbraTextureLoadGetSerializedSize","number",["number"]),textureMetaDataLoadGetData:e.cwrap("UmbraTextureMetaDataLoadGetData","number",["number","number"]),textureMetaDataGetClassificationCount:e.cwrap("UmbraTextureMetaDataGetClassificationCount","number",["number","number"]),textureMetaDataGetClassification:e.cwrap("UmbraTextureMetaDataGetClassification","number",["number","number","number"]),textureMetaDataGetClassificationAmount:e.cwrap("UmbraTextureMetaDataGetClassificationAmount","number",["number","number","number"]),materialLoadGetInfo:e.cwrap("UmbraMaterialLoadGetInfo",null,["number","number"]),runtimeNextAssetUnload:e.cwrap("UmbraRuntimeNextAssetUnload","number",["number"]),assetUnloadGetType:e.cwrap("UmbraAssetUnloadGetType","number",["number"]),assetUnloadGetUserPointer:e.cwrap("UmbraAssetUnloadGetUserPointer","number",["number"]),assetUnloadFinish:e.cwrap("UmbraAssetUnloadFinish",null,["number"]),sendInternalMessage:e.cwrap("UmbraSendInternalMessage","number",["number","number"])})}(r),t(function(e,t){const n={getPlatformFeatures:e=>{let t=0;const n=new Set;let r=!1,a=!1;const i=new Map([]),s=[],o=e.getSupportedExtensions();for(const e of o){const t=e.replace(/^(.*)_WEBGL_/,"WEBGL_");i.set(t,e),s.push(t)}const u=new Map([["WEBGL_compressed_texture_s3tc",{mask:W.BC1|W.BC2|W.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_s3tc_srgb",{mask:W.BC1|W.BC2|W.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_rgtc",{mask:W.BC4|W.BC5,names:["bc4","bc5"]}],["WEBGL_compressed_texture_pvrtc",{mask:W.PVRTC1,names:["pvrtc1_rgb4","pvrtc1_rgba4"]}],["WEBGL_compressed_texture_etc1",{mask:W.ETC1,names:["etc1_rgb"]}],["WEBGL_compressed_texture_astc",{mask:W.ASTC,names:["astc_4x4"]}]]);for(const r of u.keys())if(s.includes(r)){e.getExtension(i.get(r));const a=u.get(r);t|=a.mask,a.names.forEach((e=>n.add(e)))}return s.includes("WEBGL_compressed_texture_s3tc_srgb")&&(r=!0),s.includes("EXT_sRGB")&&(e.getExtension(i.get("EXT_sRGB")),r=!0),s.includes("OES_texture_half_float")&&(e.getExtension(i.get("OES_texture_half_float")),a=!0),{textureSupportMask:t,formats:[...n],srgb:r,halfFloat:a}}};return n.nativeModule=e,n.nativeModule.umbraLibraryConfig=t,n.createRuntime=le(e).createRuntime,n.getStreamingInfo=()=>({minBytesDownloaded:n.nativeModule.minBytesDownloaded,maxBytesDownloaded:n.nativeModule.maxBytesDownloaded}),n.getLibraryInfo=()=>({version:e.getLibraryInfo(G.Version),copyright:e.getLibraryInfo(G.Copyright),buildTime:e.getLibraryInfo(G.BuildTime),buildID:e.getLibraryInfo(G.BuildId)}),n.abortDownloads=()=>{Object.values(e.wgetRequests).forEach((e=>{e.abort()}))},n}(r,e))}))}catch(e){n(e)}}))};function de(e,t,n){return{format:e,type:t,compressed:n}}const fe={[P.RGB24]:de(r,e,!1),[P.RGBA32]:de(t,e,!1),[P.RGB565]:de(r,n,!1),[P.RG8]:de(a,e,!1),[P.RG16F]:de(a,i,!1),[P.BC1]:de(s,e,!0),[P.BC3]:de(o,e,!0),[P.ETC1_RGB]:de(u,e,!0),[P.ASTC_4X4]:de(l,e,!0),[P.PVRTC1_RGB4]:de(c,e,!0)};class he{constructor(e){this.flipTangent=!1,this.defines="",e.indexOf("bc3")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC3\n"),e.indexOf("bc5")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC5\n"),e.indexOf("astc_4x4")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_ASTC\n")}process(e,t){let n=e.fragmentShader;this.flipTangent&&(n="#define UMBRA_FLIP_TANGENT\n"+n),n=this.defines+n,n=n.replace("#include <normal_fragment_maps>","\n#ifdef USE_NORMALMAP\n#ifdef USE_TANGENT\n\nvec3 tangentToWorld2 = normal;\nvec3 tangentToWorld0 = normalize(tangent - tangentToWorld2 * dot(tangentToWorld2, tangent));\n\n#ifdef UMBRA_FLIP_TANGENT\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld0, tangentToWorld2));\n#else\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld2, tangentToWorld0));\n#endif\n\n#if defined(UMBRA_TEXTURE_SUPPORT_BC5) || defined(UMBRA_TEXTURE_SUPPORT_ASTC)\nnormal.xy = texture2D(normalMap, vUv).xy * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#elif defined(UMBRA_TEXTURE_SUPPORT_BC3)\nnormal.xy = texture2D(normalMap, vUv).yw * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#else\nnormal.xyz = texture2D(normalMap, vUv).xyz;\nnormal.xy *= 2.0;\nnormal.xy -= 1.0;\nnormal = normalize(normal);\n#endif\n\nnormal = tangentToWorld0 * normal.x + tangentToWorld1 * normal.y + tangentToWorld2 * normal.z;\nnormal = normalize(normal);\n#endif\n#endif\n\n"),n=n.replace("#include <metalnessmap_fragment>","\nfloat metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness = texture2D( metalnessMap, vUv );\nmetalnessFactor *= texelMetalness.r;\n#endif\n"),n=n.replace("#include <roughnessmap_fragment>","\nfloat roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness = texture2D( roughnessMap, vUv );\nfloat roughness = 1.0 - texelRoughness.g;\nroughnessFactor *= roughness;\n#endif\n"),e.fragmentShader=n}}class pe{constructor(){this.usedList=[],this.freeList=[]}allocate(e,t){let n;if(this.freeList.length>0)if(void 0===t)n=this.freeList.pop();else for(let e=0;e<this.freeList.length;e++){const r=this.freeList[e];if(t(r)){n=r,this.freeList.splice(e,1);break}}return n||(n=e()),this.usedList.push(n),n}freeAll(e){for(let t=0;t<this.usedList.length;t++)e&&e(this.usedList[t]),this.freeList.push(this.usedList[t]);this.usedList.length=0}clear(){this.usedList.length=0,this.freeList.length=0}}class be extends m{constructor(e,t,n,r,a,i){super(),this.material=new d,this.wireframe=!1,this.freeze=!1,this.isLOD=!0,this.autoUpdate=!0,this.name="UmbraScene",this.materialPool=new pe,this.stats={numVisible:0,numShadowCasters:0,numCachedMaterials:0,numAssets:0},this.diagnostics={missingNormals:{checked:!1,message:"UmbraScene has no normals so it will appear black."},deprecatedMaterial:{checked:!1,message:"Property umbraScene.opaqueMaterial has been deprecated. Use umbraScene.material instead."},report:e=>{this.diagnostics[e].checked||(this.diagnostics[e].checked=!0,console.warn(this.diagnostics[e].message))}},this.oldState={status:void 0,visibleIDs:new Set},this.update=function(e){if(this.freeze)return;if(0===this.umbra.nativeScene.ptr)return void console.warn("Renderer tried to update a disposed UmbraScene");let t=this.sharedState.cameraToView.get(e);if(t||(t=this.umbra.runtime.createView(),this.sharedState.cameraToView.set(e,t)),this.sharedState.viewLastUseFrame.set(t,this.renderer.info.render.frame),this.umbra.nativeScene.setTransform(this.matrixWorld.elements),this.isPBREnabled()){const e=this.matrixWorld.determinant()<0;e!==this.shaderPatcher.flipTangent&&(this.shaderPatcher.flipTangent=e,this.materialPool.clear())}this.stats.numVisible=0,this.stats.numAssets=this.umbra.runtime.assets.size;const n=[];for(let e=0;e<this.children.length;e++)this.children[e].isUmbraMesh||n.push(this.children[e]);this.children=n;const r=[],a=new m;a.isLOD=!0,a.autoUpdate=!0,a.update=e=>{this.children.pop();for(let e=0;e<r.length;e++)this.children.push(r[e])},this.materialPool.freeAll((e=>{delete e.map,delete e.normalMap,delete e.metalnessMap,delete e.roughnessMap}));let i=[];const s=new Set;this.sharedState.viewRenderables.has(t)&&(i=this.sharedState.viewRenderables.get(t));for(let e=0;e<i.length;e++){if(i[e].scenePtr!==this.umbra.nativeScene.ptr)continue;const{materialDesc:t,geometry:n}=i[e].mesh;s.add(i[e].id),this.stats.numVisible+=1;const a=t.transparent||this.material.transparent,o=this.materialPool.allocate((()=>this.material.clone()),(e=>e.transparent===a));o.wireframe=this.wireframe,o.opacity=this.material.opacity,o.transparent=a,o.onBeforeCompile=(e,t)=>{this.material.onBeforeCompile&&this.material.onBeforeCompile.apply(o,[e,t]),this.shaderPatcher.process(e,t)};const u=t.textures[E.Diffuse],l=t.textures[E.Normal],c=t.textures[E.Specular];u&&u.isTexture&&(o.map=u),l&&l.isTexture&&(o.normalMap=l,o.vertexTangents=!0,o.normalMapType=f),c&&c.isTexture&&(o.metalnessMap=c,o.metalness=1,o.roughnessMap=c,o.roughness=1);const m=new h(n,o);m.isUmbraMesh=!0,m.matrixWorld.copy(this.matrixWorld),m.castShadow=this.castShadow,m.receiveShadow=this.receiveShadow,m.visible=!0,this.children.push(m),0==(1&i[e].mask)?(r.push(m),m.frustumCulled=!0):(this.children.push(m),m.frustumCulled=!1)}if(!this.diagnostics.missingNormals.checked&&this.isPBREnabled())for(let e=0;e<this.children.length;e++)if(this.children[e].isUmbraMesh&&!("normal"in this.children[e].geometry.attributes)){this.diagnostics.report("missingNormals");break}this.stats.numShadowCasters=r.length,this.stats.numCachedMaterials=this.materialPool.usedList.length+this.materialPool.freeList.length,r.length>0&&this.children.push(a),this.updateStreamingEvents(s)},this.renderer=r,this.sharedState=n,this.shaderPatcher=new he(a.formats),this.onDispose=i,this.scale.set(1,1,-1),this.umbra={runtime:e,nativeScene:t}}set quality(e){console.error("UmbraScene.quality is not supported any more. Use camera.umbraQuality instead.")}get opaqueMaterial(){return this.diagnostics.report("deprecatedMaterial"),this.material}set opaqueMaterial(e){this.diagnostics.report("deprecatedMaterial"),this.material=e}getInfo(){const e={connected:this.umbra.nativeScene.isConnected()};return e.connected&&(e.sceneInfo=this.umbra.nativeScene.getInfo()),Object.assign(e,this.stats),e}getBounds(){if(!this.umbra.nativeScene.isConnected())return;const e=this.umbra.nativeScene.getInfo().bounds,t=e.mn,n=e.mx;return new p(new b(t[0],t[1],t[2]),new b(n[0],n[1],n[2]))}getCenter(){const e=this.getBounds();e.applyMatrix4(this.matrixWorld);const t=new b;return e.getCenter(t),t}updateStreamingEvents(e){const t=this.oldState.visibleIDs,n=e;if(this.onMeshChanged)if(t.size!==n.size)this.onMeshChanged();else for(const e of n)if(!t.has(e)){this.onMeshChanged();break}this.oldState.visibleIDs=e}updateNetworkEvents(){const e=this.umbra.nativeScene.connectionStatus();if(this.oldState.status!==e)switch(this.onConnectionChanged&&this.onConnectionChanged(e),e){case O.ConnectionError:this.onConnectionError&&this.onConnectionError("Could not connect");break;case O.Connected:this.onConnected&&this.onConnected();break;case O.Connecting:this.onDisconnected&&this.onDisconnected()}this.oldState.status=e}dispose(){this.onDispose&&this.onDispose(this),this.children=this.children.filter((e=>!e.isUmbraMesh)),this.materialPool.freeAll((e=>e.dispose())),this.umbra.nativeScene.destroy()}isPBREnabled(){return"normalMapType"in this.material}}class ye extends y{constructor(e,t){super(t),this.Umbra=e}loadPublic(e,t,n,r){const a=this.Umbra.createScenePublic(e);r&&(a.onConnectionError=e=>{r(e)}),a.onConnected=()=>{delete a.onConnectionError,n&&n(1),t(a)}}}class ge{constructor(e,t){let n;this.memoryLimit=524288e3,this.downloadLimit=0,this.qualityFactor=1,this.updateTask=void 0,this.assetSizes=new Map,this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.lastQualityLowerFrame=-1,this.umbraScenes=new Set,this.oldState={progress:0,downloadLimitReached:!1},this.sharedState={cameraToView:new Map,viewRenderables:new Map,viewLastUseFrame:new Map},this.tempVector=new b,this.dirVector=new b,this.matrixWorldInverse=new g,this.projScreenMatrix=new g,this.cameraWorldPosition=new b,this.handlers={LoadMaterial:(e,t)=>{const n=e;return n.transparent=!!e.transparent,this.runtime.addAsset(t,n),$.Success},UnloadMaterial:(e,t)=>{this.runtime.removeAsset(t)},LoadTexture:(e,t)=>{const n=e.info,r=e.buffer;let a;if(fe.hasOwnProperty(n.format)&&(a=fe[n.format]),!a)return n.format!==P.UINT32&&console.log("Unknown texture format",P[n.format]),this.runtime.addAsset(t,{isTexture:!1}),$.Success;if(!this.canFitInMemory(r.size))return this.adjustQuality(.8),$.OutOfMemory;const i=this.makeTexture(n,r,a);let s=!1;return"outputEncoding"in this.renderer?s=this.renderer.outputEncoding===w:"gammaOutput"in this.renderer&&(s=this.renderer.gammaOutput),n.type!==E.Diffuse||s?i.encoding=n.colorSpace===M.Linear?v:w:i.encoding=v,i.needsUpdate=!0,this.textureMemoryUsed+=r.size,this.assetSizes.set(i,r.size),this.runtime.addAsset(t,i),$.Success},UnloadTexture:(e,t)=>{e.isTexture&&e.dispose(),this.assetSizes.has(e)&&(this.textureMemoryUsed-=this.assetSizes.get(e),this.assetSizes.delete(e)),this.runtime.removeAsset(t)},LoadMesh:(e,t)=>{const n={position:{components:3},normal:{components:3},uv:{components:2},tangent:{components:3}};let r=0;if(Object.keys(n).map((t=>e.buffers[t])).forEach((e=>{e&&(r+=e.data.size)})),!this.canFitInMemory(r))return this.adjustQuality(.8),$.OutOfMemory;const a=new S,i=e.buffers.index.data.getArray(),s=Array.from(i);a.setIndex(s),a.boundingSphere=function(e){const t=e[0],n=e[1],r=new b(n[0]-t[0],n[1]-t[1],n[2]-t[2]),a=new b(t[0]+.5*r.x,t[1]+.5*r.y,t[2]+.5*r.z);return new C(a,r.length())}(e.bounds),Object.keys(n).forEach((t=>{const r=e.buffers[t];if(r){const e=r.data.getArray(),i=new U(e.slice(),n[t].components);"setAttribute"in a?a.setAttribute(t,i):a.addAttribute(t,i)}}));const o={geometry:a,materialDesc:e.material};return this.meshMemoryUsed+=r,this.assetSizes.set(o,r),this.runtime.addAsset(t,o),$.Success},UnloadMesh:(e,t)=>{this.assetSizes.has(e)&&(this.meshMemoryUsed-=this.assetSizes.get(e),this.assetSizes.delete(e)),this.runtime.removeAsset(t),e.geometry.dispose()}},n="getContext"in t?t.getContext():t.context;const r=e.getPlatformFeatures(n);r.textureSupportMask&=~W.BC5,this.umbrajs=e,this.runtime=e.createRuntime({features:r}),this.runtime.setHandlers(this.handlers),this.renderer=t,this.features=r,this.startEventUpdate(1e3/60)}get memoryUsed(){return this.textureMemoryUsed+this.meshMemoryUsed}startEventUpdate(e){this.stopEventUpdate(),this.updateTask=window.setInterval((()=>{this.updateEvents(),this.umbraScenes.forEach((e=>e.updateNetworkEvents()))}),e)}stopEventUpdate(){void 0!==this.updateTask&&(window.clearInterval(this.updateTask),delete this.updateTask)}findLights(e){let t;if(e.traverseAncestors((e=>{e.isScene&&(t=e)})),!t||t&&!t.isScene)return new Set;const n=new Set;return t.traverseVisible((e=>{e.isDirectionalLight&&e.castShadow&&n.add(e)})),n}pruneOldViews(e){for(const[t,n]of this.sharedState.viewLastUseFrame)if(!(e-n<600)){for(const[e,n]of this.sharedState.cameraToView)if(n===t){this.sharedState.cameraToView.delete(e);break}t.destroy(),this.sharedState.viewLastUseFrame.delete(t)}}updateViews(){const e=this.sharedState,t=new Set;if(this.renderer.shadowMap.enabled)for(const e of this.umbraScenes)for(const n of this.findLights(e))t.add(n);const n=this.dirVector,r=this.tempVector,a=Array.from(t).map((e=>(n.setFromMatrixPosition(e.target.matrixWorld),r.setFromMatrixPosition(e.matrixWorld),n.sub(r),[n.x,n.y,n.z])),t);this.pruneOldViews(this.renderer.info.render.frame);for(const[t,n]of e.cameraToView){const r=t;this.matrixWorldInverse.getInverse(r.matrixWorld),this.projScreenMatrix.multiplyMatrices(r.projectionMatrix,this.matrixWorldInverse),"umbraStreamingPosition"in r?this.cameraWorldPosition.copy(r.umbraStreamingPosition):r.getWorldPosition(this.cameraWorldPosition);let i=.5;"umbraQuality"in r&&(i=r.umbraQuality);const s=this.cameraWorldPosition;n.setCamera(this.projScreenMatrix.elements,[s.x,s.y,s.z],i*this.qualityFactor,a);let o=[];e.viewRenderables.has(n)?(o=e.viewRenderables.get(n),o.length=0):e.viewRenderables.set(n,o);const u=500;let l=[];do{l=n.getVisible(u),o.push(...l)}while(l.length===u)}}update(e=7){const t=0!==this.downloadLimit&&this.getStats().maxBytesDownloaded>=this.downloadLimit;if(t)this.oldState.downloadLimitReached||this.umbrajs.abortDownloads();else{const t=performance.now();this.runtime.update();const n=performance.now()-t;this.runtime.loadAssets(e-n),this.updateViews()}this.oldState.downloadLimitReached=t,this.memoryUsed/this.memoryLimit<.25&&this.adjustQuality(1.1)}createScene(e,t){if("string"!=typeof t)throw"object"==typeof t&&console.error("Connection with an {key, project, model} object is deprecated. Use a locator string instead."),new TypeError("expected a string argument");const n=new be(this.runtime,this.runtime.createScene(e,t),this.sharedState,this.renderer,this.features,(e=>this.umbraScenes.delete(e)));return this.umbraScenes.add(n),n}createScenePublic(e){if("string"!=typeof e)throw"object"==typeof e&&console.error("Connection with an {key, project, model} object is deprecated. Use a public link string instead."),new TypeError("expected a string argument");const t=new be(this.runtime,this.runtime.createScenePublic(e),this.sharedState,this.renderer,this.features,(e=>this.umbraScenes.delete(e)));return this.umbraScenes.add(t),t}createSceneLocal(e){const t=this.runtime.createSceneLocal(e),n=new be(this.runtime,t,this.sharedState,this.renderer,this.features,(e=>this.umbraScenes.delete(e)));return this.umbraScenes.add(n),n}createSceneWithURL(e){return this.createSceneLocal(e)}getStats(){return Object.assign(this.umbrajs.getStreamingInfo(),{textureMemoryUsed:this.textureMemoryUsed,meshMemoryUsed:this.meshMemoryUsed})}canFitInMemory(e){return this.memoryUsed+e<this.memoryLimit}adjustQuality(e){this.renderer.info.render.frame!=this.lastQualityLowerFrame&&(this.qualityFactor=Math.max(0,Math.min(1,this.qualityFactor*e)),this.lastQualityLowerFrame=this.renderer.info.render.frame)}makeTexture(e,t,n){const r=t.getArray().slice();let a;if(n.compressed){const t={width:e.width,height:e.height,data:r};a=new T([t],e.width,e.height)}else a=new A(r,e.width,e.height);return a.format=n.format,a.type=n.type,a.magFilter=L,a.minFilter=L,a.anisotropy=0,a}updateEvents(){const e=this.getStreamingProgress();this.oldState.progress!=e&&(this.onStreamingUpdate&&this.onStreamingUpdate(e),1===e&&this.onStreamingComplete&&this.onStreamingComplete()),this.oldState.progress=e}getStreamingProgress(){return this.runtime.getStreamingProgress()}dispose(){this.stopEventUpdate();for(const e of this.sharedState.cameraToView.values())e.destroy();this.umbraScenes.forEach((e=>e.dispose())),this.sharedState.cameraToView.clear(),this.umbraScenes.clear(),this.runtime.assets.forEach(((e,t)=>{"geometry"in e&&e.geometry.dispose(),"dispose"in e&&e.dispose()})),this.assetSizes.clear(),this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.runtime.destroy(),this.runtime=void 0,function(e){e.abortDownloads();const t=e;try{t.nativeModule._exit(0)}catch(e){if("ExitStatus"!==e.name)throw e}}(this.umbrajs)}}function we(e,t){if(!e)throw new TypeError('"renderer" should be of type THREE.WebGLRenderer');return me(t).then((t=>new ge(t,e)))}export{ye as Loader,be as Scene,we as initWithThreeJS};
//# sourceMappingURL=umbrajs-three.esm.min.js.map
