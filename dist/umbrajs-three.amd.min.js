define(["exports","three"],(function(e,t){"use strict";var n,r,a,i,o,s,u,l,c,m,d,f,h,p,b,y,g,w,v,S,C,U,T,A,_=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var t;e=e||{},t||(t=void 0!==e?e:{});var r,a={};for(r in t)t.hasOwnProperty(r)&&(a[r]=t[r]);function i(e,t){throw t}var o="";document.currentScript&&(o=document.currentScript.src),n&&(o=n),o=0!==o.indexOf("blob:")?o.substr(0,o.lastIndexOf("/")+1):"";var s,u,l,c=t.print||console.log.bind(console),m=t.printErr||console.warn.bind(console);for(r in a)a.hasOwnProperty(r)&&(t[r]=a[r]);function d(e,t){return t||(t=16),Math.ceil(e/t)*t}a=null,t.quit&&(i=t.quit),t.wasmBinary&&(u=t.wasmBinary),t.noExitRuntime&&(l=t.noExitRuntime),"object"!=typeof WebAssembly&&m("no native wasm support detected");var f,h=new WebAssembly.Table({initial:272,maximum:272,element:"anyfunc"}),p=!1;function b(e,t){e||j("Assertion failed: "+t)}function y(e){var n=t["_"+e];return b(n,"Cannot call unknown function "+e+", make sure it is exported"),n}function g(e,t,n,r){var a={string:function(e){var t=0;if(null!=e&&0!==e){var n=1+(e.length<<2);P(e,t=Pt(n),n)}return t},array:function(e){var t=Pt(e.length);return v.set(e,t),t}},i=y(e),o=[];if(e=0,r)for(var s=0;s<r.length;s++){var u=a[n[s]];u?(0===e&&(e=Bt()),o[s]=u(r[s])):o[s]=r[s]}return n=function(e){return"string"===t?B(e):"boolean"===t?!!e:e}(n=i.apply(null,o)),0!==e&&Mt(e),n}var w,v,S,C,U,T,A,_,L,x="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function E(e,t,n){var r=t+n;for(n=t;e[n]&&!(n>=r);)++n;if(16<n-t&&e.subarray&&x)return x.decode(e.subarray(t,n));for(r="";t<n;){var a=e[t++];if(128&a){var i=63&e[t++];if(192==(224&a))r+=String.fromCharCode((31&a)<<6|i);else{var o=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|i<<6|o:(7&a)<<18|i<<12|o<<6|63&e[t++])?r+=String.fromCharCode(a):(a-=65536,r+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else r+=String.fromCharCode(a)}return r}function B(e){return e?E(S,e,void 0):""}function P(e,t,n){var r=S;if(0<n){n=t+n-1;for(var a=0;a<e.length;++a){var i=e.charCodeAt(a);if(55296<=i&&57343>=i&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++a)),127>=i){if(t>=n)break;r[t++]=i}else{if(2047>=i){if(t+1>=n)break;r[t++]=192|i>>6}else{if(65535>=i){if(t+2>=n)break;r[t++]=224|i>>12}else{if(t+3>=n)break;r[t++]=240|i>>18,r[t++]=128|i>>12&63}r[t++]=128|i>>6&63}r[t++]=128|63&i}}r[t]=0}}function M(e){return 0<e%65536&&(e+=65536-e%65536),e}function R(e){w=e,t.HEAP8=v=new Int8Array(e),t.HEAP16=C=new Int16Array(e),t.HEAP32=T=new Int32Array(e),t.HEAPU8=S=new Uint8Array(e),t.HEAPU16=U=new Uint16Array(e),t.HEAPU32=A=new Uint32Array(e),t.HEAPF32=_=new Float32Array(e),t.HEAPF64=L=new Float64Array(e)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var F=t.TOTAL_MEMORY||134217728;function k(e){for(;0<e.length;){var n=e.shift();if("function"==typeof n)n();else{var r=n.Mb;"number"==typeof r?void 0===n.Jb?t.dynCall_v(r):t.dynCall_vi(r,n.Jb):r(void 0===n.Jb?null:n.Jb)}}}(f=t.wasmMemory?t.wasmMemory:new WebAssembly.Memory({initial:F/65536}))&&(w=f.buffer),F=w.byteLength,R(w),T[7368]=5272512;var I=[],G=[],D=[],z=[],W=[];function N(){var e=t.preRun.shift();I.unshift(e)}var O=0,V=null;function j(e){throw t.onAbort&&t.onAbort(e),c(e),m(e),p=!0,new WebAssembly.RuntimeError("abort("+e+"). Build with -s ASSERTIONS=1 for more info.")}function q(){var e=H;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):0===e.indexOf("data:application/octet-stream;base64,")}t.preloadedImages={},t.preloadedAudios={};var H="umbra.wasm";if(!q()){var X=H;H=t.locateFile?t.locateFile(X,o):o+X}function Q(){try{if(u)return new Uint8Array(u);throw"both async and sync fetching of the wasm failed"}catch(e){j(e)}}var $={8103:function(){alert("Uploads are not supported.")},9294:function(){alert("Invalid http method.")},9575:function(e,n,r,a,i,o,s,u,l,c,m){return function(e,n,r,a,i,o,s,u,l,c,m){var d=B(e);n=B(n),o=B(o);var f=new XMLHttpRequest;f.open(n,d,!0),("GET"!=n||0!=o.length)&&(f.withCredentials=!0),f.responseType="arraybuffer";var h=function(){var e=yt;return yt++,e}();if(f.onload=function(){if(200==f.status){var n=new Uint8Array(f.response),o=t.URLsDownloaded;t.maxBytesDownloaded+=f.response.byteLength,o.has(e)||(o.add(e),t.minBytesDownloaded+=f.response.byteLength),c?n.length!=m?t.dynCall_viii(i,h,r,0):(S.set(n,c),t.dynCall_viiii(a,h,r,null,0)):(o=Lt(n.length),S.set(n,o),t.dynCall_viiii(a,h,r,o,n.length),xt(o))}else t.dynCall_viii(i,h,r,f.status);delete bt[h]},f.onerror=function(){t.dynCall_viii(i,h,r,f.status),delete bt[h]},f.onabort=function(){delete bt[h]},0!=o.length&&f.setRequestHeader("Authorization","Basic "+btoa(o+":")),2<=(l=B(l).split("\n")).length)for(d=0;d<l.length;d+=2)f.setRequestHeader(l[d],l[d+1]);return"POST"==n?f.send(v.slice(s,s+u)):f.send(null),bt[h]=f,h}(e,n,r,a,i,o,s,u,l,c,m)}},J=[];function K(e,t){z.unshift({Mb:e,Jb:t})}G.push({Mb:function(){_t()}});var Y=[null,[],[]];function Z(e,t){var n=Y[e];0===t||10===t?((1===e?c:m)(E(n,0)),n.length=0):n.push(t)}var ee=0;function te(){return T[(ee+=4)-4>>2]}var ne={},re={};function ae(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function ie(e){return this.fromWireType(A[e>>2])}var oe={},se={},ue={};function le(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return 48<=t&&57>=t?"_"+e:e}function ce(e,t){return e=le(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function me(e){var t=Error,n=ce(e,(function(t){this.name=e,this.message=t,void 0!==(t=Error(t).stack)&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))}));return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var de=void 0;function fe(e,t,n){function r(t){if((t=n(t)).length!==e.length)throw new de("Mismatched type converter count");for(var r=0;r<e.length;++r)we(e[r],t[r])}e.forEach((function(e){ue[e]=t}));var a=Array(t.length),i=[],o=0;t.forEach((function(e,t){se.hasOwnProperty(e)?a[t]=se[e]:(i.push(e),oe.hasOwnProperty(e)||(oe[e]=[]),oe[e].push((function(){a[t]=se[e],++o===i.length&&r(a)})))})),0===i.length&&r(a)}function he(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var pe=void 0;function be(e){for(var t="";S[e];)t+=pe[S[e++]];return t}var ye=void 0;function ge(e){throw new ye(e)}function we(e,t,n){if(n=n||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||ge('type "'+r+'" must have a positive integer typeid pointer'),se.hasOwnProperty(e)){if(n.Wb)return;ge("Cannot register type '"+r+"' twice")}se[e]=t,delete ue[e],oe.hasOwnProperty(e)&&(t=oe[e],delete oe[e],t.forEach((function(e){e()})))}var ve=[],Se=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Ce(e){4<e&&0==--Se[e].Nb&&(Se[e]=void 0,ve.push(e))}function Ue(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=ve.length?ve.pop():Se.length;return Se[t]={Nb:1,value:e},t}}function Te(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Ae(e,t){switch(t){case 2:return function(e){return this.fromWireType(_[e>>2])};case 3:return function(e){return this.fromWireType(L[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function _e(e){var t=Function;if(!(t instanceof Function))throw new TypeError("new_ called with constructor type "+typeof t+" which is not a function");var n=ce(t.name||"unknownFunctionName",(function(){}));return n.prototype=t.prototype,n=new n,(e=t.apply(n,e))instanceof Object?e:n}function Le(e,n,r){t.hasOwnProperty(e)?((void 0===r||void 0!==t[e].Hb&&void 0!==t[e].Hb[r])&&ge("Cannot register public name '"+e+"' twice"),function(e,n){var r=t;if(void 0===r[e].Hb){var a=r[e];r[e]=function(){return r[e].Hb.hasOwnProperty(arguments.length)||ge("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+r[e].Hb+")!"),r[e].Hb[arguments.length].apply(this,arguments)},r[e].Hb=[],r[e].Hb[a.Qb]=a}}(e,e),t.hasOwnProperty(r)&&ge("Cannot register multiple overloads of a function with the same number of arguments ("+r+")!"),t[e].Hb[r]=n):(t[e]=n,void 0!==r&&(t[e].pc=r))}function xe(e,n){if(e=be(e),void 0!==t["FUNCTION_TABLE_"+e])var r=t["FUNCTION_TABLE_"+e][n];else if("undefined"!=typeof FUNCTION_TABLE)r=FUNCTION_TABLE[n];else{void 0===(r=t["dynCall_"+e])&&void 0===(r=t["dynCall_"+e.replace(/f/g,"d")])&&ge("No dynCall invoker for signature: "+e);for(var a=[],i=1;i<e.length;++i)a.push("a"+i);i="return function dynCall_"+e+"_"+n+"("+a.join(", ")+") {\n",i+="    return dynCall(rawFunction"+(a.length?", ":"")+a.join(", ")+");\n",r=new Function("dynCall","rawFunction",i+"};\n")(r,n)}return"function"!=typeof r&&ge("unknown function pointer with signature "+e+": "+n),r}var Ee=void 0;function Be(e){var t=be(e=Et(e));return xt(e),t}function Pe(e,t,n){switch(t){case 0:return n?function(e){return v[e]}:function(e){return S[e]};case 1:return n?function(e){return C[e>>1]}:function(e){return U[e>>1]};case 2:return n?function(e){return T[e>>2]}:function(e){return A[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Me(e){return e||ge("Cannot use deleted val. handle = "+e),Se[e].value}function Re(e,t){var n=se[e];return void 0===n&&ge(t+" has unknown type "+Be(e)),n}var Fe={};function ke(e){var t=Fe[e];return void 0===t?be(e):t}var Ie=[];function Ge(){j()}var De,ze,We=null,Ne="",Oe=0,Ve=null,je=0,qe=0,He=0,Xe=0,Qe=[],$e={},Je=!1,Ke=!1,Ye=[];function Ze(){function e(){Ke=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas||document.msPointerLockElement===t.canvas}if(t.preloadPlugins||(t.preloadPlugins=[]),!dt){dt=!0;try{ft=!0}catch(e){ft=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}ht="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:ft?null:console.log("warning: no BlobBuilder"),pt="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,t.Pb||void 0!==pt||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),t.Pb=!0),t.preloadPlugins.push({canHandle:function(e){return!t.Pb&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,n,r,a){var i=null;if(ft)try{(i=new Blob([e],{type:ut(n)})).size!==e.length&&(i=new Blob([new Uint8Array(e).buffer],{type:ut(n)}))}catch(e){!function(e){s||(s={}),s[e]||(s[e]=1,m(e))}("Blob constructor present but fails: "+e+"; falling back to blob builder")}i||((i=new ht).append(new Uint8Array(e).buffer),i=i.getBlob());var o=pt.createObjectURL(i),u=new Image;u.onload=function(){b(u.complete,"Image "+n+" could not be decoded");var a=document.createElement("canvas");a.width=u.width,a.height=u.height,a.getContext("2d").drawImage(u,0,0),t.preloadedImages[n]=a,pt.revokeObjectURL(o),r&&r(e)},u.onerror=function(){console.log("Image "+o+" could not be decoded"),a&&a()},u.src=o}}),t.preloadPlugins.push({canHandle:function(e){return!t.oc&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,n,r,a){function i(a){s||(s=!0,t.preloadedAudios[n]=a,r&&r(e))}function o(){s||(s=!0,t.preloadedAudios[n]=new Audio,a&&a())}var s=!1;if(!ft)return o();try{var u=new Blob([e],{type:ut(n)})}catch(e){return o()}u=pt.createObjectURL(u);var c=new Audio;c.addEventListener("canplaythrough",(function(){i(c)}),!1),c.onerror=function(){if(!s){console.log("warning: browser could not fully decode audio "+n+", trying slower base64 approach");for(var t="",r=0,a=0,o=0;o<e.length;o++)for(r=r<<8|e[o],a+=8;6<=a;){var u=r>>a-6&63;a-=6,t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[u]}2==a?(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&r)<<4],t+="=="):4==a&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&r)<<2],t+="="),c.src="data:audio/x-"+n.substr(-3)+";base64,"+t,i(c)}},c.src=u,function(e){l=!0,setTimeout((function(){p||e()}),1e4)}((function(){i(c)}))}});var n=t.canvas;n&&(n.requestPointerLock=n.requestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock||n.msRequestPointerLock||function(){},n.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},n.exitPointerLock=n.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),t.elementPointerLock&&n.addEventListener("click",(function(e){!Ke&&t.canvas.requestPointerLock&&(t.canvas.requestPointerLock(),e.preventDefault())}),!1))}}var et=!1,tt=void 0,nt=void 0;function rt(e,n,r){function a(){Je=!1;var e=i.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.exitFullscreen=it,tt&&i.requestPointerLock(),Je=!0,nt?("undefined"!=typeof SDL&&(T[SDL.screen>>2]=8388608|A[SDL.screen>>2]),mt(t.canvas),ct()):mt(i)):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),nt?("undefined"!=typeof SDL&&(T[SDL.screen>>2]=-8388609&A[SDL.screen>>2]),mt(t.canvas),ct()):mt(i)),t.onFullScreen&&t.onFullScreen(Je),t.onFullscreen&&t.onFullscreen(Je)}void 0===(tt=e)&&(tt=!0),void 0===(nt=n)&&(nt=!1);var i=t.canvas;et||(et=!0,document.addEventListener("fullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1));var o=document.createElement("div");i.parentNode.insertBefore(o,i),o.appendChild(i),o.requestFullscreen=o.requestFullscreen||o.mozRequestFullScreen||o.msRequestFullscreen||(o.webkitRequestFullscreen?function(){o.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(o.webkitRequestFullScreen?function(){o.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r?o.requestFullscreen({rc:r}):o.requestFullscreen()}function at(e,t,n){m("Browser.requestFullScreen() is deprecated. Please call Browser.requestFullscreen instead."),at=function(e,t,n){rt(e,t,n)},rt(e,t,n)}function it(){return!!Je&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)}var ot=0;function st(e){if("function"==typeof requestAnimationFrame)requestAnimationFrame(e);else{var t=Date.now();if(0===ot)ot=t+1e3/60;else for(;t+2>=ot;)ot+=1e3/60;setTimeout(e,Math.max(ot-t,0))}}function ut(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]}var lt=[];function ct(){var e=t.canvas;lt.forEach((function(t){t(e.width,e.height)}))}function mt(e,n,r){n&&r?(e.dc=n,e.Vb=r):(n=e.dc,r=e.Vb);var a=n,i=r;if(t.forcedAspectRatio&&0<t.forcedAspectRatio&&(a/i<t.forcedAspectRatio?a=Math.round(i*t.forcedAspectRatio):i=Math.round(a/t.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var o=Math.min(screen.width/a,screen.height/i);a=Math.round(a*o),i=Math.round(i*o)}nt?(e.width!=a&&(e.width=a),e.height!=i&&(e.height=i),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=n&&(e.width=n),e.height!=r&&(e.height=r),void 0!==e.style&&(a!=n||i!=r?(e.style.setProperty("width",a+"px","important"),e.style.setProperty("height",i+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))}var dt,ft,ht,pt,bt={},yt=0,gt={};function wt(e,t){var n=gt[e];if(n)t(null,n);else{try{var r=function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"==typeof window&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),b(e,"IDBStore used, but indexedDB not supported"),e}().open(e,22)}catch(e){return void t(e)}r.onupgradeneeded=function(e){var t=e.target.result;e=e.target.transaction,t.objectStoreNames.contains("FILE_DATA")?e.objectStore("FILE_DATA"):t.createObjectStore("FILE_DATA")},r.onsuccess=function(){n=r.result,gt[e]=n,t(null,n)},r.onerror=function(e){t(this.error),e.preventDefault()}}}function vt(e,t,n){wt(e,(function(e,r){if(e)return n(e);(e=r.transaction(["FILE_DATA"],t)).onerror=function(e){n(this.error||"unknown error"),e.preventDefault()},e=e.objectStore("FILE_DATA"),n(null,e)}))}function St(e){!l&&(p=!0,k(z),t.onExit)&&t.onExit(e),i(e,new It(e))}t._exit=St,P("GMT",29536,4),de=t.InternalError=me("InternalError");for(var Ct=Array(256),Ut=0;256>Ut;++Ut)Ct[Ut]=String.fromCharCode(Ut);pe=Ct,ye=t.BindingError=me("BindingError"),t.count_emval_handles=function(){for(var e=0,t=5;t<Se.length;++t)void 0!==Se[t]&&++e;return e},t.get_first_emval=function(){for(var e=5;e<Se.length;++e)if(void 0!==Se[e])return Se[e];return null},Ee=t.UnboundTypeError=me("UnboundTypeError"),t.requestFullScreen=function(e,n,r){m("Module.requestFullScreen is deprecated. Please call Module.requestFullscreen instead."),t.requestFullScreen=t.requestFullscreen,at(e,n,r)},t.requestFullscreen=function(e,t,n){rt(e,t,n)},t.requestAnimationFrame=function(e){st(e)},t.setCanvasSize=function(e,n,r){mt(t.canvas,e,n),r||ct()},t.pauseMainLoop=function(){We=null,Oe++},t.resumeMainLoop=function(){Oe++;var e=qe,n=He,r=Ve;Ve=null,function(e){var n=je;l=!0,b(!Ve,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),Ve=e,je=n;var r=void 0!==n?function(){t.dynCall_vi(e,n)}:function(){t.dynCall_v(e)},a=Oe;ze=function(){if(!p)if(0<Qe.length){var e,n=Date.now(),i=Qe.shift();i.Mb(i.Jb),console.log('main loop blocker "'+i.name+'" took '+(Date.now()-n)+" ms"),t.setStatus&&(n=t.statusMessage||"Please wait...",i=void 0,e=$e.jc,i?i<e?t.setStatus(n+" ("+(e-i)+"/"+e+")"):t.setStatus(n):t.setStatus("")),a<Oe||setTimeout(ze,0)}else if(!(a<Oe))if(Xe=Xe+1|0,1==qe&&1<He&&0!=Xe%He)We();else{0==qe&&(De=Ge()),"timeout"===Ne&&t.Kb&&(m("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),Ne="");e:if(!(p||t.preMainLoop&&!1===t.preMainLoop())){try{r()}catch(e){if(e instanceof It)break e;throw e&&"object"==typeof e&&e.stack&&m("exception thrown: "+[e,e.stack]),e}t.postMainLoop&&t.postMainLoop()}a<Oe||("object"==typeof SDL&&SDL.audio&&SDL.audio.Yb&&SDL.audio.Yb(),We())}}}(r),function(e,t){if(qe=e,He=t,Ve)if(0==e)We=function(){var e=0|Math.max(0,De+t-Ge());setTimeout(ze,e)},Ne="timeout";else if(1==e)We=function(){st(ze)},Ne="rAF";else if(2==e){if("undefined"==typeof setImmediate){var n=[];addEventListener("message",(function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),n.shift()())}),!0),setImmediate=function(e){n.push(e),postMessage("setimmediate","*")}}We=function(){setImmediate(ze)},Ne="immediate"}}(e,n),We()},t.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},t.createContext=function(e,n,r,a){return function(e,n,r,a){if(n&&t.Kb&&e==t.canvas)return t.Kb;var i;if(n){var o={antialias:!1,alpha:!1,mc:1};if(a)for(var s in a)o[s]=a[s];if("undefined"!=typeof GL&&(i=GL.gc(e,o)))var u=GL.getContext(i).ec}else u=e.getContext("2d");return u?(r&&(n||b("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),t.Kb=u,n&&GL.nc(i),t.qc=n,Ye.forEach((function(e){e()})),Ze()),u):null}(e,n,r,a)},Ge="undefined"!=typeof dateNow?dateNow:"object"==typeof performance&&performance&&"function"==typeof performance.now?function(){return performance.now()}:Date.now,z.push((function(){var e=t._fflush;e&&e(0),Y[1].length&&Z(1,10),Y[2].length&&Z(2,10)}));var Tt={U:function(){m("missing function: _ZN5Umbra13MiniSceneCopy7connectERK20UmbraSceneCopySource"),j(-1)},T:function(){m("missing function: _ZN5Umbra13MiniSceneCopy9getStatusEPf"),j(-1)},V:function(){m("missing function: _ZN5Umbra13MiniSceneCopyC1ERNS_11MiniRuntimeERK25UmbraSceneCopyDestinationPK20UmbraEnvironmentInfoRKN5Eigen6MatrixIfLi3ELi1ELi0ELi3ELi1EEEfi"),j(-1)},C:function(){return K.apply(null,arguments)},L:function(){},P:function(e,t){ee=t;try{var n=B(te()),r=te();return ne.ic((void 0).stat,n,r)}catch(e){return j(e),-e.Lb}},w:function(e,t){return ee=t,0},O:function(e,t){ee=t;try{var n=B(te()),r=te(),a=te();return(void 0).open(n,r,a).kc}catch(e){return j(e),-e.Lb}},N:function(e,t){return ee=t,0},s:function(){},A:function(e){var t=re[e];delete re[e];var n=t.Zb,r=t.$b,a=t.Ob;fe([e],a.map((function(e){return e.Ub})).concat(a.map((function(e){return e.bc}))),(function(e){var i={};return a.forEach((function(t,n){var r=e[n],o=t.Sb,s=t.Tb,u=e[n+a.length],l=t.ac,c=t.cc;i[t.Rb]={read:function(e){return r.fromWireType(o(s,e))},write:function(e,t){var n=[];l(c,e,u.toWireType(n,t)),ae(n)}}})),[{name:t.name,fromWireType:function(e){var t,n={};for(t in i)n[t]=i[t].read(e);return r(e),n},toWireType:function(e,t){for(var a in i)if(!(a in t))throw new TypeError("Missing field");var o=n();for(a in i)i[a].write(o,t[a]);return null!==e&&e.push(r,o),o},argPackAdvance:8,readValueFromPointer:ie,Ib:r}]}))},I:function(e,t,n,r,a){var i=he(n);we(e,{name:t=be(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:a},argPackAdvance:8,readValueFromPointer:function(e){if(1===n)var r=v;else if(2===n)r=C;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);r=T}return this.fromWireType(r[e>>i])},Ib:null})},k:function(e,n,r){e=be(e),fe([],[n],(function(n){return n=n[0],t[e]=n.fromWireType(r),[]}))},G:function(e,t){we(e,{name:t=be(t),fromWireType:function(e){var t=Se[e].value;return Ce(e),t},toWireType:function(e,t){return Ue(t)},argPackAdvance:8,readValueFromPointer:ie,Ib:null})},u:function(e,t,n){n=he(n),we(e,{name:t=be(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+Te(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Ae(t,n),Ib:null})},e:function(e,n,r,a,i,o){var s=function(e,t){for(var n=[],r=0;r<e;r++)n.push(T[(t>>2)+r]);return n}(n,r);e=be(e),i=xe(a,i),Le(e,(function(){!function(e,t){var n=[],r={};throw t.forEach((function e(t){r[t]||se[t]||(ue[t]?ue[t].forEach(e):(n.push(t),r[t]=!0))})),new Ee(e+": "+n.map(Be).join([", "]))}("Cannot call "+e+" due to unbound types",s)}),n-1),fe([],s,(function(r){var a=e,s=e;r=[r[0],null].concat(r.slice(1));var u=i,l=r.length;2>l&&ge("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var c=null!==r[1]&&!1,m=!1,d=1;d<r.length;++d)if(null!==r[d]&&void 0===r[d].Ib){m=!0;break}var f="void"!==r[0].name,h="",p="";for(d=0;d<l-2;++d)h+=(0!==d?", ":"")+"arg"+d,p+=(0!==d?", ":"")+"arg"+d+"Wired";s="return function "+le(s)+"("+h+") {\nif (arguments.length !== "+(l-2)+") {\nthrowBindingError('function "+s+" called with ' + arguments.length + ' arguments, expected "+(l-2)+" args!');\n}\n",m&&(s+="var destructors = [];\n");var b=m?"destructors":"null";for(h="throwBindingError invoker fn runDestructors retType classParam".split(" "),u=[ge,u,o,ae,r[0],r[1]],c&&(s+="var thisWired = classParam.toWireType("+b+", this);\n"),d=0;d<l-2;++d)s+="var arg"+d+"Wired = argType"+d+".toWireType("+b+", arg"+d+"); // "+r[d+2].name+"\n",h.push("argType"+d),u.push(r[d+2]);if(c&&(p="thisWired"+(0<p.length?", ":"")+p),s+=(f?"var rv = ":"")+"invoker(fn"+(0<p.length?", ":"")+p+");\n",m)s+="runDestructors(destructors);\n";else for(d=c?1:2;d<r.length;++d)l=1===d?"thisWired":"arg"+(d-2)+"Wired",null!==r[d].Ib&&(s+=l+"_dtor("+l+"); // "+r[d].name+"\n",h.push(l+"_dtor"),u.push(r[d].Ib));if(f&&(s+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),h.push(s+"}\n"),r=_e(h).apply(null,u),d=n-1,!t.hasOwnProperty(a))throw new de("Replacing nonexistant public symbol");return void 0!==t[a].Hb&&void 0!==d?t[a].Hb[d]=r:(t[a]=r,t[a].Qb=d),[]}))},o:function(e,t,n,r,a){function i(e){return e}t=be(t),-1===a&&(a=4294967295);var o=he(n);if(0===r){var s=32-8*n;i=function(e){return e<<s>>>s}}var u=-1!=t.indexOf("unsigned");we(e,{name:t,fromWireType:i,toWireType:function(e,n){if("number"!=typeof n&&"boolean"!=typeof n)throw new TypeError('Cannot convert "'+Te(n)+'" to '+this.name);if(n<r||n>a)throw new TypeError('Passing a number "'+Te(n)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+a+"]!");return u?n>>>0:0|n},argPackAdvance:8,readValueFromPointer:Pe(t,o,0!==r),Ib:null})},m:function(e,t,n){function r(e){e>>=2;var t=A;return new a(t.buffer,t[e+1],t[e])}var a=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];we(e,{name:n=be(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{Wb:!0})},v:function(e,t){var n="std::string"===(t=be(t));we(e,{name:t,fromWireType:function(e){var t=A[e>>2];if(n){var r=S[e+4+t],a=0;0!=r&&(a=r,S[e+4+t]=0);var i=e+4;for(r=0;r<=t;++r){var o=e+4+r;if(0==S[o]){if(i=B(i),void 0===s)var s=i;else s+=String.fromCharCode(0),s+=i;i=o+1}}0!=a&&(S[e+4+t]=a)}else{for(s=Array(t),r=0;r<t;++r)s[r]=String.fromCharCode(S[e+4+r]);s=s.join("")}return xt(e),s},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ge("Cannot pass non-string to std::string");var a=(n&&r?function(){for(var e=0,n=0;n<t.length;++n){var r=t.charCodeAt(n);55296<=r&&57343>=r&&(r=65536+((1023&r)<<10)|1023&t.charCodeAt(++n)),127>=r?++e:e=2047>=r?e+2:65535>=r?e+3:e+4}return e}:function(){return t.length})(),i=Lt(4+a+1);if(A[i>>2]=a,n&&r)P(t,i+4,a+1);else if(r)for(r=0;r<a;++r){var o=t.charCodeAt(r);255<o&&(xt(i),ge("String has UTF-16 code units that do not fit in 8 bits")),S[i+4+r]=o}else for(r=0;r<a;++r)S[i+4+r]=t[r];return null!==e&&e.push(xt,i),i},argPackAdvance:8,readValueFromPointer:ie,Ib:function(e){xt(e)}})},H:function(e,t,n){if(n=be(n),2===t)var r=function(){return U},a=1;else 4===t&&(r=function(){return A},a=2);we(e,{name:n,fromWireType:function(e){for(var t=r(),n=A[e>>2],i=Array(n),o=e+4>>a,s=0;s<n;++s)i[s]=String.fromCharCode(t[o+s]);return xt(e),i.join("")},toWireType:function(e,n){var i=n.length,o=Lt(4+i*t),s=r();A[o>>2]=i;for(var u=o+4>>a,l=0;l<i;++l)s[u+l]=n.charCodeAt(l);return null!==e&&e.push(xt,o),o},argPackAdvance:8,readValueFromPointer:ie,Ib:function(e){xt(e)}})},B:function(e,t,n,r,a,i){re[e]={name:be(t),Zb:xe(n,r),$b:xe(a,i),Ob:[]}},q:function(e,t,n,r,a,i,o,s,u,l){re[e].Ob.push({Rb:be(t),Ub:n,Sb:xe(r,a),Tb:i,bc:o,ac:xe(s,u),cc:l})},J:function(e,t){we(e,{Xb:!0,name:t=be(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},h:function(e,t,n){e=Me(e),t=Re(t,"emval::as");var r=[],a=Ue(r);return T[n>>2]=a,t.toWireType(r,e)},i:function(e,t,n,r){(e=Ie[e])(t=Me(t),n=ke(n),null,r)},a:Ce,j:function(e,t){for(var n=(t=function(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=Re(T[(t>>2)+r],"parameter "+r);return n}(e,t))[0],r=n.name+"_$"+t.slice(1).map((function(e){return e.name})).join("_")+"$",a=["retType"],i=[n],o="",s=0;s<e-1;++s)o+=(0!==s?", ":"")+"arg"+s,a.push("argType"+s),i.push(t[1+s]);r="return function "+le("methodCaller_"+r)+"(handle, name, destructors, args) {\n";var u=0;for(s=0;s<e-1;++s)r+="    var arg"+s+" = argType"+s+".readValueFromPointer(args"+(u?"+"+u:"")+");\n",u+=t[s+1].argPackAdvance;for(r+="    var rv = handle[name]("+o+");\n",s=0;s<e-1;++s)t[s+1].deleteObject&&(r+="    argType"+s+".deleteObject(arg"+s+");\n");return n.Xb||(r+="    return retType.toWireType(destructors, rv);\n"),a.push(r+"};\n"),function(e){var t=Ie.length;return Ie.push(e),t}(e=_e(a).apply(null,i))},f:function(e,t){return Ue((e=Me(e))[t=Me(t)])},p:function(e){4<e&&(Se[e].Nb+=1)},n:function(){return Ue([])},b:function(e){return Ue(ke(e))},l:function(){return Ue({})},g:function(e){ae(Se[e].value),Ce(e)},d:function(e,t,n){e=Me(e),t=Me(t),n=Me(n),e[t]=n},c:function(e,t){return Ue(e=(e=Re(e,"_emval_take_value")).readValueFromPointer(t))},Q:function(){j()},r:function(e,t,n){e:for(J.length=0;;){var r=S[t++];if(!r){t=J;break e}100===r||102===r?(n=d(n,8),J.push(L[n>>3]),n+=8):105===r&&(n=d(n,4),J.push(T[n>>2]),n+=4)}return $[e].apply(null,t)},z:function(e){(e=bt[e])&&e.abort()},X:Ge,y:function(e,t,n,r,a){!function(e,t,n){vt(e,"readonly",(function(e,r){if(e)return n(e);(e=r.get(t)).onsuccess=function(e){return(e=e.target.result)?n(null,e):n("file "+t+" not found")},e.onerror=function(e){n(e)}}))}(B(e),B(t),(function(e,t){e?a&&Rt(a,n):(e=Lt(t.length),S.set(t,e),kt(r,n,e,t.length),xt(e))}))},W:function(e,t,n,r,a,i,o){!function(e,t,n,r){vt(e,"readwrite",(function(e,a){if(e)return r(e);(e=a.put(n,t)).onsuccess=function(){r()},e.onerror=function(e){r(e)}}))}(B(e),B(t),new Uint8Array(S.subarray(n,n+r)),(function(e){e?o&&Rt(o,a):i&&Rt(i,a)}))},E:function(e,t,n){S.set(S.subarray(t,t+n),e)},F:function(e){if(2147418112<e)return!1;for(var t=Math.max(v.length,16777216);t<e;)t=536870912>=t?M(2*t):Math.min(M((3*t+2147483648)/4),2147418112);e:{try{f.grow(t-w.byteLength+65535>>16),R(f.buffer);var n=1;break e}catch(e){}n=void 0}return!!n},Y:St,x:function(){return 0},K:function(e,t,n,r){try{var a=ne.lc(e),i=ne.hc(a,t,n);return T[r>>2]=i,0}catch(e){return j(e),e.Lb}},D:function(){return 0},M:function(e,t,n,r){try{for(var a=0,i=0;i<n;i++){for(var o=T[t+8*i>>2],s=T[t+(8*i+4)>>2],u=0;u<s;u++)Z(e,S[o+u]);a+=s}return T[r>>2]=a,0}catch(e){return j(e),e.Lb}},R:function(e){return e=new Date(1e3*T[e>>2]),T[7372]=e.getUTCSeconds(),T[7373]=e.getUTCMinutes(),T[7374]=e.getUTCHours(),T[7375]=e.getUTCDate(),T[7376]=e.getUTCMonth(),T[7377]=e.getUTCFullYear()-1900,T[7378]=e.getUTCDay(),T[7381]=0,T[7380]=0,T[7379]=(e.getTime()-Date.UTC(e.getUTCFullYear(),0,1,0,0,0,0))/864e5|0,T[7382]=29536,29488},memory:f,t:function(){},table:h,S:function(e){var t=Date.now()/1e3|0;return e&&(T[e>>2]=t),t}},At=function(){function e(e){t.asm=e.exports,O--,t.monitorRunDependencies&&t.monitorRunDependencies(O),0==O&&V&&(e=V,V=null,e())}function n(t){e(t.instance)}function r(e){return(u||"function"!=typeof fetch?new Promise((function(e){e(Q())})):fetch(H,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+H+"'";return e.arrayBuffer()})).catch((function(){return Q()}))).then((function(e){return WebAssembly.instantiate(e,a)})).then(e,(function(e){m("failed to asynchronously prepare wasm: "+e),j(e)}))}var a={env:Tt,wasi_unstable:Tt};if(O++,t.monitorRunDependencies&&t.monitorRunDependencies(O),t.instantiateWasm)try{return t.instantiateWasm(a,e)}catch(e){return m("Module.instantiateWasm callback failed with error: "+e),!1}return function(){if(u||"function"!=typeof WebAssembly.instantiateStreaming||q()||"function"!=typeof fetch)return r(n);fetch(H,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,a).then(n,(function(e){m("wasm streaming compile failed: "+e),m("falling back to ArrayBuffer instantiation"),r(n)}))}))}(),{}}();t.asm=At;var _t=t.___wasm_call_ctors=function(){return t.asm.Z.apply(null,arguments)};t._UmbraMeshLoadGetInfo=function(){return t.asm._.apply(null,arguments)},t._UmbraMeshLoadGetSerializedSize=function(){return t.asm.$.apply(null,arguments)},t._UmbraMeshLoadSerialize=function(){return t.asm.aa.apply(null,arguments)},t._UmbraAssetLoadGetType=function(){return t.asm.ba.apply(null,arguments)},t._UmbraTextureLoadGetInfo=function(){return t.asm.ca.apply(null,arguments)},t._UmbraTextureLoadGetSerializedSize=function(){return t.asm.da.apply(null,arguments)},t._UmbraTextureLoadSerialize=function(){return t.asm.ea.apply(null,arguments)},t._UmbraGeodeticToEcef=function(){return t.asm.fa.apply(null,arguments)},t._UmbraEcefToGeodetic=function(){return t.asm.ga.apply(null,arguments)},t._UmbraTextureGetMipmapLevelByteSize=function(){return t.asm.ha.apply(null,arguments)},t._UmbraTextureGetMipmapLevelOffset=function(){return t.asm.ia.apply(null,arguments)};var Lt=t._malloc=function(){return t.asm.ja.apply(null,arguments)};t._UmbraMeshLoadFinishExternal=function(){return t.asm.ka.apply(null,arguments)};var xt=t._free=function(){return t.asm.la.apply(null,arguments)};t._UmbraConfigInit=function(){return t.asm.ma.apply(null,arguments)},t._UmbraSetAllocator=function(){return t.asm.na.apply(null,arguments)},t._UmbraSetLogger=function(){return t.asm.oa.apply(null,arguments)},t._UmbraSetHttp=function(){return t.asm.pa.apply(null,arguments)},t._UmbraClientCreate=function(){return t.asm.qa.apply(null,arguments)},t._UmbraClientDestroy=function(){return t.asm.ra.apply(null,arguments)},t._UmbraGetLibraryInfo=function(){return t.asm.sa.apply(null,arguments)},t._UmbraEnvironmentInfoDefaults=function(){return t.asm.ta.apply(null,arguments)},t._UmbraRuntimeCreate=function(){return t.asm.ua.apply(null,arguments)},t._UmbraRuntimeDestroy=function(){return t.asm.va.apply(null,arguments)},t._UmbraRuntimeUpdate=function(){return t.asm.wa.apply(null,arguments)},t._UmbraRuntimeGetStreamingState=function(){return t.asm.xa.apply(null,arguments)},t._UmbraRuntimeNextAssetUnload=function(){return t.asm.ya.apply(null,arguments)},t._UmbraAssetUnloadFinish=function(){return t.asm.za.apply(null,arguments)},t._UmbraAssetUnloadGetType=function(){return t.asm.Aa.apply(null,arguments)},t._UmbraAssetUnloadGetUserPointer=function(){return t.asm.Ba.apply(null,arguments)},t._UmbraRuntimeNextAssetLoad=function(){return t.asm.Ca.apply(null,arguments)},t._UmbraAssetLoadPrepare=function(){return t.asm.Da.apply(null,arguments)},t._UmbraAssetLoadFinish=function(){return t.asm.Ea.apply(null,arguments)},t._UmbraAssetLoadAbortRequested=function(){return t.asm.Fa.apply(null,arguments)},t._UmbraVertexAttributeGetElementByteSize=function(){return t.asm.Ga.apply(null,arguments)},t._UmbraMeshLoadGetData=function(){return t.asm.Ha.apply(null,arguments)},t._UmbraMeshStreamSetBuffers=function(){return t.asm.Ia.apply(null,arguments)},t._UmbraMeshStreamDone=function(){return t.asm.Ja.apply(null,arguments)},t._UmbraMeshStreamNext=function(){return t.asm.Ka.apply(null,arguments)},t._UmbraMaterialLoadGetInfo=function(){return t.asm.La.apply(null,arguments)},t._UmbraTextureLoadGetData=function(){return t.asm.Ma.apply(null,arguments)},t._UmbraTextureMetaDataLoadGetData=function(){return t.asm.Na.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationCount=function(){return t.asm.Oa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassification=function(){return t.asm.Pa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationAmount=function(){return t.asm.Qa.apply(null,arguments)},t._UmbraSceneCreate=function(){return t.asm.Ra.apply(null,arguments)},t._UmbraSceneCreatePublic=function(){return t.asm.Sa.apply(null,arguments)},t._UmbraSceneCreateLocal=function(){return t.asm.Ta.apply(null,arguments)},t._UmbraSceneDestroy=function(){return t.asm.Ua.apply(null,arguments)},t._UmbraSceneGetConnectionStatus=function(){return t.asm.Va.apply(null,arguments)},t._UmbraSceneGetInfo=function(){return t.asm.Wa.apply(null,arguments)},t._UmbraSceneSetTransform=function(){return t.asm.Xa.apply(null,arguments)},t._UmbraSceneCopyCreate=function(){return t.asm.Ya.apply(null,arguments)},t._UmbraSceneCopyDestroy=function(){return t.asm.Za.apply(null,arguments)},t._UmbraSceneCopyGetStatus=function(){return t.asm._a.apply(null,arguments)},t._UmbraSceneCopyGetError=function(){return t.asm.$a.apply(null,arguments)},t._UmbraViewCreate=function(){return t.asm.ab.apply(null,arguments)},t._UmbraViewDestroy=function(){return t.asm.bb.apply(null,arguments)},t._UmbraViewUpdateRendering=function(){return t.asm.cb.apply(null,arguments)},t._UmbraViewUpdateFilter=function(){return t.asm.db.apply(null,arguments)},t._UmbraViewGetCompleted=function(){return t.asm.eb.apply(null,arguments)},t._UmbraViewResetRenderables=function(){return t.asm.fb.apply(null,arguments)},t._UmbraViewNextRenderables=function(){return t.asm.gb.apply(null,arguments)},t._UmbraViewRayQuery=function(){return t.asm.hb.apply(null,arguments)},t._UmbraSendInternalMessage=function(){return t.asm.ib.apply(null,arguments)};var Et=t.___getTypeName=function(){return t.asm.jb.apply(null,arguments)};t.___embind_register_native_and_builtin_types=function(){return t.asm.kb.apply(null,arguments)};var Bt=t.stackSave=function(){return t.asm.lb.apply(null,arguments)},Pt=t.stackAlloc=function(){return t.asm.mb.apply(null,arguments)},Mt=t.stackRestore=function(){return t.asm.nb.apply(null,arguments)},Rt=t.dynCall_vi=function(){return t.asm.ob.apply(null,arguments)};t.dynCall_v=function(){return t.asm.pb.apply(null,arguments)},t.dynCall_iiiiiiiiii=function(){return t.asm.qb.apply(null,arguments)},t.dynCall_viiiiiiiii=function(){return t.asm.rb.apply(null,arguments)},t.dynCall_iiiii=function(){return t.asm.sb.apply(null,arguments)},t.dynCall_iiii=function(){return t.asm.tb.apply(null,arguments)},t.dynCall_iii=function(){return t.asm.ub.apply(null,arguments)},t.dynCall_ii=function(){return t.asm.vb.apply(null,arguments)},t.dynCall_vii=function(){return t.asm.wb.apply(null,arguments)},t.dynCall_iiiiii=function(){return t.asm.xb.apply(null,arguments)},t.dynCall_viiiii=function(){return t.asm.yb.apply(null,arguments)},t.dynCall_iiiiiiii=function(){return t.asm.zb.apply(null,arguments)},t.dynCall_viiiiiii=function(){return t.asm.Ab.apply(null,arguments)},t.dynCall_i=function(){return t.asm.Bb.apply(null,arguments)};var Ft,kt=t.dynCall_viii=function(){return t.asm.Cb.apply(null,arguments)};function It(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function Gt(){function e(){if(!Ft&&(Ft=!0,!p)){if(k(G),k(D),t.onRuntimeInitialized&&t.onRuntimeInitialized(),t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;){var e=t.postRun.shift();W.unshift(e)}k(W)}}if(!(0<O)){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)N();k(I),0<O||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),e()}),1)):e())}}if(t.dynCall_viiii=function(){return t.asm.Db.apply(null,arguments)},t.dynCall_jiji=function(){return t.asm.Eb.apply(null,arguments)},t.dynCall_iidiiii=function(){return t.asm.Fb.apply(null,arguments)},t.dynCall_viiiiii=function(){return t.asm.Gb.apply(null,arguments)},t.asm=At,t.cwrap=function(e,t,n,r){var a=(n=n||[]).every((function(e){return"number"===e}));return"string"!==t&&a&&!r?y(e):function(){return g(e,t,n,arguments)}},t.then=function(e){if(Ft)e(t);else{var n=t.onRuntimeInitialized;t.onRuntimeInitialized=function(){n&&n(),e(t)}}return t},V=function e(){Ft||Gt(),Ft||(V=e)},t.run=Gt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();return Gt(),t.maxBytesDownloaded=0,t.minBytesDownloaded=0,t.URLsDownloaded=new Set([]),t.wgetRequests=bt,e});!function(e){e[e.ColumnMajor=0]="ColumnMajor",e[e.RowMajor=1]="RowMajor",e[e.Count=2]="Count"}(r||(r={})),function(e){e[e.Diffuse=0]="Diffuse",e[e.Normal=1]="Normal",e[e.Specular=2]="Specular",e[e.MetaIndex=3]="MetaIndex",e[e.Count=4]="Count"}(a||(a={})),function(e){e[e.RGBA32=0]="RGBA32",e[e.RGB24=1]="RGB24",e[e.BC1=2]="BC1",e[e.BC3=3]="BC3",e[e.BC4=4]="BC4",e[e.BC5=5]="BC5",e[e.ETC1_RGB=6]="ETC1_RGB",e[e.RGBA_FLOAT32=7]="RGBA_FLOAT32",e[e.UNC1=8]="UNC1",e[e.JPEG=9]="JPEG",e[e.PNG=10]="PNG",e[e.BMP=11]="BMP",e[e.PSD=12]="PSD",e[e.TGA=13]="TGA",e[e.GIF=14]="GIF",e[e.HDR=15]="HDR",e[e.PIC=16]="PIC",e[e.PNM=17]="PNM",e[e.ASTC_4X4=18]="ASTC_4X4",e[e.ASTC_5X4=19]="ASTC_5X4",e[e.ASTC_5X5=20]="ASTC_5X5",e[e.ASTC_6X5=21]="ASTC_6X5",e[e.ASTC_6X6=22]="ASTC_6X6",e[e.ASTC_8X5=23]="ASTC_8X5",e[e.ASTC_8X6=24]="ASTC_8X6",e[e.ASTC_10X5=25]="ASTC_10X5",e[e.ASTC_10X6=26]="ASTC_10X6",e[e.ASTC_8X8=27]="ASTC_8X8",e[e.ASTC_10X8=28]="ASTC_10X8",e[e.ASTC_10X10=29]="ASTC_10X10",e[e.ASTC_12X10=30]="ASTC_12X10",e[e.ASTC_12X12=31]="ASTC_12X12",e[e.ARGB32=32]="ARGB32",e[e.R8=33]="R8",e[e.PVRTC1_RGB4=34]="PVRTC1_RGB4",e[e.PVRTC1_RGBA4=35]="PVRTC1_RGBA4",e[e.UINT8=36]="UINT8",e[e.UINT16=37]="UINT16",e[e.UINT32=38]="UINT32",e[e.RGB565=39]="RGB565",e[e.RG8=40]="RG8",e[e.RG16F=41]="RG16F",e[e.OPENEXR=42]="OPENEXR",e[e.RGBA_FLOAT16=43]="RGBA_FLOAT16",e[e.RGB_FLOAT16=44]="RGB_FLOAT16",e[e.RGB_FLOAT32=45]="RGB_FLOAT32",e[e.BC6H=46]="BC6H",e[e.BC7=47]="BC7",e[e.Count=48]="Count"}(i||(i={})),function(e){e[e.Linear=0]="Linear",e[e.SRGB=1]="SRGB",e[e.Count=2]="Count"}(o||(o={})),function(e){e[e.Position=0]="Position",e[e.TextureCoordinate=1]="TextureCoordinate",e[e.Normal=2]="Normal",e[e.Tangent=3]="Tangent",e[e.Count=4]="Count"}(s||(s={})),function(e){e[e.UncachedMemory=1]="UncachedMemory"}(u||(u={})),function(e){e[e.Debug=0]="Debug",e[e.Info=1]="Info",e[e.Warning=2]="Warning",e[e.Error=3]="Error",e[e.Count=4]="Count"}(l||(l={})),function(e){e[e.Inactive=0]="Inactive",e[e.Active=1]="Active",e[e.Complete=2]="Complete",e[e.Error=3]="Error",e[e.Count=4]="Count"}(c||(c={})),function(e){e[e.Found=0]="Found",e[e.Not_Found=1]="Not_Found",e[e.Transfer_Not_Complete=2]="Transfer_Not_Complete",e[e.Buffer_Too_Small=3]="Buffer_Too_Small",e[e.Count=4]="Count"}(m||(m={})),function(e){e[e.Get=0]="Get",e[e.Post=1]="Post",e[e.Put=2]="Put",e[e.Delete=3]="Delete",e[e.Count=4]="Count"}(d||(d={})),function(e){e[e.Version=0]="Version",e[e.Copyright=1]="Copyright",e[e.BuildTime=2]="BuildTime",e[e.BuildId=3]="BuildId",e[e.Count=4]="Count"}(f||(f={})),function(e){e[e.InvalidUserPointer=0]="InvalidUserPointer"}(h||(h={})),function(e){e[e.None=0]="None",e[e.BC1=1]="BC1",e[e.BC2=2]="BC2",e[e.BC3=4]="BC3",e[e.BC4=8]="BC4",e[e.BC5=16]="BC5",e[e.BC6H=32]="BC6H",e[e.BC7=64]="BC7",e[e.ASTC=128]="ASTC",e[e.ETC1=256]="ETC1",e[e.ETC2=512]="ETC2",e[e.EAC_R=1024]="EAC_R",e[e.EAC_RG=2048]="EAC_RG",e[e.PVRTC1=4096]="PVRTC1",e[e.PVRTC2=8192]="PVRTC2",e[e.ATC=16384]="ATC",e[e.HalfFloat=32768]="HalfFloat",e[e.Float=65536]="Float",e[e.All=2147483647]="All"}(p||(p={})),function(e){e[e.NeverUnload=1]="NeverUnload",e[e.ExclusiveRendering=2]="ExclusiveRendering",e[e.EnableRayQueries=4]="EnableRayQueries"}(b||(b={})),function(e){e[e.Connected=0]="Connected",e[e.Connecting=1]="Connecting",e[e.ConnectionError=2]="ConnectionError",e[e.Count=3]="Count"}(y||(y={})),function(e){e[e.ZeroToOne=0]="ZeroToOne",e[e.MinusOneToOne=1]="MinusOneToOne",e[e.Count=2]="Count"}(g||(g={})),function(e){e[e.Sphere=0]="Sphere",e[e.Cylinder=1]="Cylinder",e[e.None=2]="None",e[e.Count=3]="Count"}(w||(w={})),function(e){e[e.InProgress=0]="InProgress",e[e.Done=1]="Done",e[e.Error=2]="Error",e[e.Count=3]="Count"}(v||(v={})),function(e){e[e.File=0]="File",e[e.Directory=1]="Directory",e[e.FormatObj=3]="FormatObj",e[e.IndexJson=4]="IndexJson",e[e.Count=5]="Count"}(S||(S={})),function(e){e[e.Directory=0]="Directory",e[e.Cloud=1]="Cloud",e[e.Count=2]="Count"}(C||(C={})),function(e){e[e.Material=0]="Material",e[e.Texture=1]="Texture",e[e.Mesh=2]="Mesh",e[e.Count=3]="Count"}(U||(U={})),function(e){e[e.Failure=0]="Failure",e[e.OutOfMemory=1]="OutOfMemory",e[e.Aborted=2]="Aborted",e[e.Success=3]="Success",e[e.Count=4]="Count"}(T||(T={})),function(e){e[e.BackfaceCulling=1]="BackfaceCulling"}(A||(A={}));const L="Int8",x="Int16",E="Int32",B="Uint8",P="Uint16",M="Uint32",R="Float32",F="Float64";class k{constructor(e,t){if(this.workers=[],this.infos=[],this.aborted=!1,window.Worker)for(let n=0;n<e;n++){const e=new Worker(t);e.onmessage=e=>{const{userData:t,resolve:r}=this.infos[n].queue.shift();this.aborted||(e.data.finalResponse?r({buffer:e.data.data,userData:t}):console.error("emscripten_worker_respond_provisionally is not supported"))},e.onerror=e=>{if(console.error(`Worker call failed. Is worker's script URL "${t}" correct? Message:`,e.message),this.infos[n].queue.length>0){const{userData:t,reject:r}=this.infos[n].queue.shift();r({userData:t,error:e})}};const r={queue:[]};this.workers.push(e),this.infos.push(r)}else console.error("WebWorker support required")}destroy(){this.aborted=!0;for(const e of this.workers)e.terminate()}callWorker(e,t,n,r){const a={funcName:t,callbackId:"",data:n};return this.workers[e].postMessage(a,[n.buffer]),new Promise(((t,n)=>{this.infos[e].queue.push({resolve:t,reject:n,userData:r})}))}findMostAvailableWorker(){let e=-1,t=1e9;for(let n=0;n<this.workers.length;n++)this.infos[n].queue.length<t&&(e=n,t=this.infos[n].queue.length);return e}shortestQueueLength(){let e=1e9;for(const t of this.infos)e=Math.min(e,t.queue.length);return e}numLoadsPending(){let e=0;for(const t of this.infos)e+=t.queue.length;return e}numWorkers(){return this.workers.length}}function I(e){if(!Number.isInteger(e))throw new Error("Value was not integer: "+e.toString())}function G(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}const D=e=>{const t=new Map([[L,Int8Array],[x,Int16Array],[E,Int32Array],[B,Uint8Array],[P,Uint16Array],[M,Uint32Array],[R,Float32Array],[F,Float64Array]]),n=new Map([[i.RGB565,P],[i.RGBA32,B],[i.RG8,B],[i.RG16F,P],[i.RGB_FLOAT32,R],[i.RGB24,B],[i.UINT32,M]]);class a{constructor(t){if(0===t)throw new Error("Buffer size was zero");if(this.ptr=e.umbraAlloc(t),0===this.ptr)throw new Error(`Allocation of ${t} bytes failed.`);this.size=t}destroy(){e.umbraFree(this.ptr),this.ptr=0,this.size=0}ensureSize(t){if(this.size<t){if(this.destroy(),this.ptr=e.umbraAlloc(t),0===this.ptr)throw new Error(`Buffer growth to ${t} bytes failed.`);this.size=t}}floats(){return new Float32Array(e.HEAPF32.buffer,this.ptr,this.size/4)}bytes(){return new Uint8Array(e.HEAPU8.buffer,this.ptr,this.size)}}class o{constructor(e,n,r){if(this.primitiveToHeap=new Map([[L,"HEAP8"],[x,"HEAP16"],[E,"HEAP32"],[B,"HEAPU8"],[P,"HEAPU16"],[M,"HEAPU32"],[R,"HEAPF32"],[F,"HEAPF64"]]),this.ptr=e,this.size=n,!this.primitiveToHeap.has(r)||!t.has(r))throw new TypeError(`BufferView constructor got invalid type '${r}'`);this.heapName=this.primitiveToHeap.get(r),this.arrayType=t.get(r)}getArray(){return new this.arrayType(e[this.heapName].buffer,this.ptr,this.size/this.arrayType.BYTES_PER_ELEMENT)}}const s=e.getRenderableMemberOffsets();function u(e,t){for(let n=0;n<16;n++)e[n]=t[n]}class l{constructor(){this.configPtr=e.umbraAlloc(e.CONFIG_SIZE),e.configInit(this.configPtr),this.ptr=e.clientCreate("UmbraJS",this.configPtr)}destroy(){e.clientDestroy(this.ptr),e.umbraFree(this.configPtr),this.ptr=0}}class c{constructor(t){this.matrixBuffer=new a(64),this.infoBuffer=new a(e.sceneInfoSize),this.ptr=t}destroy(){this.matrixBuffer.destroy(),this.infoBuffer.destroy(),e.sceneDestroy(this.ptr),this.ptr=0}connectionStatus(){return e.sceneGetConnectionStatus(this.ptr)}getInfo(){return e.sceneGetInfo(this.ptr,this.infoBuffer.ptr),e.deserializeSceneInfo(this.infoBuffer.ptr)}isConnected(){return this.connectionStatus()===y.Connected}setTransform(t){if(!G(t))throw new TypeError("Matrix should be an array");if(16!==t.length)throw new TypeError("Matrix should be of size 4x4");u(this.matrixBuffer.floats(),t),e.sceneSetTransform(this.ptr,this.matrixBuffer.ptr)}}class m{constructor(e,t){this.ptr=e,this.matrixBuffer=new a(64),this.vectorBuffer=new a(16),this.lightBuffer=new a(384),this.temp=void 0,this.runtimeAssets=t}destroy(){this.matrixBuffer.destroy(),this.vectorBuffer.destroy(),this.lightBuffer.destroy(),this.temp&&this.temp.destroy(),e.viewDestroy(this.ptr),this.ptr=0}setCamera(t,n,a,i=[],o=g.MinusOneToOne,s=r.ColumnMajor){if(!G(t))throw new TypeError("Camera matrix should be an array");if(!G(n))throw new TypeError("Position should be an array");if("number"!=typeof a)throw new TypeError("Quality should be a number");if(16!==t.length)throw new TypeError("WorldToClip matrix should be of size 4x4");if(3!==n.length)throw new TypeError("Position vector should be of length 3");var l,c;if(u(this.matrixBuffer.floats(),t),l=this.vectorBuffer.floats(),c=n,l[0]=c[0],l[1]=c[1],l[2]=c[2],i){if(i.length>32)throw new Error("Too many lights given");const e=this.lightBuffer.floats();for(let t=0;t<i.length;t++)e[3*t+0]=i[t][0],e[3*t+1]=i[t][1],e[3*t+2]=i[t][2]}e.viewUpdateRendering(this.ptr,this.matrixBuffer.ptr,this.vectorBuffer.ptr,o,s,a,this.lightBuffer.ptr,i.length)}getVisible(t){I(t);const n=t*e.renderableSize;(!this.temp||this.temp.size<n)&&(this.temp&&this.temp.destroy(),this.temp=new a(n));const r=this.temp,i=e.renderableSize/4,o=n/4;I(i),I(o);const u=(e,t,n,r)=>(I(r/4),new e(t.buffer,n+r,o-r/4)),l=u(Uint32Array,e.HEAPU32,r.ptr,s.mesh),c=u(Int32Array,e.HEAP32,r.ptr,s.lodLevel),m=u(Uint32Array,e.HEAPU32,r.ptr,s.visibilityMask),d=u(Uint32Array,e.HEAPU32,r.ptr,s.scene),f=e.viewNextRenderables(this.ptr,r.ptr,t),h=[];for(let e=0;e<f;e++){const t=l[i*e],n=c[i*e],r=m[i*e],a=d[i*e];h.push({id:t,mesh:this.runtimeAssets.get(t),lod:n,mask:r,scenePtr:a})}return h}}class d{constructor(t,n){this.ptr=t,this.assetType=e.assetLoadGetType(this.ptr),this.type="Load"+U[this.assetType],this.data={},this.assetUserPointer=n}prepare(){e.assetLoadPrepare(this.ptr,this.assetUserPointer)}finish(t){e.assetLoadFinish(this.ptr,t)}}class f{constructor(t){this.ptr=t,this.assetType=e.assetUnloadGetType(this.ptr),this.type="Unload"+U[this.assetType],this.userPointer=e.assetUnloadGetUserPointer(this.ptr)}finish(){e.assetUnloadFinish(this.ptr)}}class h{constructor(t,{features:n={textureSupportMask:0,formats:[],srgb:!1,halfFloat:!1},flags:r=0},{workerScriptURL:i,numWorkers:o=0}){this.assets=new Map,this.nextId=1,this.tempTextureBuffer=new a(1048576),this.tempStreamingStateBuffer=new a(e.streamingStateSize),this.tempDispatchBuffer=new a(1),this.stats={numUpdates:0,meshPipelineMemoryUse:0,texturePipelineMemoryUse:0,numWorkerLoadsPending:0,perFrameLoadedTextures:0,perFrameLoadedTextureBytes:0,perFrameLoadedMeshes:0,perFrameLoadedMeshBytes:0,numInstantUnloads:0,assetLoadTimes:new Map},this.limits={streamingPipeSizeLimit:1<<19,maxWorkQueueLength:10},this.loadPromises=new Map;const s=p.ETC1|p.ASTC|p.PVRTC1|p.BC5;let u=n.textureSupportMask;u&s||(u|=p.BC5|p.BC4),this.client=t;const l=e.serializeEnvironmentInfo({textureSupportFlags:u,localCacheDirectory:null,localCacheMaximumByteSize:0},0);this.ptr=e.runtimeCreate(t.ptr,l,r),e.umbraFree(l),this.platformFeatures=n;const c=Math.max(e.meshInfoSize,e.materialInfoSize,e.textureInfoSize,e.byteBufferSize);this.scratch=new a(c),this.debug={textureFormatsInUse:new Set,platformFeatures:n,trackInstantUnloads:!1},0==o&&(o=Math.min(Math.max(1,("hardwareConcurrency"in navigator?navigator.hardwareConcurrency:1)-2),8)),this.workerPool=new k(o,i)}destroy(){this.workerPool.destroy(),this.tempTextureBuffer.destroy(),this.tempStreamingStateBuffer.destroy(),this.tempDispatchBuffer.destroy(),this.scratch.destroy(),e.runtimeDestroy(this.ptr),this.client.destroy(),this.ptr=0}createScenePublic(t){const n=e.sceneCreatePublic(this.ptr,t);if(n)return new c(n)}createScene(t,n){const r=e.sceneCreate(this.ptr,t,n);if(r)return new c(r)}createSceneLocal(t){const n=e.sceneCreateLocal(this.ptr,t);if(n)return new c(n)}setHandlers(e){this.handlers=e}createView(){const t=e.viewCreate(this.ptr);return new m(t,this.assets)}update(){e.runtimeUpdate(this.ptr)}*getAssetUnloads(){let t=e.runtimeNextAssetUnload(this.ptr);for(;0!==t;){const n=new f(t);n.data=this.assets.get(n.userPointer),yield n,t=e.runtimeNextAssetUnload(this.ptr)}}async dispatchTextureLoad(t){const r=this.scratch.ptr;e.textureLoadGetInfo(t.ptr,r);const a=e.deserializeTextureInfo(r),s=this.formatNeedsTranscoding(a.format);let u;t.prepare();let l=0;if(s){const r=e.textureLoadGetSerializedSize(t.ptr),a=r+e.textureLoadDispatchHeaderSize;this.tempDispatchBuffer.ensureSize(a);const s=this.tempDispatchBuffer;if(void 0===e.convertAssetLoadToTextureDispatch(t.ptr,t.assetUserPointer,this.platformFeatures.textureSupportMask,this.platformFeatures.srgb,s.ptr,a))throw t.finish(T.Failure),new Error("convertAssetLoadToTextureDispatch failed");const c=2*a;this.stats.texturePipelineMemoryUse+=c;const m=this.workerPool.findMostAvailableWorker();let d;try{({buffer:d}=await this.workerPool.callWorker(m,"loadTexture",new Uint8Array(s.bytes()),{load:t,memoryUse:c}))}catch({error:e}){throw t.finish(T.Failure),e}this.stats.texturePipelineMemoryUse-=c,this.stats.perFrameLoadedTextures+=1,this.stats.perFrameLoadedTextureBytes+=r,l=e.umbraAlloc(d.byteLength),e.HEAP8.set(d,l),d=void 0;const f=e.deserializeTextureLoadResult(l).textureInfo;let h=B;n.has(f.format)?h=n.get(f.format):console.warn("Used default datatype for texture format "+i[f.format]);u={info:f,buffer:new o(l+e.textureLoadResultHeaderSize,f.dataByteSize,h)}}else{const n=this.tempTextureBuffer;if(n.ensureSize(a.dataByteSize),e.serializeByteBuffer({ptr:n.ptr,byteSize:a.dataByteSize,flags:0},this.scratch.ptr),!e.textureLoadGetData(t.ptr,this.scratch.ptr))throw t.finish(T.Failure),new Error(`textureLoadGetData failed: ${t.ptr}, ${n.ptr}, ${a.dataByteSize}/${n.size}`);u={info:a,buffer:new o(n.ptr,a.dataByteSize,B)}}try{const n=this.handlers.LoadTexture(u,t.assetUserPointer);return t.finish(n),n===T.Success&&(this.debug.textureFormatsInUse.add(u.info.format),this.debug.trackInstantUnloads&&this.stats.assetLoadTimes.set(t.assetUserPointer,this.stats.numUpdates)),n}catch(e){throw t.finish(T.Failure),console.error(e),e}finally{l>0&&e.umbraFree(l)}}async dispatchMaterialLoad(t){t.prepare(),e.materialLoadGetInfo(t.ptr,this.scratch.ptr);const n=e.deserializeMaterialInfo(this.scratch.ptr),r=n.textures.filter((t=>t!==e.INVALID_USERPOINTER)),a=r.map((e=>this.loadPromises.get(e))).map((e=>e.catch((e=>e)))),i=await Promise.all(a);r.forEach((e=>this.loadPromises.delete(e)));for(const e of i)if(e instanceof Error)throw t.finish(T.Failure),e;const o=i;for(const e of o)if(e!==T.Success)return t.finish(T.Aborted),T.Aborted;const s=r.map((e=>this.assets.get(e))),u={transparent:n.transparent,textures:s};try{const e=this.handlers.LoadMaterial(u,t.assetUserPointer);return t.finish(e),e}catch(e){throw t.finish(T.Failure),console.error(e),e}}async dispatchMeshLoad(t){e.meshLoadGetInfo(t.ptr,this.scratch.ptr);const n=e.deserializeMeshInfo(this.scratch.ptr);t.prepare();const r=e.meshLoadGetSerializedSize(t.ptr),a=e.meshLoadDispatchHeaderSize+r;this.tempDispatchBuffer.ensureSize(a);const i=this.tempDispatchBuffer;0!=(15&i.ptr)&&console.error("buf.ptr wasn't aligned: "+i.ptr);const s=e.convertAssetLoadToMeshDispatch(t.ptr,t.assetUserPointer,i.ptr,a),u=n.material,l=this.loadPromises.get(u);if(void 0===l)throw t.finish(T.Failure),new Error(`Material UserPointer ${u} didn't have a promise!`);const c=a+s.byteSize+e.meshLoadResultHeaderSize;this.stats.meshPipelineMemoryUse+=c;const m=this.workerPool.findMostAvailableWorker();let d;try{({buffer:d}=await this.workerPool.callWorker(m,"loadMesh",new Uint8Array(i.bytes()),{}))}catch({error:e}){throw t.finish(T.Failure),e}finally{this.stats.meshPipelineMemoryUse-=c,this.stats.perFrameLoadedMeshes+=1,this.stats.perFrameLoadedMeshBytes+=r}const f=d.length*d.BYTES_PER_ELEMENT,h=e.umbraAlloc(f);e.HEAP8.set(d,h),d=void 0;const p=e.deserializeMeshLoadResult(h);let b,y=!1;if(p.result!==T.Success&&(b="Asset load failed with "+T[p.result],y=!0),p.assetLoad!==t.ptr&&(b=`Asset load ptr didn't match ${p.assetLoad} vs ${t.ptr}`,y=!0),y)throw e.umbraFree(h),t.finish(T.Failure),Error(b);const g=h+e.meshLoadResultHeaderSize,w=e.meshLoadResultBuildUmbraBuffers(h,g),v={position:R,uv:R,normal:R,tangent:R,index:2===w.index.elementByteSize?P:M},S={};for(const e of Object.keys(w)){const t={},n=w[e],r=n.elementCapacity*n.elementStride;t.data=new o(n.ptr,r,v[e]),t.desc=n,S[e]=t}let C=T.Failure;try{C=await l}catch(n){throw t.finish(T.Aborted),e.umbraFree(h),n}if(C!==T.Success)return t.finish(T.Aborted),e.umbraFree(h),T.Aborted;const U=this.assets.get(u);if(void 0===U)throw t.finish(T.Aborted),e.umbraFree(h),new Error(`Material ${u} had no asset object.`);const A={buffers:S,material:U,bounds:[n.bounds.mn,n.bounds.mx]};let _=T.Failure;try{if(_=this.handlers.LoadMesh(A,t.assetUserPointer),_!==T.Success)return t.finish(_),_;e.meshLoadFinishExternalWithLoadResultHeader(t.ptr,h,g)}catch(e){throw t.finish(T.Failure),e}finally{e.umbraFree(h)}return _}loadAssets(t){const n=performance.now();for(const e of this.getAssetUnloads()){if(this.debug.trackInstantUnloads){const t=this.stats.assetLoadTimes.get(e.userPointer);this.stats.numUpdates-t<3&&(this.stats.numInstantUnloads+=1)}const r=this.assets.get(e.userPointer);if(this.loadPromises.delete(e.userPointer),this.handlers[e.type](r,e.userPointer),e.finish(),performance.now()-n>t)break}do{const t=e.runtimeNextAssetLoad(this.ptr);if(0===t)break;let n;const r=new d(t,this.getNextUserPointer());"LoadTexture"===r.type?n=this.dispatchTextureLoad(r):"LoadMaterial"===r.type?n=this.dispatchMaterialLoad(r):"LoadMesh"===r.type&&this.dispatchMeshLoad(r),void 0!==n&&this.loadPromises.set(r.assetUserPointer,n);const a=this.stats.meshPipelineMemoryUse+this.stats.texturePipelineMemoryUse,i=this.workerPool.shortestQueueLength();if(i>0&&a>=this.limits.streamingPipeSizeLimit)break;if(i>=this.limits.maxWorkQueueLength)break}while(performance.now()-n<t);this.stats.numUpdates+=1,this.stats.numWorkerLoadsPending=this.workerPool.numLoadsPending(),this.stats.perFrameLoadedTextures=0,this.stats.perFrameLoadedTextureBytes=0,this.stats.perFrameLoadedMeshes=0,this.stats.perFrameLoadedMeshBytes=0}getNextUserPointer(){const e=this.nextId;return this.nextId=this.nextId+1|0,0===this.nextId&&(this.nextId=1),e}addAsset(e,t){this.assets.set(e,t)}removeAsset(e){this.assets.has(e)&&this.assets.delete(e)}formatNeedsTranscoding(e){const t=this.platformFeatures.textureSupportMask;switch(e){case i.BC1:if(t&p.BC1)return!1;break;case i.BC3:if(t&p.BC3)return!1;break;case i.BC4:if(t&p.BC4)return!1;break;case i.BC5:if(t&p.BC5)return!1;break;default:return!1}return!0}getStreamingState(){return e.runtimeGetStreamingState(this.ptr,this.tempStreamingStateBuffer.ptr),e.deserializeStreamingState(this.tempStreamingStateBuffer.ptr)}getStreamingProgress(){const e=this.getStreamingState();return 0==e.numResidentTiles?0:e.numResidentTilesLoaded/e.numResidentTiles}getNumberOfWorkers(){return this.workerPool.numWorkers()}}return{createRuntime:t=>new h(new l,t,e.umbraLibraryConfig)}};let z="";if("undefined"!=typeof document&&document.currentScript){const e=document.currentScript.src;"undefined"!==e&&(z=e.substr(0,e.lastIndexOf("/")+1))}const W=function(e){const t={wasmURL:z+"umbra.wasm",workerScriptURL:z+"UmbraAssetWorker.js"};return e=Object.assign(t,e),new Promise(((t,n)=>{try{_({locateFile:(t,n)=>t.endsWith("umbra.wasm")?e.wasmURL:n+t}).then((r=>{delete r.then,r.onAbort=e=>{n(e)},function(e){Object.assign(e,{configInit:e.cwrap("UmbraConfigInit",null,["number"]),clientCreate:e.cwrap("UmbraClientCreate","number",["string","number"]),clientDestroy:e.cwrap("UmbraClientDestroy",null,["number"]),getLibraryInfo:e.cwrap("UmbraGetLibraryInfo","string",["number"]),environmentInfoDefaults:e.cwrap("UmbraEnvironmentInfoDefaults",null,["number"]),runtimeCreate:e.cwrap("UmbraRuntimeCreate","number",["number","number","number"]),runtimeUpdate:e.cwrap("UmbraRuntimeUpdate",null,["number"]),runtimeGetStreamingState:e.cwrap("UmbraRuntimeGetStreamingState",null,["number","number"]),runtimeDestroy:e.cwrap("UmbraRuntimeDestroy",null,["number"]),sceneCreate:e.cwrap("UmbraSceneCreate","number",["number","string","string"]),sceneCreatePublic:e.cwrap("UmbraSceneCreatePublic","number",["number","string"]),sceneCreateLocal:e.cwrap("UmbraSceneCreateLocal","number",["number","string"]),sceneGetConnectionStatus:e.cwrap("UmbraSceneGetConnectionStatus","number",["number"]),sceneGetInfo:e.cwrap("UmbraSceneGetInfo","number",["number","number"]),sceneSetTransform:e.cwrap("UmbraSceneSetTransform",null,["number","number"]),sceneDestroy:e.cwrap("UmbraSceneDestroy",null,["number"]),viewCreate:e.cwrap("UmbraViewCreate","number",["number"]),viewUpdateRendering:e.cwrap("UmbraViewUpdateRendering",null,["number","number","number","number","number","number","number","number"]),viewUpdateFilter:e.cwrap("UmbraViewUpdateFilter",null,["number","number"]),viewGetCompleted:e.cwrap("UmbraViewGetCompleted","number",["number"]),viewNextRenderables:e.cwrap("UmbraViewNextRenderables","number",["number","number","number"]),viewResetRenderables:e.cwrap("UmbraViewResetRenderables",null,["number"]),viewDestroy:e.cwrap("UmbraViewDestroy",null,["number"]),viewRayQuery:e.cwrap("UmbraViewRayQuery","number",["number","number","number","number","number","number"]),sceneCopyCreate:e.cwrap("UmbraSceneCopyCreate","number",["number","number","number","number","number"]),sceneCopyGetStatus:e.cwrap("UmbraSceneCopyGetStatus","number",["number","number"]),sceneCopyGetError:e.cwrap("UmbraSceneCopyGetError","string",["number"]),sceneCopyDestroy:e.cwrap("UmbraSceneCopyDestroy",null,["number"]),vertexAttributeGetElementByteSize:e.cwrap("UmbraVertexAttributeGetElementByteSize","number",["number"]),runtimeNextAssetLoad:e.cwrap("UmbraRuntimeNextAssetLoad","number",["number"]),assetLoadGetType:e.cwrap("UmbraAssetLoadGetType","number",["number"]),assetLoadPrepare:e.cwrap("UmbraAssetLoadPrepare",null,["number","number"]),assetLoadAbortRequested:e.cwrap("UmbraAssetLoadAbortRequested","number",["number"]),assetLoadFinish:e.cwrap("UmbraAssetLoadFinish",null,["number","number"]),meshLoadFinishExternal:e.cwrap("UmbraMeshLoadFinishExternal",null,["number","number","number","number"]),meshLoadGetInfo:e.cwrap("UmbraMeshLoadGetInfo",null,["number","number"]),meshLoadGetData:e.cwrap("UmbraMeshLoadGetData","number",["number","number","number"]),meshStreamSetBuffers:e.cwrap("UmbraMeshStreamSetBuffers","number",["number","number","number"]),meshStreamNext:e.cwrap("UmbraMeshStreamNext","number",["number","number","number"]),meshStreamDone:e.cwrap("UmbraMeshStreamDone","number",["number"]),meshLoadGetSerializedSize:e.cwrap("UmbraMeshLoadGetSerializedSize","number",["number"]),textureGetMipmapLevelByteSize:e.cwrap("UmbraTextureGetMipmapLevelByteSize","number",["number","number"]),textureGetMipmapLevelOffset:e.cwrap("UmbraTextureGetMipmapLevelOffset","number",["number","number"]),textureLoadGetInfo:e.cwrap("UmbraTextureLoadGetInfo",null,["number","number"]),textureLoadGetData:e.cwrap("UmbraTextureLoadGetData","number",["number","number"]),textureLoadGetSerializedSize:e.cwrap("UmbraTextureLoadGetSerializedSize","number",["number"]),textureMetaDataLoadGetData:e.cwrap("UmbraTextureMetaDataLoadGetData","number",["number","number"]),textureMetaDataGetClassificationCount:e.cwrap("UmbraTextureMetaDataGetClassificationCount","number",["number","number"]),textureMetaDataGetClassification:e.cwrap("UmbraTextureMetaDataGetClassification","number",["number","number","number"]),textureMetaDataGetClassificationAmount:e.cwrap("UmbraTextureMetaDataGetClassificationAmount","number",["number","number","number"]),materialLoadGetInfo:e.cwrap("UmbraMaterialLoadGetInfo",null,["number","number"]),runtimeNextAssetUnload:e.cwrap("UmbraRuntimeNextAssetUnload","number",["number"]),assetUnloadGetType:e.cwrap("UmbraAssetUnloadGetType","number",["number"]),assetUnloadGetUserPointer:e.cwrap("UmbraAssetUnloadGetUserPointer","number",["number"]),assetUnloadFinish:e.cwrap("UmbraAssetUnloadFinish",null,["number"]),sendInternalMessage:e.cwrap("UmbraSendInternalMessage","number",["number","number"])})}(r),t(function(e,t){const n={getPlatformFeatures:e=>{let t=0;const n=new Set;let r=!1,a=!1;const i=new Map([]),o=[],s=e.getSupportedExtensions();for(const e of s){const t=e.replace(/^(.*)_WEBGL_/,"WEBGL_");i.set(t,e),o.push(t)}const u=new Map([["WEBGL_compressed_texture_s3tc",{mask:p.BC1|p.BC2|p.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_s3tc_srgb",{mask:p.BC1|p.BC2|p.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_rgtc",{mask:p.BC4|p.BC5,names:["bc4","bc5"]}],["WEBGL_compressed_texture_pvrtc",{mask:p.PVRTC1,names:["pvrtc1_rgb4","pvrtc1_rgba4"]}],["WEBGL_compressed_texture_etc1",{mask:p.ETC1,names:["etc1_rgb"]}],["WEBGL_compressed_texture_astc",{mask:p.ASTC,names:["astc_4x4"]}]]);for(const r of u.keys())if(o.includes(r)){e.getExtension(i.get(r));const a=u.get(r);t|=a.mask,a.names.forEach((e=>n.add(e)))}return o.includes("WEBGL_compressed_texture_s3tc_srgb")&&(r=!0),o.includes("EXT_sRGB")&&(e.getExtension(i.get("EXT_sRGB")),r=!0),o.includes("OES_texture_half_float")&&(e.getExtension(i.get("OES_texture_half_float")),a=!0),{textureSupportMask:t,formats:[...n],srgb:r,halfFloat:a}}};return n.nativeModule=e,n.nativeModule.umbraLibraryConfig=t,n.createRuntime=D(e).createRuntime,n.getStreamingInfo=()=>({minBytesDownloaded:n.nativeModule.minBytesDownloaded,maxBytesDownloaded:n.nativeModule.maxBytesDownloaded}),n.getLibraryInfo=()=>({version:e.getLibraryInfo(f.Version),copyright:e.getLibraryInfo(f.Copyright),buildTime:e.getLibraryInfo(f.BuildTime),buildID:e.getLibraryInfo(f.BuildId)}),n.abortDownloads=()=>{Object.values(e.wgetRequests).forEach((e=>{e.abort()}))},n}(r,e))}))}catch(e){n(e)}}))};function N(e,t,n){return{format:e,type:t,compressed:n}}const O={[i.RGB24]:N(t.RGBFormat,t.UnsignedByteType,!1),[i.RGBA32]:N(t.RGBAFormat,t.UnsignedByteType,!1),[i.RGB565]:N(t.RGBFormat,t.UnsignedShort565Type,!1),[i.RG8]:N(t.LuminanceAlphaFormat,t.UnsignedByteType,!1),[i.RG16F]:N(t.LuminanceAlphaFormat,t.HalfFloatType,!1),[i.BC1]:N(t.RGBA_S3TC_DXT1_Format,t.UnsignedByteType,!0),[i.BC3]:N(t.RGBA_S3TC_DXT5_Format,t.UnsignedByteType,!0),[i.ETC1_RGB]:N(t.RGB_ETC1_Format,t.UnsignedByteType,!0),[i.ASTC_4X4]:N(t.RGBA_ASTC_4x4_Format,t.UnsignedByteType,!0),[i.PVRTC1_RGB4]:N(t.RGB_PVRTC_4BPPV1_Format,t.UnsignedByteType,!0)};class V{constructor(e){this.flipTangent=!1,this.defines="",e.indexOf("bc3")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC3\n"),e.indexOf("bc5")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC5\n"),e.indexOf("astc_4x4")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_ASTC\n")}process(e,t){let n=e.fragmentShader;this.flipTangent&&(n="#define UMBRA_FLIP_TANGENT\n"+n),n=this.defines+n,n=n.replace("#include <normal_fragment_maps>","\n#ifdef USE_NORMALMAP\n#ifdef USE_TANGENT\n\nvec3 tangentToWorld2 = normal;\nvec3 tangentToWorld0 = normalize(tangent - tangentToWorld2 * dot(tangentToWorld2, tangent));\n\n#ifdef UMBRA_FLIP_TANGENT\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld0, tangentToWorld2));\n#else\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld2, tangentToWorld0));\n#endif\n\n#if defined(UMBRA_TEXTURE_SUPPORT_BC5) || defined(UMBRA_TEXTURE_SUPPORT_ASTC)\nnormal.xy = texture2D(normalMap, vUv).xy * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#elif defined(UMBRA_TEXTURE_SUPPORT_BC3)\nnormal.xy = texture2D(normalMap, vUv).yw * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#else\nnormal.xyz = texture2D(normalMap, vUv).xyz;\nnormal.xy *= 2.0;\nnormal.xy -= 1.0;\nnormal = normalize(normal);\n#endif\n\nnormal = tangentToWorld0 * normal.x + tangentToWorld1 * normal.y + tangentToWorld2 * normal.z;\nnormal = normalize(normal);\n#endif\n#endif\n\n"),n=n.replace("#include <metalnessmap_fragment>","\nfloat metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness = texture2D( metalnessMap, vUv );\nmetalnessFactor *= texelMetalness.r;\n#endif\n"),n=n.replace("#include <roughnessmap_fragment>","\nfloat roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness = texture2D( roughnessMap, vUv );\nfloat roughness = 1.0 - texelRoughness.g;\nroughnessFactor *= roughness;\n#endif\n"),e.fragmentShader=n}}class j{constructor(){this.usedList=[],this.freeList=[]}allocate(e,t){let n;if(this.freeList.length>0)if(void 0===t)n=this.freeList.pop();else for(let e=0;e<this.freeList.length;e++){const r=this.freeList[e];if(t(r)){n=r,this.freeList.splice(e,1);break}}return n||(n=e()),this.usedList.push(n),n}freeAll(e){for(let t=0;t<this.usedList.length;t++)e&&e(this.usedList[t]),this.freeList.push(this.usedList[t]);this.usedList.length=0}clear(){this.usedList.length=0,this.freeList.length=0}}class q extends t.Object3D{constructor(e,n,r,i,o,s){super(),this.material=new t.MeshBasicMaterial,this.wireframe=!1,this.freeze=!1,this.isLOD=!0,this.autoUpdate=!0,this.name="UmbraScene",this.materialPool=new j,this.stats={numVisible:0,numShadowCasters:0,numCachedMaterials:0,numAssets:0},this.diagnostics={missingNormals:{checked:!1,message:"UmbraScene has no normals so it will appear black."},deprecatedMaterial:{checked:!1,message:"Property umbraScene.opaqueMaterial has been deprecated. Use umbraScene.material instead."},report:e=>{this.diagnostics[e].checked||(this.diagnostics[e].checked=!0,console.warn(this.diagnostics[e].message))}},this.oldState={status:void 0,visibleIDs:new Set},this.update=function(e){if(this.freeze)return;if(0===this.umbra.nativeScene.ptr)return void console.warn("Renderer tried to update a disposed UmbraScene");let n=this.sharedState.cameraToView.get(e);if(n||(n=this.umbra.runtime.createView(),this.sharedState.cameraToView.set(e,n)),this.sharedState.viewLastUseFrame.set(n,this.renderer.info.render.frame),this.umbra.nativeScene.setTransform(this.matrixWorld.elements),this.isPBREnabled()){const e=this.matrixWorld.determinant()<0;e!==this.shaderPatcher.flipTangent&&(this.shaderPatcher.flipTangent=e,this.materialPool.clear())}this.stats.numVisible=0,this.stats.numAssets=this.umbra.runtime.assets.size;const r=[];for(let e=0;e<this.children.length;e++)this.children[e].isUmbraMesh||r.push(this.children[e]);this.children=r;const i=[],o=new t.Object3D;o.isLOD=!0,o.autoUpdate=!0,o.update=e=>{this.children.pop();for(let e=0;e<i.length;e++)this.children.push(i[e])},this.materialPool.freeAll((e=>{delete e.map,delete e.normalMap,delete e.metalnessMap,delete e.roughnessMap}));let s=[];const u=new Set;this.sharedState.viewRenderables.has(n)&&(s=this.sharedState.viewRenderables.get(n));for(let e=0;e<s.length;e++){if(s[e].scenePtr!==this.umbra.nativeScene.ptr)continue;const{materialDesc:n,geometry:r}=s[e].mesh;u.add(s[e].id),this.stats.numVisible+=1;const o=n.transparent||this.material.transparent,l=this.materialPool.allocate((()=>this.material.clone()),(e=>e.transparent===o));l.wireframe=this.wireframe,l.opacity=this.material.opacity,l.transparent=o,l.onBeforeCompile=(e,t)=>{this.material.onBeforeCompile&&this.material.onBeforeCompile.apply(l,[e,t]),this.shaderPatcher.process(e,t)};const c=n.textures[a.Diffuse],m=n.textures[a.Normal],d=n.textures[a.Specular];c&&c.isTexture&&(l.map=c),m&&m.isTexture&&(l.normalMap=m,l.vertexTangents=!0,l.normalMapType=t.TangentSpaceNormalMap),d&&d.isTexture&&(l.metalnessMap=d,l.metalness=1,l.roughnessMap=d,l.roughness=1);const f=new t.Mesh(r,l);f.isUmbraMesh=!0,f.matrixWorld.copy(this.matrixWorld),f.castShadow=this.castShadow,f.receiveShadow=this.receiveShadow,f.visible=!0,this.children.push(f),0==(1&s[e].mask)?(i.push(f),f.frustumCulled=!0):(this.children.push(f),f.frustumCulled=!1)}if(!this.diagnostics.missingNormals.checked&&this.isPBREnabled())for(let e=0;e<this.children.length;e++)if(this.children[e].isUmbraMesh&&!("normal"in this.children[e].geometry.attributes)){this.diagnostics.report("missingNormals");break}this.stats.numShadowCasters=i.length,this.stats.numCachedMaterials=this.materialPool.usedList.length+this.materialPool.freeList.length,i.length>0&&this.children.push(o),this.updateStreamingEvents(u)},this.renderer=i,this.sharedState=r,this.shaderPatcher=new V(o.formats),this.onDispose=s,this.scale.set(1,1,-1),this.umbra={runtime:e,nativeScene:n}}set quality(e){console.error("UmbraScene.quality is not supported any more. Use camera.umbraQuality instead.")}get opaqueMaterial(){return this.diagnostics.report("deprecatedMaterial"),this.material}set opaqueMaterial(e){this.diagnostics.report("deprecatedMaterial"),this.material=e}getInfo(){const e={connected:this.umbra.nativeScene.isConnected()};return e.connected&&(e.sceneInfo=this.umbra.nativeScene.getInfo()),Object.assign(e,this.stats),e}getBounds(){if(!this.umbra.nativeScene.isConnected())return;const e=this.umbra.nativeScene.getInfo().bounds,n=e.mn,r=e.mx;return new t.Box3(new t.Vector3(n[0],n[1],n[2]),new t.Vector3(r[0],r[1],r[2]))}getCenter(){const e=this.getBounds();e.applyMatrix4(this.matrixWorld);const n=new t.Vector3;return e.getCenter(n),n}updateStreamingEvents(e){const t=this.oldState.visibleIDs,n=e;if(this.onMeshChanged)if(t.size!==n.size)this.onMeshChanged();else for(const e of n)if(!t.has(e)){this.onMeshChanged();break}this.oldState.visibleIDs=e}updateNetworkEvents(){const e=this.umbra.nativeScene.connectionStatus();if(this.oldState.status!==e)switch(this.onConnectionChanged&&this.onConnectionChanged(e),e){case y.ConnectionError:this.onConnectionError&&this.onConnectionError("Could not connect");break;case y.Connected:this.onConnected&&this.onConnected();break;case y.Connecting:this.onDisconnected&&this.onDisconnected()}this.oldState.status=e}dispose(){this.onDispose&&this.onDispose(this),this.children=this.children.filter((e=>!e.isUmbraMesh)),this.materialPool.freeAll((e=>e.dispose())),this.umbra.nativeScene.destroy()}isPBREnabled(){return"normalMapType"in this.material}}class H extends t.Loader{constructor(e,t){super(t),this.Umbra=e}loadPublic(e,t,n,r){const a=this.Umbra.createScenePublic(e);r&&(a.onConnectionError=e=>{r(e)}),a.onConnected=()=>{delete a.onConnectionError,n&&n(1),t(a)}}}class X{constructor(e,n){let r;this.memoryLimit=524288e3,this.downloadLimit=0,this.qualityFactor=1,this.updateTask=void 0,this.assetSizes=new Map,this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.lastQualityLowerFrame=-1,this.umbraScenes=new Set,this.oldState={progress:0,downloadLimitReached:!1},this.sharedState={cameraToView:new Map,viewRenderables:new Map,viewLastUseFrame:new Map},this.tempVector=new t.Vector3,this.dirVector=new t.Vector3,this.matrixWorldInverse=new t.Matrix4,this.projScreenMatrix=new t.Matrix4,this.cameraWorldPosition=new t.Vector3,this.handlers={LoadMaterial:(e,t)=>{const n=e;return n.transparent=!!e.transparent,this.runtime.addAsset(t,n),T.Success},UnloadMaterial:(e,t)=>{this.runtime.removeAsset(t)},LoadTexture:(e,n)=>{const r=e.info,s=e.buffer;let u;if(O.hasOwnProperty(r.format)&&(u=O[r.format]),!u)return r.format!==i.UINT32&&console.log("Unknown texture format",i[r.format]),this.runtime.addAsset(n,{isTexture:!1}),T.Success;if(!this.canFitInMemory(s.size))return this.adjustQuality(.8),T.OutOfMemory;const l=this.makeTexture(r,s,u);let c=!1;return"outputEncoding"in this.renderer?c=this.renderer.outputEncoding===t.sRGBEncoding:"gammaOutput"in this.renderer&&(c=this.renderer.gammaOutput),r.type!==a.Diffuse||c?l.encoding=r.colorSpace===o.Linear?t.LinearEncoding:t.sRGBEncoding:l.encoding=t.LinearEncoding,l.needsUpdate=!0,this.textureMemoryUsed+=s.size,this.assetSizes.set(l,s.size),this.runtime.addAsset(n,l),T.Success},UnloadTexture:(e,t)=>{e.isTexture&&e.dispose(),this.assetSizes.has(e)&&(this.textureMemoryUsed-=this.assetSizes.get(e),this.assetSizes.delete(e)),this.runtime.removeAsset(t)},LoadMesh:(e,n)=>{const r={position:{components:3},normal:{components:3},uv:{components:2},tangent:{components:3}};let a=0;if(Object.keys(r).map((t=>e.buffers[t])).forEach((e=>{e&&(a+=e.data.size)})),!this.canFitInMemory(a))return this.adjustQuality(.8),T.OutOfMemory;const i=new t.BufferGeometry,o=e.buffers.index.data.getArray(),s=Array.from(o);i.setIndex(s),i.boundingSphere=function(e){const n=e[0],r=e[1],a=new t.Vector3(r[0]-n[0],r[1]-n[1],r[2]-n[2]),i=new t.Vector3(n[0]+.5*a.x,n[1]+.5*a.y,n[2]+.5*a.z);return new t.Sphere(i,a.length())}(e.bounds),Object.keys(r).forEach((n=>{const a=e.buffers[n];if(a){const e=a.data.getArray(),o=new t.Float32BufferAttribute(e.slice(),r[n].components);"setAttribute"in i?i.setAttribute(n,o):i.addAttribute(n,o)}}));const u={geometry:i,materialDesc:e.material};return this.meshMemoryUsed+=a,this.assetSizes.set(u,a),this.runtime.addAsset(n,u),T.Success},UnloadMesh:(e,t)=>{this.assetSizes.has(e)&&(this.meshMemoryUsed-=this.assetSizes.get(e),this.assetSizes.delete(e)),this.runtime.removeAsset(t),e.geometry.dispose()}},r="getContext"in n?n.getContext():n.context;const s=e.getPlatformFeatures(r);s.textureSupportMask&=~p.BC5,this.umbrajs=e,this.runtime=e.createRuntime({features:s}),this.runtime.setHandlers(this.handlers),this.renderer=n,this.features=s,this.startEventUpdate(1e3/60)}get memoryUsed(){return this.textureMemoryUsed+this.meshMemoryUsed}startEventUpdate(e){this.stopEventUpdate(),this.updateTask=window.setInterval((()=>{this.updateEvents(),this.umbraScenes.forEach((e=>e.updateNetworkEvents()))}),e)}stopEventUpdate(){void 0!==this.updateTask&&(window.clearInterval(this.updateTask),delete this.updateTask)}findLights(e){let t;if(e.traverseAncestors((e=>{e.isScene&&(t=e)})),!t||t&&!t.isScene)return new Set;const n=new Set;return t.traverseVisible((e=>{e.isDirectionalLight&&e.castShadow&&n.add(e)})),n}pruneOldViews(e){for(const[t,n]of this.sharedState.viewLastUseFrame)if(!(e-n<600)){for(const[e,n]of this.sharedState.cameraToView)if(n===t){this.sharedState.cameraToView.delete(e);break}t.destroy(),this.sharedState.viewLastUseFrame.delete(t)}}updateViews(){const e=this.sharedState,t=new Set;if(this.renderer.shadowMap.enabled)for(const e of this.umbraScenes)for(const n of this.findLights(e))t.add(n);const n=this.dirVector,r=this.tempVector,a=Array.from(t).map((e=>(n.setFromMatrixPosition(e.target.matrixWorld),r.setFromMatrixPosition(e.matrixWorld),n.sub(r),[n.x,n.y,n.z])),t);this.pruneOldViews(this.renderer.info.render.frame);for(const[t,n]of e.cameraToView){const r=t;this.matrixWorldInverse.getInverse(r.matrixWorld),this.projScreenMatrix.multiplyMatrices(r.projectionMatrix,this.matrixWorldInverse),"umbraStreamingPosition"in r?this.cameraWorldPosition.copy(r.umbraStreamingPosition):r.getWorldPosition(this.cameraWorldPosition);let i=.5;"umbraQuality"in r&&(i=r.umbraQuality);const o=this.cameraWorldPosition;n.setCamera(this.projScreenMatrix.elements,[o.x,o.y,o.z],i*this.qualityFactor,a);let s=[];e.viewRenderables.has(n)?(s=e.viewRenderables.get(n),s.length=0):e.viewRenderables.set(n,s);const u=500;let l=[];do{l=n.getVisible(u),s.push(...l)}while(l.length===u)}}update(e=7){const t=0!==this.downloadLimit&&this.getStats().maxBytesDownloaded>=this.downloadLimit;if(t)this.oldState.downloadLimitReached||this.umbrajs.abortDownloads();else{const t=performance.now();this.runtime.update();const n=performance.now()-t;this.runtime.loadAssets(e-n),this.updateViews()}this.oldState.downloadLimitReached=t,this.memoryUsed/this.memoryLimit<.25&&this.adjustQuality(1.1)}createScene(e,t){if("string"!=typeof t)throw"object"==typeof t&&console.error("Connection with an {key, project, model} object is deprecated. Use a locator string instead."),new TypeError("expected a string argument");const n=new q(this.runtime,this.runtime.createScene(e,t),this.sharedState,this.renderer,this.features,(e=>this.umbraScenes.delete(e)));return this.umbraScenes.add(n),n}createScenePublic(e){if("string"!=typeof e)throw"object"==typeof e&&console.error("Connection with an {key, project, model} object is deprecated. Use a public link string instead."),new TypeError("expected a string argument");const t=new q(this.runtime,this.runtime.createScenePublic(e),this.sharedState,this.renderer,this.features,(e=>this.umbraScenes.delete(e)));return this.umbraScenes.add(t),t}createSceneLocal(e){const t=this.runtime.createSceneLocal(e),n=new q(this.runtime,t,this.sharedState,this.renderer,this.features,(e=>this.umbraScenes.delete(e)));return this.umbraScenes.add(n),n}createSceneWithURL(e){return this.createSceneLocal(e)}getStats(){return Object.assign(this.umbrajs.getStreamingInfo(),{textureMemoryUsed:this.textureMemoryUsed,meshMemoryUsed:this.meshMemoryUsed})}canFitInMemory(e){return this.memoryUsed+e<this.memoryLimit}adjustQuality(e){this.renderer.info.render.frame!=this.lastQualityLowerFrame&&(this.qualityFactor=Math.max(0,Math.min(1,this.qualityFactor*e)),this.lastQualityLowerFrame=this.renderer.info.render.frame)}makeTexture(e,n,r){const a=n.getArray().slice();let i;if(r.compressed){const n={width:e.width,height:e.height,data:a};i=new t.CompressedTexture([n],e.width,e.height)}else i=new t.DataTexture(a,e.width,e.height);return i.format=r.format,i.type=r.type,i.magFilter=t.LinearFilter,i.minFilter=t.LinearFilter,i.anisotropy=0,i}updateEvents(){const e=this.getStreamingProgress();this.oldState.progress!=e&&(this.onStreamingUpdate&&this.onStreamingUpdate(e),1===e&&this.onStreamingComplete&&this.onStreamingComplete()),this.oldState.progress=e}getStreamingProgress(){return this.runtime.getStreamingProgress()}dispose(){this.stopEventUpdate();for(const e of this.sharedState.cameraToView.values())e.destroy();this.umbraScenes.forEach((e=>e.dispose())),this.sharedState.cameraToView.clear(),this.umbraScenes.clear(),this.runtime.assets.forEach(((e,t)=>{"geometry"in e&&e.geometry.dispose(),"dispose"in e&&e.dispose()})),this.assetSizes.clear(),this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.runtime.destroy(),this.runtime=void 0,function(e){e.abortDownloads();const t=e;try{t.nativeModule._exit(0)}catch(e){if("ExitStatus"!==e.name)throw e}}(this.umbrajs)}}e.Loader=H,e.Scene=q,e.initWithThreeJS=function(e,t){if(!e)throw new TypeError('"renderer" should be of type THREE.WebGLRenderer');return W(t).then((t=>new X(t,e)))},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=umbrajs-three.amd.min.js.map
